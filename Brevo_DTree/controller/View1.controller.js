sap.ui.define(["sap/ui/core/mvc/Controller","Brevo/BrevoDtree/model/Service","Brevo/BrevoDtree/util/CustomerFormatter","Brevo/BrevoDtree/util/draw","Brevo/BrevoDtree/util/DrawPivotTable","sap/m/MessageBox","sap/ui/commons/TextView","sap/ui/table/Column","Brevo/BrevoDtree/util/Formatter"],function(e,t,a,i,s,n,r,o,l){"use strict";return e.extend("Brevo.BrevoDtree.controller.View1",{onInit:function(){var e=this;this.isOnNavBack=false;e.selectedColumnName=[];this.fileUploaded=false,this.createScenario=false,this.variantChange=false,this.hMode=true,this.hiddenNodes=[],this.editDataLevel2=[],this.expandTree=true,this.simulate=false,this.dragged=false,this.getEntityDataUrl;this.filterId=[],this.filterSelectedValues={},e.segmentArray=[],this.fileUpload,this.arrayVal,this.eventVal,this.mArray=[],this.dArray=[],this.originalsegmentModel,this.thresHolds=[],this.viewName,this.measureProperties,this.dimensionProperties,this.measureModel,this.segmentModel,this.dimensionModel,this.selectedVariant="Variant 1",this.scenarioInfo,this.varianceInfo,this.segnewData,this.segmentsSelected=[],this.segmentItems=[],this.segmentTree=false,this.impactSelected=false,this.ListId,this.ScenId,this.updateFlag;if(!e.FileDialog)e.FileDialog=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.ValueHelpForFiles",e);if(!e.valueHelpRequestForEntity)e.valueHelpRequestForEntity=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.ValueHelpForEntity",this);if(!e.DropDownPopUp)e.DropDownPopUp=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.PopUpForScenario",e);if(!e.ValueHelpForService)e.ValueHelpForService=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.ValueHelpForService",e);if(!e.ValueHelpForDataRecords)e.ValueHelpForDataRecords=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.ValueHelpForDataRecords",e);if(!this.valueHelpForAddnodes)this.valueHelpForAddnodes=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.AddNodes",e);if(!this.valueHelpForAddComments)this.valueHelpForAddComments=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.AddComments",e);if(!this.valueHelpForVariant)this.valueHelpForVariant=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.addVariant",e);if(!this.DialogForExcelUpdate)this.DialogForExcelUpdate=sap.ui.xmlfragment("Brevo.BrevoDtree.fragments.DialogForExcelUpdate",e);e.FileDialog.getContent()[0].addEventDelegate({onclick:function(){$("#"+e.FileDialog.getContent()[1].sId+"-fu").trigger("click")}});t.callService("viewsListModel","viewsListModel","FileUploader/Tables","",true,"",function(t,a){var i=sap.ui.getCore().getModel("viewsListModel");e.ValueHelpForDataRecords.setModel(i)});var a=sap.ui.getCore().getEventBus();a.subscribe("systemsetting","systemtreeData",function(t,a,i){if(i.key=="SystemDerived")e.sliderChangeFunction(i.nodedetails,i.nodedetails.value,true);else e.sliderChangeFunction(i.nodedetails,i.nodedetails.value,false)});var i="/Scenario.xsodata/Filter('DTREE')/ExistingScenSet?$format=json";this.initCustomFormat();this.getAllScenarioes();this.getAllSharedScenario()},onAfterRendering:function(){try{if(this.isOnNavBack){i.drawMeasureTree(this)}}catch(e){}},createScenarioForpanaReport:function(e){var a=this;var i=localStorage.getItem("targetMeasure");var s="ReportConfigSet("+e+")";t.callService("reportModel","reportModel",s,"report",true,"",function(e,i){var s=sap.ui.getCore().getModel("reportModel");var n=s.oData.d["RepConfig"];var r=JSON.parse(decodeURIComponent(escape(window.atob(n))));var o=[],l=[];if(r.measures.length<1){var d=r.columns;for(var g=0;g<d.length;g++){if(d[g].dataType=="measure"&&d[g].property!=localStorage.getItem("Input_Content")){o.push({Value:d[g].property})}else{l.push({Value:d[g].property})}}}var c={scenarioTitle:r.reportTitle,serviceURL:r.EntitySet,Entity:localStorage.getItem("targetMeasure"),EntitySet:"",measures:o,dimension:l,excelFileName:"excelFile",dataSource:"service"};var u={timeDimension:"",timePeriod:"",quarterInfo:"",varianceMeasure:"",MinDimension:"",minMeasure:""};a.ScenId=Math.round(Math.random()*1e6);a.ListId=Math.round(Math.random()*1e6);a.scenarioTitle=r.reportTitle;var h="/Scenarios";var m="Scenario Created Successfully";var v={ListId:a.ListId,ScenId:a.ScenId,ScenName:r.reportTitle,ScenConfig:btoa(unescape(encodeURIComponent(JSON.stringify(c)))),RoleFlag:"T",temp:0,Filter:"DTREE",VariantSettings:btoa(unescape(encodeURIComponent(JSON.stringify(u))))};t.callCreateService(h,JSON.stringify(v),false,"POST",function(e,i,s){if(i){a.getView().byId("scenarioName").setText(a.scenarioTitle);var n={VariantId:Math.round(Math.random()*1e6),VariantName:"Variant 1",ScenId:a.ScenId,SegmentTree:"",SegmentSelection:"",MeasureTree:"",HiddenNodes:"",Filter:"DTREE"};t.callCreateService("/Variants.xsjs",JSON.stringify(n),"","POST",function(e,t,i){localStorage.setItem("targetMeasure",null);a.panaviewData=true;a.selectedScenarioModel(a.ScenId)})}})})},initCustomFormat:function(){a.registerCustomFormat()},hanldeNextStep:function(){var e=this;var t=this.ValueHelpForService.getContent()[1].getSelectedKey();if(t==="general"){this.ValueHelpForService.getContent()[1].getItems()[2].setEnabled(true);this.ValueHelpForService.getContent()[1].setSelectedKey("data");if(this.updateFlag===true){this.ValueHelpForService.getButtons()[1].setVisible(true)}else{this.ValueHelpForService.getButtons()[0].setVisible(true)}}else{if(this.validateFields()){if(this.updateFlag===true){this.ValueHelpForService.getButtons()[0].setVisible(false);this.ValueHelpForService.getButtons()[1].setVisible(true)}else{this.ValueHelpForService.getButtons()[0].setVisible(true);this.ValueHelpForService.getButtons()[1].setVisible(false)}this.ValueHelpForService.getContent()[1].getItems()[4].setEnabled(true);this.ValueHelpForService.getContent()[1].setSelectedKey("variance");this.ValueHelpForService.getButtons()[2].setVisible(false)}}},removeFilterstyleclass:function(){for(var e=0;e<this.filterId.length;e++){sap.ui.getCore().byId(this.filterId[e]).removeStyleClass("customFilterSelectColor");this.filterId.splice(e,1)}},getAllScenarioes:function(){var e=this;t.callService("ScenarioListModel","ScenarioListModel","/Scenarios?$filter=temp%20eq%200","scenario",true,"",function(a,i){if(i){var s=sap.ui.getCore().getModel("ScenarioListModel");if(s.oData.d.results.length!=0){e.getView().byId("createtextId").setVisible(false);e.getView().byId("chartArea").setVisible(true);e.getView().byId("variantItems").setVisible(true);e.user=s.oData.d.results[0].CreatedBy;var n=window.localStorage.getItem("scenarioId");var r=!!e.getView().$().closest(".sapUiSizeCompact").length;try{if(a.mParameters.errorobject.statusCode==502||a.mParameters.errorobject.statusCode==500){var o=a.mParameters.errorobject.responseText;sap.m.MessageBox.error(o,{styleClass:r?"sapUiSizeCompact":""});e.getView().setBusy(false)}}catch(e){console.log(e)}e.DropDownPopUp.setModel(s);var l=localStorage.getItem("targetMeasure");if(window.location.hash.length>2&&l!=="null"){if(window.location.hash){var d=window.location.hash.split("#")[1].split("=")[1]}else{var d=746538}var g={cardid:d};t.callCreateService("TempScenario",JSON.stringify(g),true,"POST",function(t,a,i){if(a){e.selectedScenarioModel(d);e.ScenId=d}})}else if(s.oData.d.results.length!=0)if(n==null||n=="null"||n=="undefined")e.selectedScenarioModel(s.oData.d.results[0].ScenId);else e.selectedScenarioModel(n)}else{e.getView().byId("createtextId").setVisible(true);e.getView().byId("chartArea").setVisible(false);e.getView().byId("variantItems").setVisible(false);e.getView().byId("scenarioName").setText("Select a Scenario");e.getView().setBusy(false)}}else{window.location="../Login/index.html"}})},getAllSharedScenario:function(){var e=this},openReportList:function(e){this.DropDownPopUp.openBy(e.oSource)},UpdateScenario:function(e,a,i,s){var n=this;sap.m.MessageBox.warning("Do u want save the Scenario.?",{title:"Warning",initialFocus:sap.m.MessageBox.Action.NO,actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(r){if(r===sap.m.MessageBox.Action.NO){var o="ScenarioDelete.xsjs?ListId="+e+"";t.callDeleteService(o,"scenario",function(){t.callService("ScenarioListModel","ScenarioListModel","Scenario.xsodata/filter('DTREE')/SavedScenariosSet","scenario",true,"",function(e,t){var a=sap.ui.getCore().getModel("ScenarioListModel");n.DropDownPopUp.setModel(a);n.panaviewData=false})})}else{var l={ScenId:a,ScenName:i.scenarioTitle,ScenConfig:btoa(unescape(encodeURIComponent(JSON.stringify(i)))),RoleFlag:"",Filter:"DTREE",VariantSettings:btoa(unescape(encodeURIComponent(JSON.stringify(s))))};t.callCreateService("Scenario.xsjs?ListId="+e+"",JSON.stringify(l),false,"PUT",function(e,a,i){if(a){n.panaviewData=false;sap.m.MessageToast.show("Scenario saved successfully");t.callService("ScenarioListModel","ScenarioListModel","Scenario.xsodata/filter('DTREE')/SavedScenariosSet","scenario",true,"",function(e,t){n.DropDownPopUp.setModel(selectedFileModel)})}})}}})},onScenarioSelection:function(e){var t=this;this.hMode=true,this.expandTree=true,this.variantChange=false;if(t.panaviewData==true){t.UpdateScenario(t.ListId,t.ScenId,t.selectedscenarioInfo,t.varianceInfo)}var a=e.oSource.getSelectedItem().getBindingContext().getObject();this.getView().setBusy(true);e.oSource.removeSelections();window.localStorage.setItem("scenarioId",a.ScenId);this.getView().byId("treeStyle").setTooltip("Collapse second level child nodes");this.getView().byId("treeStyle").setIcon("sap-icon://collapse");this.getView().byId("segments").setVisible(true);this.getView().byId("vdt").setWidth("100%");this.onDeletePress();this.onRefreshView();this.getView().byId("vdtVisualise").setVisible(false);if(a.Existing){this.onExistingScenarioPress("selection")}else{var i=new sap.ui.model.json.JSONModel("model/icontabModel.json");t.getView().byId("variantItems").setModel(i);if(t.getView().byId("variantItems").getModel().oData.length==1){t.getView().byId("variantDelId").setVisible(false)}else{t.getView().byId("variantDelId").setVisible(true)}i.attachRequestCompleted(function(){t.variantObject=i.oData[0]});t.getView().byId("variantItems").updateBindings(true);this.selectedVariant="Variant 1";this.selectedScenarioModel(a.ScenId)}this.DropDownPopUp.close()},onExistingScenarioPress:function(e,a){var i=this;var s=e;this.getView().byId("segments").setText("Segments : All");if(e=="scenario"){this.existingObject=a}else if(s!="selection"){this.existingObject=e.oSource.getSelectedItem().getBindingContext().getObject();e.oSource.removeSelections();$("svg")[0].style.width=window.innerWidth}this.Scenario=this.existingObject;this.Existing=true,this.hMode=true,this.expandTree=true,this.variantChange=false;this.getView().byId("vdt").setWidth("100%");this.segmentsSelected=[],this.segmentItems=[],this.filterId=[],this.segmentTree=false;if(e.sId=="select"){i.dialog=new sap.m.Dialog({title:"Confirm",type:"Message",content:[new sap.m.Label({text:"Are you sure you want to create shared scenario?",labelFor:"Scenario Name"}),new sap.m.Input({value:e.mParameters.listItem.getTitle(),width:"100%"}),new sap.m.Label({text:"Share: "}),new sap.m.CheckBox({})],beginButton:new sap.m.Button({text:"Save",press:function(){i.busy=new sap.m.BusyDialog;i.busy.open();var e="Variant.xsjs?ScenId="+i.existingObject.ScenId+"&Shared=true&$format=json";t.callService("Model1","Model1",e,"scenario",true,"",function(e){i.settingmodel=sap.ui.getCore().getModel("Model1").oData;var a="POST";i.ScenId=Math.round(Math.random()*1e6);i.ListId=Math.round(Math.random()*1e6);i.scenariotitle=i.dialog.getContent()[1].getValue();var s;if(i.dialog.getContent()[3].getSelected()==true){s="X"}else{s=""}var n="Scenario Created Successfully";var r={ListId:i.ListId,ScenId:i.ScenId,ScenName:i.scenariotitle,ScenConfig:i.settingmodel[0].ScenConfig,RoleFlag:s,temp:0,Filter:"DTREE",VariantSettings:i.settingmodel[0].VariantSettings};t.callCreateService("Scenario.xsjs",JSON.stringify(r),false,a,function(e,a,s){if(a){i.getView().byId("scenarioName").setText(i.scenariotitle);var n=i.settingmodel[0].Variants;var r=0;for(var o=0;o<n.length;o++){var l={VariantId:Math.round(Math.random()*1e6),VariantName:n[o].VariantName,ScenId:i.ScenId,SegmentTree:n[o].SegmentTree,SegmentSelection:n[o].SegmentSelection,MeasureTree:n[o].MeasureTree,HiddenNodes:n[o].HiddenNodes,Filter:"DTREE"};t.callCreateService("Variants.xsjs",JSON.stringify(l),"","POST",function(e,t,a){console.log("posted");r++;if(r==n.length){i.hMode=true;i.resetFields();i.createScenario=true;window.localStorage.setItem("scenarioId",i.ScenId);i.getAllScenarioes();i.dialog.close();i.busy.close()}})}}})});i.dialog.close()}}),endButton:new sap.m.Button({text:"Cancel",press:function(){i.dialog.close()}})});i.dialog.open()}},onEditSegmentsPress:function(){var e=this;if(e.getView().byId("dataStyle").getIcon()==="sap-icon://table-view"){e.segmentsSelected=[],e.segmentItems=[];e.segmentTree=true;$("svg")[0].style.width=window.innerWidth;e.getView().byId("vdt").setWidth("100%");e.onDeletePress();if(e.variantObject.SegmentTree==null||e.variantObject.SegmentTree.length==0){e.dailog.open();e.callSegmentService()}else i.drawSegmentTree(e);e.getView().byId("forecasting").setType("Transparent");e.getView().byId("floaterSettingsVisibility").setVisible(false);e.getView().byId("vdtVisualise").setVisible(true)}},selectedScenarioModel:function(e){var a=this;this.isOnNavBack=true;this.Existing=false;this.onDeletePress();this.onRefreshView();var i="/Scenarios?$expand=Variants&$filter=ScenId eq "+parseInt(e)+"&$format=json";t.callService("SelectedScenarioModel","SelectedScenarioModel",i,"scenario",true,"",function(t){a.getView().setBusy(false);try{if(!t.mParameters.success){var i=t.mParameters.errorobject.responseText;sap.m.MessageBox.error(i);a.getView().setBusy(false)}else{var s=sap.ui.getCore().getModel("SelectedScenarioModel").oData.d.results[0];a.getView().byId("scenarioName").setText(s.ScenName);a.scenarioInfo=JSON.parse(decodeURIComponent(escape(window.atob(s.ScenConfig))));a.varianceInfo=JSON.parse(decodeURIComponent(escape(window.atob(s.VariantSettings))));var n=new sap.ui.model.json.JSONModel(s.Variants);a.getView().byId("variantItems").setModel(n);if(a.getView().byId("variantItems").getModel().oData.length==1){a.getView().byId("variantDelId").setVisible(false)}else{a.getView().byId("variantDelId").setVisible(true)}a.variantObject=n.oData[0];if(n.oData[0].SegmentSelection.includes("'")){a.getView().byId("segments").setText("Segments : "+n.oData[0].SegmentSelection)}else{a.getView().byId("segments").setText("Segments : All")}if(a.variantObject.HiddenNodes){a.hiddenNodes=JSON.parse(a.variantObject.HiddenNodes)}else{a.hiddenNodes=[]}}a.getView().byId("customFloatEditBtn2").setIcon("sap-icon://horizontal-grip");a.getView().byId("customFloatEditBtn2").setTooltip("Horizontal Representation");a.hMode=true,a.filterId=[];a.getView().byId("dataSource").setText(a.scenarioInfo.serviceURL);a.getView().byId("entity").setText(a.scenarioInfo.Entity);a.dragged=false;a.commentServices(e);a.loadDataToTreeForScenario(a.scenarioInfo,a.varianceInfo)}catch(e){a.getView().setBusy(false)}})},onAddPress:function(){var e=this;this.DropDownPopUp.close();this.updateFlag=false;this.mArray=[];this.dArray=[];var t=e.ValueHelpForService.getContent()[1];if(t.getItems()[0].getContent()[0].getContent()[3].getSelected()===true){t.getItems()[0].getContent()[0].getContent()[3].setSelected(false)}t.setSelectedKey(t.getItems()[0].getKey());e.ValueHelpForService.getButtons()[2].setVisible(true);e.ValueHelpForService.getButtons()[1].setVisible(false);e.ValueHelpForService.getButtons()[2].setEnabled(false);e.ValueHelpForService.getButtons()[0].setVisible(false);t.getItems()[2].setEnabled(false);t.getItems()[4].setEnabled(false);t.getItems()[0].setEnabled(true);this.ValueHelpForService.open()},onScenarioSearch:function(e){var t=[];var a=e.getSource().getValue();var i=this.DropDownPopUp.getContent()[0];var s=i.getBinding("items");if(a&&a.length>0){var n=new sap.ui.model.Filter("ScenName",sap.ui.model.FilterOperator.Contains,a);t.push(n);s.filter(new sap.ui.model.Filter(t,false))}else{s.filter([])}},handleServiceDialogClose:function(){this.resetFields();this.ValueHelpForService.close();this.getView().setBusy(false)},valueHelpDataRecordsClose:function(e){e.oSource.oParent.getContent()[0].setValue();this.ValueHelpForDataRecords.close()},valueHelpCloseButton:function(){this.valueHelpRequestForEntity.close()},valueHelpFileCloseButton:function(){this.FileDialog.close()},onValueHelpRequestForFiles:function(){var e=this;e.FileDialog.open()},onValueHelpRequestForDataRecords:function(){var e=this;this.ValueHelpForDataRecords.getContent()[1].getBinding("items").filter([]);e.ValueHelpForDataRecords.open()},onScenarioDelete:function(e){var a=this;var i=e.oSource.oParent.getBindingContext().getObject();sap.m.MessageBox.confirm("Are you sure you want to delete the "+i.ScenName+" scenario?",{onClose:function(e){if(e==="OK"){var s=window.localStorage.getItem("scenarioId");a.getView().setBusy(true);var n="Scenarios("+i.ScenId+")";t.callDeleteService(n,"scenario",function(){var e="OVPPageConfig("+i.ScenId+")";t.callDeleteService(e,"scenario",function(){sap.m.MessageToast.show("Scenario Deleted successfully");if(i.ScenId===parseInt(s))window.localStorage.setItem("scenarioId",null);a.onRefreshView();a.createScenario=false;a.getAllScenarioes()})})}}})},editModeExcelTable:function(e){if(e.oSource.getIcon()=="sap-icon://edit"){e.oSource.oParent.oParent.setMode("Delete");e.oSource.setIcon("sap-icon://accept")}else{e.oSource.oParent.oParent.setMode("SingleSelectMaster");e.oSource.setIcon("sap-icon://edit")}},onExistingFileSelected:function(e,a,i){var s=this;var n=this.ValueHelpForService.getContent()[1];this.FileDialog.setBusy(true);this.fileUploaded=true;if(this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1].getColumns().length>0){this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1].removeAllColumns();this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1].getModel().setData(null)}this.mArray=[];this.dArray=[];if(s.updateFlag===true){var r=a.excelFileName;var o="/FileUploader.xsjs?FileName="+r}else if(s.fileUpload===true){r=i.oData.name.split(".")[0];o="/FileUploader.xsjs?FileName="+r}else{var l=e.getParameters().listItem.getBindingContext().getModel().getObject(e.getParameters().listItem.getBindingContext().sPath);r=l.FileName;o="/FileUploader.xsjs?FileName="+r;var d=e.oSource}t.callService("FileDataModel","FileUpload",o,true,"true","",function(e){try{s.FileDialog.setBusy(false);var t=sap.ui.getCore().getModel("FileDataModel");var i=new sap.ui.model.json.JSONModel;i.setData({name:r,data:t.oData.results});sap.ui.getCore().setModel(i,"parsedDataFromExcelModel");var o=[];for(var l in t.oData.results[0]){o.push({property:l,value:l,name:l})}var g=new sap.ui.model.json.JSONModel;g.setData(o);s.fileUploaded=true;s.FileDialog.close();n.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].setValueState("None");s.fileUploaded=true;n.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].setValue();n.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[7].setValue(r);n.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[7].setShowValueHelp(false);n.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0].removeAllItems();n.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1].removeAllItems();var c=n.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0];c.bindItems({path:"/",template:new sap.m.StandardListItem({title:"{value}"})});c.setModel(g);var u=n.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1];u.bindItems({path:"/",template:new sap.m.StandardListItem({title:"{value}"})});u.setModel(g);if(s.updateFlag===false){d.removeSelections()}s.createTabledata(a)}catch(e){var h=!!this.getView().$().closest(".sapUiSizeCompact").length;sap.m.MessageBox.error("Failed to load data for selected scenario",{styleClass:h?"sapUiSizeCompact":""})}})},onFileUploaderOnSelectChanged:function(e){var t=this;var a=e.getParameters().files;var i=a[0];var s=i.name;t.FileDialog.getContent()[0].getItems()[0].setText(s);handleDrop(a,t.onFileRead,t)},onFileRead:function(e,t,a){var i=new sap.ui.model.json.JSONModel;i.setData({name:a.FileDialog.getContent()[0].getItems()[0].getText(),data:t});sap.ui.getCore().setModel(i,"parsedDataFromExcelModel")},valueHelpCloseButtonForExcelDisplay:function(){this.DialogForExcelUpdate.close()},displayExcelTableForFileUpdate:function(e,t){var a=this;var i=new sap.ui.model.json.JSONModel(t);i.setData({fileName:e,COLUMN_DET:t});this.DialogForExcelUpdate.setModel(i);this.DialogForExcelUpdate.open()},handleFileUpdate:function(e){var a=this;var i=this.DialogForExcelUpdate.getModel();var s="PUT";a.ValueHelpForService.setBusy(true);t.callCreateService("FileUploader",JSON.stringify({fileName:i.oData.fileName,COLUMN_DET:i.oData.COLUMN_DET}),true,s,function(e,s){if(s){a.DialogForExcelUpdate.close();t.callService("viewsListModel","viewsListModel","FileUploader/Tables","",true,"",function(e,t){var s=sap.ui.getCore().getModel("viewsListModel");a.ValueHelpForDataRecords.setModel(s);var n=a.ValueHelpForDataRecords.getContent()[1];n.getItems().forEach(function(e){if(e.getBindingContext().getObject().FileName==i.oData.fileName){e.firePress();sap.m.MessageToast.show("File Updated successfully");a.ValueHelpForService.setBusy(false)}})})}else{a.DialogForExcelUpdate.close();sap.m.MessageToast.show("File Update failed")}})},handleExistingFileUpdate:function(e){var t=e.getSource().getBindingContext().getObject();var a=t.COLUMN_DET;var i=t.FileName;this.displayExcelTableForFileUpdate(i,a)},valueHelpUploadButton:function(e){var a=this;var i="POST";var s=sap.ui.getCore().getModel("parsedDataFromExcelModel");var n=Math.round(Math.random()*1e6)+"";s.oData.id=n;a.ValueHelpForService.setBusy(true);t.callCreateService("FileUploader",JSON.stringify({fileName:s.oData.name.split(".")[0],data:s.oData.data}),true,i,function(e,i){if(i){a.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[1].setValue();var s=JSON.parse(e).columnData;var n=a.FileDialog.getContent()[0].getItems()[0].getText().split(".")[0];t.callService("viewsListModel","viewsListModel","FileUploader/Tables","",true,"",function(e,t){var i=sap.ui.getCore().getModel("viewsListModel");a.ValueHelpForDataRecords.setModel(i);var r=a.ValueHelpForDataRecords.getContent()[1];r.getItems().forEach(function(e){if(e.getBindingContext().getObject().FileName==n){a.ValueHelpForService.setBusy(false);sap.m.MessageToast.show("File Uploaded successfully");e.firePress();a.displayExcelTableForFileUpdate(n,s)}})})}else{try{var r=JSON.parse(e).message}catch(e){}var o;if(r=="Access Denied")o="Access Denied.File Already exists";else o="File Upload failed";a.ValueHelpForService.setBusy(false);sap.m.MessageToast.show(o)}})},onServiceUrlSelect:function(e){var t;if(typeof e==="object")t=e.getSource().getTitle();else t=e;e.oSource.oParent.oParent.getContent()[0].setValue();var a=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent();a[5].setValue(t);this.viewName=t;a[5].setValueState("Success");this.ValueHelpForDataRecords.close();this.fileUploaded=false;var i=new sap.ui.model.json.JSONModel(e.getSource().getBindingContext().getObject());sap.ui.getCore().setModel(i,"msrsanddimModel");this.onServiceUrlChanged()},onServiceUrlChanged:function(e){var t=this;var a=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent();var i=a[5].getValue().trim();var s=sap.ui.getCore().getModel("msrsanddimModel");t.setMeasuresAndDimensionsForEnity(s,e)},onValueHelpRequestForEntity:function(e){this.valueHelpRequestForEntity.open()},valueHelpItemSelectionEntity:function(e){var t;if(typeof e==="object")t=e.getSource().getTitle();else t=e;this.targetValue=t;var a=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems();a[0].getContent()[7].setValue(t);var i=this.ValueHelpForService.getContent()[1];var s=i.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0];if(s.getSelectedItems().length>0){for(var n=0;n<s.getSelectedItems().length;n++){if(s.getSelectedItems()[n].getTitle()==a[0].getContent()[7].getValue()){s.getSelectedItems()[n].setSelected(false)}}}this.valueHelpRequestForEntity.close()},loadDataToModelForServiceUrl:function(e,t){var a=this;var i=this.newUrl;this.newUrl.replace("Express/","");var s=this.ValueHelpForService.getContent()[1];var n=s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[7].getValue().trim();if(i.length>0&&n.length>0){var r=this.oDataModel.getServiceMetadata();var o=r.dataServices.schema.length;if(o>=1){for(var l=o-1;l>=0;l--){var d=r.dataServices.schema[l].entityContainer;var g=d[0].entitySet;for(var c=0;c<g.length;c++){if(g[c].entityType.endsWith(n)){this.entitySetRequired=g[c].name;this.getEntityDataUrl=this.newUrl+"/"+this.entitySetRequired+"?$format=json&$top=5";this.getEntityDataUrl.trim();break}}break}}if(o==1){var d=r.dataServices.schema[0].entityContainer;var g=d[0].entitySet;for(var c=0;c<g.length;c++){if(g[c].entityType.endsWith(n)){this.entitySetRequired=g[c].name;this.getEntityDataUrl=this.newUrl+"/"+this.entitySetRequired+"?$format=json&$top=5";this.getEntityDataUrl.trim();break}}}this.getView().setBusy(true);this.entitySetDataModel=new sap.ui.model.json.JSONModel(this.getEntityDataUrl,{bAsync:false});this.entitySetDataModel.attachRequestCompleted(function(e){e.oSource.mEventRegistry=[];a.getView().setBusy(false);if(a.updateFlag===true){a.createTabledata(t)}});this.setMeasuresAndDimensionsForEnity(n)}else{var u="Enter a Service URL";sap.m.MessageToast.show(u)}},setMeasuresAndDimensionsForEnity:function(e,t){var a=this;this.timedimensionmodel=new sap.ui.model.json.JSONModel([]);if(e==undefined)e=new sap.ui.model.json.JSONModel(t);if(e.getData().COLUMN_DET.length>0){for(var i=0;i<e.getData().COLUMN_DET.length;i++){try{if(e.getData().COLUMN_DET[i].DATATYPE=="DATE"||e.getData().COLUMN_DET[i].DATATYPE=="Date"){var s={Value:e.getData().COLUMN_DET[i].COLUMN_NAME};var n=this.timedimensionmodel.getData();n.push(s)}}catch(e){}}}var r=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0];r.bindItems({path:"/MEASURES",template:new sap.m.StandardListItem({title:"{}"})});var o=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1];o.bindItems({path:"/DIMENSIONS",template:new sap.m.StandardListItem({title:"{}"})});this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[1].setModel(e);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].setModel(this.timedimensionmodel);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[2].setSelectedKey();this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[4].setSelectedKey();this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[6].setMin(0);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[6].setMax(1);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[6].setStep(.1);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[6].setValue(.5);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[6].setEnableTickmarks(true);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[8].setMin(-10);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[8].setMax(10);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[8].setStep(2);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[8].setValue(0);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[8].setEnableTickmarks(true);this.valueHelpRequestForEntity.setModel(e);if(this.updateFlag===false){var l=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1];l.removeAllColumns();l.setModel(new sap.ui.model.json.JSONModel([]));var d=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems();d[0].getContent()[7].setValue();this.mArray=[];this.dArray=[];this.prop=[]}else{this.createTabledata(t);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[2].setSelectedKey(a.editvarianceInfo.timeDimension);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[4].setSelectedKey(a.editvarianceInfo.timePeriod);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[6].setValue(a.editvarianceInfo.MinDimension);this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()[8].setValue(a.editvarianceInfo.minMeasure)}this.getView().setBusy(false)},handleMeasureSelections:function(e){var t=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems();if(t[0].getContent()[7].getValue()===""){sap.m.MessageToast.show("Please select target measure");e.getParameters("listItem").listItem.setSelected(false)}else if(t[0].getContent()[7].getValue()==e.getParameters("listItem").listItem.getTitle()){e.getParameters("listItem").listItem.setSelected(false);sap.m.MessageToast.show("Measure is selected as a target measure")}else{var a=e.getParameters("listItem").listItem.getTitle();this.eventVal=e.getParameters("listItem").listItem;this.arrayVal=true;var i=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1];if(this.mArray.indexOf(a)===-1){this.mArray.push(a);this.batchCall()}else{this.mArray.splice(this.mArray.indexOf(a),1);if(this.mArray.length===0&&this.dArray.length>0){i.removeColumn(i.getColumns().length-1)}else if(this.mArray.length===0){i.removeAllColumns();i.getModel().setData(null)}else{this.batchCall()}}}},handleDimensionSelections:function(e){this.eventVal=e.getParameters("listItem").listItem;this.arrayVal=false;if(this.fileUploaded===true){if(this.mArray.length===0){sap.m.MessageBox.error("Please select measures before selecting dimension");this.eventVal.setSelected(false)}else{this.dimensionsSelection(e)}}else{this.dimensionsSelection(e)}},dimensionsSelection:function(e){var t=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems();if(t[0].getContent()[7].getValue()===""){sap.m.MessageToast.show("Please select target measure");e.getParameters("listItem").listItem.setSelected(false)}else{var a=e.getParameters("listItem").listItem.getTitle();var i=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1];if(this.dArray.indexOf(a)===-1){this.dArray.push(a);this.batchCall()}else{this.dArray.splice(this.dArray.indexOf(a),1);this.batchCall()}}},batchCall:function(){var e=this;var t=this.dArray.concat(this.mArray);if(t.join()===""){var a=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1];a.removeAllColumns();a.getModel().setData(null)}else{if(this.fileUploaded===true){e.fileuploadmeasuresanddimensions(t,sap.ui.getCore().getModel("parsedDataFromExcelModel").oData.name)}else{e.fileuploadmeasuresanddimensions(t)}}},fileuploadmeasuresanddimensions:function(e,a){var i=this;var s=this.ValueHelpForService.getContent()[1];if(i.updateFlag===true){i.viewName=s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].getValue()}if(this.fileUploaded===false){var n=s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].getValue();var r="getData?fileName="+this.viewName;var o="true";if(this.mArray.length>0&&this.dArray.length===0){r="getData?aggregation=true&fileName="+this.viewName+"&$select="+this.mArray.join()}else if(this.mArray.length===0&&this.dArray.length>0){r="getData?aggregation=true&fileName="+this.viewName+"&$select="+this.dArray.join()}else{r="getData?aggregation=true&fileName="+this.viewName+"&$select="+this.mArray.join()+","+this.dArray.join()}}else{o="true";if(this.mArray.length>0&&this.dArray.length===0){r="getData?aggregation=true&fileName="+this.viewName+"&$select="+this.mArray.join()}else if(this.mArray.length===0&&this.dArray.length>0){r="getData?aggregation=true&fileName="+this.viewName+"&$select="+this.dArray.join()}else{r="getData?aggregation=true&fileName="+this.viewName+"&$select="+this.mArray.join()+","+this.dArray.join()}}t.callService("FileSelectedModel","FileSelectedModel",r,"IMS",true,n,function(t){if(typeof t.oSource.oData==="object"){var a=sap.ui.getCore().getModel("FileSelectedModel");if(i.arrayVal===false&&i.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1].getSelectedItems().length===0){i.createTable(e,a.oData[0])}else if(i.arrayVal===true&&i.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1].getSelectedItems().length>=1){i.createTable(e,a.oData[1])}else if(i.arrayVal===true){i.createTable(e,a.oData)}else{i.createTable(e,a.oData)}}else{sap.m.MessageBox.error("Selected value is not valid, please select other");i.eventVal.setSelected(false);if(i.arrayVal===true){for(var s=0;s<i.mArray.length;s++){if(i.eventVal.getTitle()===i.mArray[s]){i.mArray.splice(i.mArray.indexOf(i.mArray[s]),1)}}}else{for(var n=0;n<i.dArray.length;n++){if(i.eventVal.getTitle()===i.dArray[n]){i.dArray.splice(i.dArray.indexOf(i.dArray[n]),1)}}}}})},createTable:function(e,t){var a=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1];a.removeAllColumns();if(this.fileUploaded===true){if(t.length>1){var i=Object.assign({},t[0],t[1],t[2])}else{i=t}}else{i=t}for(var s=0;s<e.length;s++){a.addColumn(new o({width:"7rem",label:new sap.m.Label({text:e[s]}),template:new r({text:"{"+e[s]+"}"})}))}a.setModel(new sap.ui.model.json.JSONModel(i));this.segmentTable=i;a.bindRows("/");if(this.arrayVal===false&&this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1].getSelectedItems().length===0){a.setModel(new sap.ui.model.json.JSONModel([i]))}else if(this.arrayVal===true&&this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1].getSelectedItems().length>=1){a.setModel(new sap.ui.model.json.JSONModel(i))}else if(this.arrayVal===true){a.setModel(new sap.ui.model.json.JSONModel([i]))}else{a.setModel(new sap.ui.model.json.JSONModel(i))}a.bindRows("/");this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1].setBusy(false)},validateFields:function(){var e=this.ValueHelpForService.getContent()[1];var t=e.getItems()[0].getContent()[0].getContent()[1].getValue();var a=e.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].getValue();var i=e.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[7].getValue();var s=e.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0].getSelectedItems();var n=e.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1].getSelectedItems();if(t.length<=0)sap.m.MessageToast.show("Please enter the scenario name");else if(a.length<=0)sap.m.MessageToast.show("Please upload excel or choose any Data Source");else if(i.length<=0)sap.m.MessageToast.show("Please select Target Measure");else if(s.length<=0)sap.m.MessageToast.show("Please choose atleast one measure");else if(n.length<=1)sap.m.MessageToast.show("Please choose atleast two dimensions");else return true},handleCreateScenario:function(){var e=this;var a=this;var i=this.validateFields();var s=this.ValueHelpForService.getContent()[1];var n=s.getItems()[0].getContent()[0].getContent()[1].getValue();var r=s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].getValue();var o=s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[7].getValue();var l=s.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0].getSelectedItems();var d=s.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1].getSelectedItems();var g=a.variantAnalysisConfig("scenario");if(e.ValueHelpForService.getButtons()[1].getVisible()===true&&this.fileUploaded===true){this.updateFlag=true}var c=sap.ui.getCore().getModel("ScenarioListModel");var u=false;if(this.updateFlag!=true&&c.oData.d.results.length>0){for(var h=0;h<c.oData.d.results.length;h++){if(c.oData.d.results[h].ScenName==n){u=true;sap.m.MessageToast.show("scenario with "+n+" exist please change the scenario Title");break}else{u=false}}}if(i&&u==false){var m=[],v=[],f;if(this.fileUploaded)f="file";else f="service";for(var p=0;p<l.length;p++)m.push(s.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0].getSelectedItems()[p].getBindingContext().getObject());for(var p=0;p<d.length;p++)v.push(s.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1].getSelectedItems()[p].getBindingContext().getObject());var I={scenarioTitle:n,serviceURL:r,Entity:o,EntitySet:this.entitySetRequired,measures:m,dimension:v,excelFileName:"excelFile",dataSource:f};var S=s.getItems()[0].getContent()[0].getContent()[3].getSelected();if(S)var V="X";else V="";if(this.updateFlag===true){var b="PUT";var y="/Scenarios("+this.ScenId+")";var C="OVPPageConfig("+this.ScenId+")";var w="Scenario Updated Successfully";var M={ScenId:this.ScenId,ScenName:n,ScenConfig:btoa(unescape(encodeURIComponent(JSON.stringify(I)))),RoleFlag:V,Filter:"DTREE",temp:0,VariantSettings:btoa(unescape(encodeURIComponent(JSON.stringify(g))))};var D={Page_Id:this.ScenId,PageTitle:n,TypeOfPage:"D",RoleFlag:V}}else{b="POST";this.ScenId=Math.round(Math.random()*1e6);this.ListId=Math.round(Math.random()*1e6);y="/Scenarios";C="OVPPageConfig";w="Scenario Created Successfully";var M={ListId:this.ListId,ScenId:this.ScenId,Page_Id:this.ScenId,ScenName:n,temp:0,ScenConfig:btoa(unescape(encodeURIComponent(JSON.stringify(I)))),RoleFlag:V,Filter:"DTREE",VariantSettings:btoa(unescape(encodeURIComponent(JSON.stringify(g))))};var D={Page_Id:this.ScenId,PageTitle:n,TypeOfPage:"D",RoleFlag:V}}a.ValueHelpForService.close();a.getView().setBusy(true);t.callCreateService(C,JSON.stringify(D),"scenario",b,function(i,s,r){if(s){t.callCreateService(y,JSON.stringify(M),"scenario",b,function(t,i,s){if(i){window.localStorage.setItem("scenarioId",a.ScenId);a.getView().byId("scenarioName").setText(n);if(b=="POST"){e.createVariant(a.ScenId)}else{sap.m.MessageToast.show(w);a.getView().byId("segments").setText("Segments : All");a.hMode=true;a.resetFields();a.createScenario=false;a.getAllScenarioes()}}else{sap.m.MessageToast.show("Unable to create scenario, try again later.")}})}})}},createVariant:function(e){var a=this;var i="Scenario Created Successfully";var s={VariantId:Math.round(Math.random()*1e6),VariantName:"Variant 1",ScenId:e,Page_Id:e,SegmentTree:"",SegmentSelection:"",MeasureTree:"",HiddenNodes:"",Filter:"DTREE"};t.callCreateService("/Variants",JSON.stringify(s),"scenario","POST",function(e,t,n){sap.m.MessageToast.show(i);a.variantObject=s;a.selectedVariant="Variant 1";a.getView().byId("segments").setVisible(true);a.getView().byId("segments").setText("Segments : All");a.hMode=true;a.resetFields();a.createScenario=true;a.getAllScenarioes()})},variantAnalysisConfig:function(e){var t;if(e==="scenario"){var a=sap.ui.getCore().getEventBus();var i=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].getValue();if(i==undefined){i=this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[3].getValue()}t=this.ValueHelpForService.getContent()[1].getItems()[4].getContent()[0].getContent()}else t=this.variancePopUp.getContent()[0].getContent()[0].getContent()[0].getContent();return{timeDimension:t[2].getSelectedKey(),timePeriod:t[4].getSelectedKey(),MinDimension:t[6].getValue(),minMeasure:t[8].getValue()}},loadDataToTreeForScenario:function(e,a){try{this.getView().byId("floatSlider").setValue(0);this.measureProperties=e.measures;this.dimensionProperties=e.dimension;this.selectedscenarioInfo=e;this.selectedvarianceInfo=a;var s=this,n="",r="";for(var o=0;o<this.measureProperties.length;o++){if(o==0)n=this.measureProperties[o];else n+=","+this.measureProperties[o]}for(var l=0;l<this.dimensionProperties.length;l++){if(l===0)r=this.dimensionProperties[l];else r+=","+this.dimensionProperties[l]}var d=n+","+r;s.selectedmeasureandDimensions=d;if(a.timeDimension.length>0){s.SelectedUrl=e.serviceURL+"&select="+d+"&target="+e.Entity+"&variantID="+s.variantObject.VariantId+"&year="+a.timePeriod+"&contribution="+a.minMeasure+"&time="+a.timeDimension}else{s.SelectedUrl=e.serviceURL+"&select="+d+"&target="+e.Entity+"&variantID="+s.variantObject.VariantId+"&contribution="+a.minMeasure}s.dailog=new sap.m.BusyDialog;s.time=a.timeDimension;if(s.variantObject.MeasureTree.length==0){s.loadeddata="Ml";s.dailog.open();s.measuretreeurl="MeasureTree?view="+s.SelectedUrl;t.callService("treedataModel","treedataModel",s.measuretreeurl,"IMS",true,"",function(e,t){var a=s.constructMeasureTreeJson(sap.ui.getCore().getModel("treedataModel").oData,null,null);s.OmeasureModel=a;s.variantObject.MeasureTree=JSON.stringify(s.OmeasureModel.oData,function(e,t){if(e!="parent")return t});s.dailog.close();s.getView().byId("reportContainerParent").setVisible(false);s.segmentTree=false;i.drawMeasureTree(s)})}else{if(JSON.parse(s.variantObject.MeasureTree).nodecomments==undefined){var g=s.constructMeasureTreeJson(JSON.parse(s.variantObject.MeasureTree),null,null);s.OmeasureModel=g;s.variantObject.MeasureTree=JSON.stringify(s.OmeasureModel.oData,function(e,t){if(e!="parent")return t})}s.getView().byId("reportContainerParent").setVisible(false);i.drawMeasureTree(s);s.segmentTree=false}}catch(e){console.log(e)}},callSegmentService:function(){var e=this;var a="SegmentTree?view="+e.SelectedUrl;t.callService("SegmenttreedataModel","SegmenttreedataModel",a,"IMS",true,"",function(t,a){if(t.oSource.oData.root!=undefined&&t.oSource.oData.root.children.length!=0){var s=sap.ui.getCore().getModel("SegmenttreedataModel").oData.root;s.children.forEach(function(e){n(e)});function n(e){if(e.hasOwnProperty("children")){if(e["children"].length>0){if(e["children"][0].length==undefined)return;else e["children"]=e["children"][0];for(var t=0;t<e["children"].length;t++){n(e["children"][t])}}else{return}}else{return}}var r=e.constructSegmentTreeJson(s);e.OsegmentModel=new sap.ui.model.json.JSONModel(r);e.variantObject.SegmentTree=JSON.stringify(e.OsegmentModel.oData,function(e,t){if(e!="parent")return t});i.drawSegmentTree(e);e.dailog.close()}else{e.dailog.close()}})},constructMeasureTreeJson:function(e,t,a){var i,s;if(t!=null){i=t}else{i=""}if(a!=null){s=a}else{s=""}var n=this;var r={id:"NODE1",title:"Measure",dtitle:e.name,name:e.name,value:e.value,value_org:e.value,value_copy:e.value,difference:e.value-e.value,intercept:e.intercept,children:"",isHidden:false,isLocked:false,selected:false,nodecomments:[],year:i,quater:s};if(e.children.length==0)n.dailog.close();else e.children.forEach(function(e){o(e)});function o(e){if(e.hasOwnProperty("name")){if(e.hasOwnProperty("co_val")){if(e["co_val"].toString().indexOf("e")>-1){t(e["co_val"]);function t(e){var[t,a,i]=e.toString().split(/e|\./);n.co_val=+i<=0?"0."+"0".repeat(Math.abs(i)-1)+t+a:t+(+i>=a.length?a+"0".repeat(+i-a.length):a.slice(0,+i)+"."+a.slice(+i))}e["title"]=e["name"];e["dtitle"]=e["name"];e["value"]=e["value"];e["value_org"]=e["value"];e["value_copy"]=e["value"];e["difference"]=e["value_org"]-e["value"];e["co_val"]=n.co_val.replace("-","");e["isHidden"]=false;e["isLocked"]=false;e["selected"]=false;e["nodecomments"]=[]}else{e["title"]=e["name"];e["dtitle"]=e["name"];e["value"]=e["value"];e["value_org"]=e["value"];e["value_copy"]=e["value"];e["difference"]=e["value_org"]-e["value"];e["co_val"]=e["co_val"];e["isHidden"]=false;e["isLocked"]=false;e["selected"]=false;e["nodecomments"]=[]}}else{e["title"]=e["name"];e["dtitle"]=e["name"];e["value"]=e["value"];e["value_org"]=e["value"];e["difference"]=e["value_org"]-e["value"];e["isHidden"]=false;e["isLocked"]=false;e["selected"]=false;e["nodecomments"]=[]}}if(e.hasOwnProperty("children")){for(var a=0;a<e["children"].length;a++){o(e["children"][a])}}else{return}}r.children=e.children;return new sap.ui.model.json.JSONModel(r);this.resetFields()},constructSegmentTreeJson:function(e){var t=this;if(t.varianceMeasure==true){var a={id:"NODE1",title:e.name,dtitle:"Measure",Value:e.Value,percentvalue:100,value_org:e.Value,children:""};e.children.forEach(function(t){i(t,e)});function i(e,t){if(e.hasOwnProperty("name")){e["dtitle"]=e["title"];e["title"]=e["name"];e["value_org"]=e["Value"];e["percentvalue"]=e["Value"]/t["Value"]*100}if(e.hasOwnProperty("children")){for(var a=0;a<e["children"].length;a++){i(e["children"][a],e)}}else{return}}a.children=e.children}else{var a={id:"NODE1",title:e.name,dtitle:"Measure",Value:e.Value,value_org:e.Value,children:""};e.children.forEach(function(e){i(e)});function i(e){if(e.hasOwnProperty("name")){e["dtitle"]=e["title"];e["title"]=e["name"];e["value_org"]=e["Value"]}if(e.hasOwnProperty("children")){for(var t=0;t<e["children"].length;t++){i(e["children"][t])}}else{return}}a.children=e.children}return a},onyearPress:function(e){var t=new Date;var a=t.getFullYear();var i=e.oSource.getText();if(a.toString()!=i){this.getView().byId("floatSlider").setMin(0);this.getView().byId("floatSlider").setValue(0);this.getView().byId("floatSlider").setMax(12);this.getView().byId("floatSlider").setStep(3)}else{var s;var n=t.getMonth()+1;if(n==1||n<3)s=3;else if(n==3||n<6)s=6;else if(n==6||n<9)s=9;this.getView().byId("floatSlider").setMin(s);this.getView().byId("floatSlider").setMax(12);this.getView().byId("floatSlider").setStep(3)}this.handleFloatSliderChange()},loadPivotTable:function(){var e=this;var a={};var i=this.getView().byId("reportContainerParent");var r="FileUploader/Tables?FileName="+this.scenarioInfo.serviceURL;t.callService("selectedTableModel","selectedTableModel",r,"IMS",true,"",function(e,t){if(e.mParameters.success){var a=sap.ui.getCore().getModel("selectedTableModel").getData();console.log(e);s.drawTable("reportContainer",a,[],[],i)}else{n.error("Data Loading Failed")}})},handleExpandButtonPress:function(e){var a=this;var i;a.selecetdColumnObj=e.oSource.getBindingContext();a.selectedColumnName=e.oSource.mBindingInfos.text.binding.sPath;e.oSource.getBindingContext().getObject()["Parent"]=e.oSource.mBindingInfos.text.binding.sPath+e.oSource.getBindingContext().sPath.split("/")[1];a.pathToRecognize=e.oSource.getBindingContext().getObject()["Parent"];var s=e.oSource.getBindingContext().getObject();if(e.oSource.getIcon()=="sap-icon://navigation-right-arrow"){e.oSource.setIcon("sap-icon://navigation-down-arrow");var n=a.selecetdColumnObj.getObject();var r;for(var o=0;o<Object.keys(e.oSource.getBindingContext().getObject()).length;o++){if(Object.keys(e.oSource.getBindingContext().getObject())[o]!="expanded"&&Object.values(e.oSource.getBindingContext().getObject())[o].toString().indexOf("All")==-1&&Object.keys(e.oSource.getBindingContext().getObject())[o]!="Parent"&&Object.keys(e.oSource.getBindingContext().getObject())[o]!="ParentNew"){if(o==0){r='"'+Object.keys(e.oSource.getBindingContext().getObject())[o]+'"'+"||"+Object.values(e.oSource.getBindingContext().getObject())[o]}else{r=r+",,"+'"'+Object.keys(e.oSource.getBindingContext().getObject())[o]+'"'+"||"+Object.values(e.oSource.getBindingContext().getObject())[o]}}}e.oSource.setIcon("sap-icon://navigation-down-arrow");for(var l=0;l<a.measureProperties.length;l++){if(l===0)i=a.measureProperties[l].Value;else i+=","+a.measureProperties[l].Value}for(var d=0;d<2;d++){if(a.selecetdColumnObj.getObject()[a.unselecteddimension[d]].indexOf("All")==-1)i+=","+a.unselecteddimension[d]}var g=i+","+e.oSource.mBindingInfos.text.parts[0].path+"&$filter="+r;a.selecetdColumnObj.getObject()["expanded"]=e.oSource.mBindingInfos.text.binding.sPath;var c="TableExpand.xsjs?variantID="+a.variantObject.VariantId+"&select="+g;t.callService("ExbandTabledataModel","ExbandTabledataModel",c,"scenario",true,"",function(e,t){var i=sap.ui.getCore().getModel("ExbandTabledataModel").oData[0];for(var s=0;s<2;s++){for(var n=0;n<i.length;n++){if(!i[n].hasOwnProperty(a.unselecteddimension[s]))i[n][a.unselecteddimension[s]]="All "+a.unselecteddimension[s]}}for(var n=0;n<i.length;n++){if(a.selecetdColumnObj.getObject().Parent){i[n]["Parent"]=a.selecetdColumnObj.getObject().Parent}}for(var n=0;n<i.length;n++){if(i[n].hasOwnProperty("Parent"))i[n]["ParentNew"]=a.pathToRecognize;else i[n]["Parent"]=a.pathToRecognize}for(var r=0;r<i.length;r++)a.selecetdColumnObj.getModel().oData.splice(parseInt(a.selecetdColumnObj.getPath().split("/")[1])+r+1,0,i[r]);a.selecetdColumnObj.getModel().updateBindings(true)})}else{a.selecetdColumnObj.getObject()["expanded"]=false;e.oSource.setIcon("sap-icon://navigation-right-arrow");for(var u=a.selecetdColumnObj.getModel().oData.length-1;u>=0;u--){if(a.selecetdColumnObj.getModel().oData[u].Parent!=undefined||a.selecetdColumnObj.getModel().oData[u].ParentNew!=undefined){if(a.selecetdColumnObj.getModel().oData[u].Parent==a.pathToRecognize||a.selecetdColumnObj.getModel().oData[u].ParentNew==a.pathToRecognize)a.selecetdColumnObj.getModel().oData.splice(u,1)}}a.selecetdColumnObj.getModel().updateBindings(true)}},handleTableSearch:function(e){var t=Object.keys(this.getView().byId("temptree").getModel().oData[0]);var a=e.oSource.getValue();var i=[];for(var s=0;s<this.dimensionProperties.length;s++){var n=this.dimensionProperties[s].Value;i.push(n)}for(var r=0;r<this.unselecteddimension.length;r++){i.push(this.unselecteddimension[r])}var o=[];for(var l=0;l<t.length;l++){for(var d=0;d<i.length;d++){if(i[d]==t[l]){o.push(new sap.ui.model.Filter(t[l],sap.ui.model.FilterOperator.Contains,a))}}}var g=new sap.ui.model.Filter(o,false);this.getView().byId("temptree").getBinding("rows").filter(g)},ontablecollapse:function(){this.getView().setBusy(true);this.getView().byId("reportContainerParent").setVisible(true)},fileDataTree:function(e,t,a){var i=e.oData.d.results;t[0].property=t[0].property.toLocaleUpperCase();for(var s=0;s<a.length;s++){a[s].property=a[s].property.toLocaleUpperCase()}var n=[],r=[];for(var o=0;o<t.length;o++){n.push({property:t[o].property,value:i[0][t[0].property.toLocaleUpperCase()]})}for(var o=1;o<i.length;o++){var l=i[o];for(var s=0;s<l.length;s++){r.push(l[s])}}this.valueHelpForAddnodes.getContent()[0].getContent()[3].getItems()[0].setModel(new sap.ui.model.json.JSONModel(n));this.constructMeasureTreeJson(i[0],r,t,a)},serviceURLTree:function(e,t,a){var i=e.__batchResponses;var s=[],n=[];for(var r=0;r<t.length;r++){s.push({property:t[r].property,value:i[0].data.results[0][t[r].property]})}for(var r=1;r<i.length;r++){var o=i[r].data.results;for(var l=0;l<o.length;l++){n.push(o[l])}}this.valueHelpForAddnodes.getContent()[0].getContent()[3].getItems()[0].setModel(new sap.ui.model.json.JSONModel(s));this.constructMeasureTreeJson(i[0].data.results[0],n,t,a)},nodeSettings:function(e){var t=this;this.nodeDetails=e;this.impactSelected=false;var a=this.getView().byId("hiddenList"),i=[];var s=false;if(this.hiddenNodes.length>0){for(var n=0;n<this.hiddenNodes.length;n++){var r=this.hiddenNodes[n].arrayPos.split(":")[2];if(r===e.title){i.push({});s=true}}}if(s===true){a.setModel(new sap.ui.model.json.JSONModel(i));this.getView().byId("hideNode").setVisible(true)}else{this.getView().byId("hideNode").setVisible(false)}if(e.parent==undefined){this.getView().byId("nodeHidden").setEnabled(false)}else{this.getView().byId("nodeHidden").setEnabled(true)}var o=100;var d=d3.select("#id"+this.nodeDetails.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(this.nodeDetails.value_org)).select(".slice")[0][0];var g=d.style.fill.length==0?d.getAttribute("fill"):d.style.fill;this.value=o;if(this.url=="file")var c=this.Scenario.excelFileName.split(".")[0];else var c="LR2/Grossmargin";if(e.isHidden){this.getView().byId("nodeHidden").removeStyleClass("switchTextOff");this.getView().byId("nodeHidden").addStyleClass("switchTextOn")}else{this.getView().byId("nodeHidden").removeStyleClass("switchTextOn");this.getView().byId("nodeHidden").addStyleClass("switchTextOff")}if(e.isLocked){this.getView().byId("nodeLocked").removeStyleClass("switchTextOff");this.getView().byId("nodeLocked").addStyleClass("switchTextOn")}else{this.getView().byId("nodeLocked").removeStyleClass("switchTextOn");this.getView().byId("nodeLocked").addStyleClass("switchTextOff")}this.getView().byId("nodeHidden").setState(e.isHidden);this.getView().byId("nodeLocked").setState(e.isLocked);this.getView().byId("dataSource").setText(c);this.getView().byId("nodePercent").setEnabled(!e.isLocked);this.getView().byId("nodePercent").setValue(o);this.getView().byId("nodePie").getData()[0].setValue(parseInt(e.value_org));if(this.getView().byId("nodePie").getData()[0].getValue()>0){this.getView().byId("nodePie").getData()[0].setColor("Good")}else{this.getView().byId("nodePie").getData()[0].setColor("Error")}this.getView().byId("nodePie").getData()[1].setValue(parseInt(e.value));if(this.getView().byId("nodePie").getData()[1].getValue()>0){this.getView().byId("nodePie").getData()[1].setColor("Good")}else{this.getView().byId("nodePie").getData()[1].setColor("Error")}this.getView().byId("nodePie").getData()[2].setValue(parseInt(e.value-e.value_org));if(this.getView().byId("nodePie").getData()[2].getValue()>0){this.getView().byId("nodePie").getData()[2].setColor("Good")}else{this.getView().byId("nodePie").getData()[2].setColor("Error")}this.getView().byId("header").setTitle(e.dtitle);this.getView().byId("header").getAttributes()[0].setText("Org Value : "+l.amountToMillions(e.value_org));this.getView().byId("nodeCurrentValue").setText("Current Value : "+l.amountToMillions(e.value));this.getView().byId("nodeDiffValue").setText("Difference : "+l.amountToMillions(parseFloat(e.value_org)-parseFloat(e.value)));var u=parseFloat(e.value_org)-parseFloat(e.value);this.getView().byId("nodeDiffValue").setState(u>0?"Success":u<0?"Error":"None")},setImpactMeasuresValues:function(e){var t=this;this.getView().byId("ImpactMeasures").removeAllContent();var a=this.getView().byId("ImpactMeasures");var i=e;try{e.children.forEach(function(e){s(e)});function s(n){if(n.isLocked==false){var r=parseFloat(i.value_org);var o=parseFloat(n.value_org);var l=o/r*100;n.percent=l;a.addContent(new sap.m.Label({text:n.name}));a.addContent(new sap.m.ObjectStatus({text:o}));a.addContent(new sap.m.Slider({min:0,max:2*o,width:"90%",value:o,liveChange:function(e){t.handleImpactChange(e)}}))}else{var r=parseFloat(e.value_org);var o=parseFloat(n.value_org);var l=o/r*100;i.obj.percent=l;a.addContent(new sap.m.Label({text:n.name}));a.addContent(new sap.m.ObjectStatus({text:o}));a.addContent(new sap.m.Slider({min:0,max:2*o,width:"90%",value:o,enabled:false,liveChange:function(e){t.handleImpactChange(e)}}))}if(n.hasOwnProperty("children")){for(var d=0;d<n["children"].length;d++){s(n["children"][d])}}else{return}}}catch(e){}try{n(e);function n(e){if(e.isLocked==false){var a=2*e.value_org;var i=parseInt(e.value);t.getView().byId("nodePercent").setMax(a);t.getView().byId("nodePercent").setMin(0);t.getView().byId("nodePercent").setValue(i)}else{t.getView().byId("nodePercent").setEnabled(false);var a=2*e.value_org;var i=parseInt(e.value);t.getView().byId("nodePercent").setMax(a);t.getView().byId("nodePercent").setMin(0);t.getView().byId("nodePercent").setValue(i)}}}catch(e){}},resetFields:function(){var e=this.ValueHelpForService.getContent()[1];e.getItems()[0].getContent()[0].getContent()[1].setValue();e.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].setValue();e.getItems()[0].getContent()[0].getContent()[3].setSelected(false);e.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[7].setValue();e.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].setValueState("Error");if(this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1].getColumns().length>0){this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1].removeAllColumns();this.ValueHelpForService.getContent()[1].getItems()[2].getContent()[0].getItems()[1].getModel().setData(null)}var t=e.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0];var a=e.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1];if(t.getItems().length>0){t.removeAllItems()}if(a.getItems().length>0){a.removeAllItems()}},onSelectSegment:function(e){var t=this;var a=e.oSource.getSelectedKey();switch(a){case"new":t.ValueHelpForService.getContent()[2].setVisible(false);t.ValueHelpForService.getContent()[1].setVisible(true);break;case"exists":t.ValueHelpForService.getContent()[1].setVisible(false);t.ValueHelpForService.getContent()[2].setVisible(true)}},handleTreeStyle:function(e){if(e.mParameters.id.indexOf("expand")>-1)this.expandTree=true;else this.expandTree=false;i.drawSegmentTree(this)},handleTreeStyleData:function(e){if(this.expandTree){e.oSource.setTooltip("Expand all child nodes at once");e.oSource.setIcon("sap-icon://expand")}else{e.oSource.setTooltip("Collapse second level child nodes");e.oSource.setIcon("sap-icon://collapse")}this.expandTree=!this.expandTree;if(this.segmentTree){i.drawSegmentTree(this)}else{i.drawMeasureTree(this)}},handleChangeData:function(e){var t=this;if(e.oSource.getIcon().indexOf("tree")>-1){this.getView().byId("segments").setVisible(true);this.getView().byId("chartArea").setVisible(true);this.getView().byId("reportContainerParent").setVisible(false);this.getView().byId("treeStyle").setVisible(true);this.getView().byId("customFloatEditBtn2").setVisible(true);this.getView().byId("forecasting").setVisible(true);this.getView().byId("scenariocommentId").setVisible(true);e.oSource.setIcon("sap-icon://table-view");e.oSource.setTooltip("Table Structure");if(t.segmentTree){window.setTimeout(function(){t.getView().byId("vdtVisualise").setVisible(true);i.drawSegmentTree(t)},1e3)}else{window.setTimeout(function(){i.drawMeasureTree(t)},1e3)}}else{this.onDeletePress();this.getView().byId("segments").setVisible(false);this.getView().byId("chartArea").setVisible(false);this.getView().byId("treeStyle").setVisible(false);this.getView().byId("comment").setVisible(false);this.getView().byId("forecasting").setVisible(false);this.getView().byId("vdtVisualise").setVisible(false);this.getView().byId("scenariocommentId").setVisible(false);this.getView().byId("floaterSettingsVisibility").setVisible(false);this.getView().byId("customFloatEditBtn2").setVisible(false);this.getView().byId("reportContainerParent").setVisible(true);this.getView().setBusy(false);e.oSource.setIcon("sap-icon://tree");e.oSource.setTooltip("Tree Structure");this.loadPivotTable()}},handleVisualization:function(e){var t=this.zoomListener.scale();this.hMode=!this.hMode;if(!this.hMode){e.oSource.setTooltip("Vertical Representation");e.oSource.setIcon("sap-icon://vertical-grip")}else{e.oSource.setTooltip("Horizontal Representation");e.oSource.setIcon("sap-icon://horizontal-grip")}if(this.segmentTree){this.getView().byId("vdtVisualise").setVisible(true);i.drawSegmentTree(this)}else{i.drawMeasureTree(this)}},onRefreshView(){this.getView().byId("treeStyle").setTooltip("Collapse second level child nodes");this.getView().byId("treeStyle").setIcon("sap-icon://collapse");this.getView().byId("dataStyle").setIcon("sap-icon://table-view");this.getView().byId("forecasting").setType("Transparent");this.getView().byId("floaterSettingsVisibility").setVisible(false);this.getView().byId("chartArea").setVisible(true);this.getView().byId("treeStyle").setVisible(true);this.getView().byId("reportid").setVisible(true);this.getView().byId("forecasting").setVisible(true);this.getView().byId("saveVariant").setVisible(true);this.getView().byId("scenariocommentId").setVisible(true);this.getView().byId("customFloatEditBtn2").setVisible(true);this.getView().byId("customFloatEditBtn2").setVisible(true);this.getView().byId("vdtVisualise").setVisible(false)},onTreeReset:function(){this.expandTree=true;this.getView().byId("treeStyle").setTooltip("Collapse second level child nodes");this.getView().byId("treeStyle").setIcon("sap-icon://collapse");this.getView().byId("dataStyle").setIcon("sap-icon://table-view");this.getView().byId("forecasting").setType("Transparent");this.getView().byId("floaterSettingsVisibility").setVisible(false);this.getView().byId("vdtVisualise").setVisible(false);this.getView().byId("chartArea").setVisible(true);this.getView().byId("treeStyle").setVisible(true);this.getView().byId("reportid").setVisible(true);this.getView().byId("forecasting").setVisible(true);this.getView().byId("saveVariant").setVisible(true);this.getView().byId("scenariocommentId").setVisible(true);this.getView().byId("customFloatEditBtn2").setVisible(true);this.getView().byId("customFloatEditBtn2").setVisible(true);this.segmentTree=false;if(this.loadeddata=="Ml"){this.loadeddata="HANA;";this.variantObject.MeasureTree="";this.variantObject.SegmentSelection="";this.variantObject.SegmentTree="";this.getView().byId("segments").setText("Segments : All");this.loadDataToTreeForScenario(this.scenarioInfo,this.varianceInfo)}else{var e=this;var a="/Variants?$filter=VariantId eq "+e.variantObject.VariantId;t.callService("variantInfoModel","variantInfoModel",a,"scenario","true","",function(t){e.variantObject=sap.ui.getCore().getModel("variantInfoModel").getData().d.results[0];e.variantObject.VariantId=sap.ui.getCore().getModel("variantInfoModel").getData().d.results[0].VariantId;if(e.variantObject.SegmentSelection.includes("'")){e.getView().byId("segments").setText("Segments : "+e.variantObject.SegmentSelection)}else{e.getView().byId("segments").setText("Segments : All")}if(e.variantObject.HiddenNodes){e.hiddenNodes=JSON.parse(e.variantObject.HiddenNodes)}else{e.hiddenNodes=[]}i.drawMeasureTree(e)})}},setYearMonth:function(){var e=new Date;var t=e.getFullYear();var a=e.getMonth()+1;var i=[];if(a>8){i.push({year:(t+1).toString()});i.push({year:(t+2).toString()});i.push({year:(t+3).toString()})}else{i.push({year:t.toString()});i.push({year:(t+1).toString()});i.push({year:(t+2).toString()});this.getView().byId("floatSlider").setValue(a);if(a>=0&&a<3)this.getView().byId("floatSlider").setMin(3);else if(a>=4&&a<6)this.getView().byId("floatSlider").setMin(6);else if(a>=7&&a<9)this.getView().byId("floatSlider").setMin(9)}var s=new sap.ui.model.json.JSONModel(i);this.getView().byId("yearId").setModel(s)},onFuturePress:function(e){var t=e.oSource.getType();if(t=="Transparent"){e.oSource.setType("Emphasized");this.getView().byId("floaterSettingsVisibility").setVisible(true)}else{e.oSource.setType("Transparent");this.getView().byId("floaterSettingsVisibility").setVisible(false)}},onScenCommentsPress:function(e){this.onDeletePress();$("svg")[0].style.width=parseInt(window.innerWidth/100*73);this.getView().byId("comment").setVisible(true);this.getView().byId("vdt").setWidth("75%")},OnreportViewPress:function(e){var t=this;var a=sap.ui.getCore().getModel("SelectedScenarioModel").oData.d.results[0];var i=sap.ui.core.UIComponent.getRouterFor(this);i.navTo("Report");var s=sap.ui.getCore().getEventBus();s.publish("treeData","Report",{node:t.nodeDetails,scenario:a,variant:t.variantObject})},commentServices:function(e){var a=this;this.cmtScen=e;var i="/comments?$filter=ScenId eq "+e;t.callService("cmtInfoModel","cmtInfoModel",i,"scenario","true","",function(e){var t=sap.ui.getCore().getModel("cmtInfoModel");var i=t.oData.d.results;var s=[];for(var n=0;n<i.length;n++){i[n].template=false;s.push(i[n])}s.push({CreatedBy:a.user,rating:5,CommentDesc:"",CreatedDate:new Date,template:true});a.getView().byId("comment").setModel(new sap.ui.model.json.JSONModel({d:{results:s}}));a.getView().setBusy(false)})},addReview:function(e){var a=this;var i=e.oSource.oParent.getItems()[0].getText();if(i.length<=0){sap.m.MessageToast.show("Please enter the comment description")}else{var s=Math.floor(Math.random()*1e5);var n={CommentId:s,CommentDesc:i,CreatedDate:new Date,ScenId:a.variantObject.ScenId,VariantId:a.variantObject.VariantId,VariantName:a.variantObject.VariantName,Filter:"DTREE"};a.getView().setBusy(true);t.callCreateService("comments",JSON.stringify(n),"scenario","POST",function(t,i,s){if(i){var r="Comment is posted";sap.m.MessageToast.show(r);n.template=false;n.CreatedBy=a.user;n.CreatedDate=new Date;e.oSource.oParent.getItems()[0].setText();a.getView().byId("comment").getModel().oData.d.results.unshift(n);a.getView().byId("comment").getModel().updateBindings(true);a.getView().setBusy(false);window.setTimeout(function(){a.valueHelpForComments.openBy(a.oButton)},100)}else{sap.m.MessageToast.show("Failed to add comments, Try again later or Contact system admin");a.getView().setBusy(false)}})}},onDeletePress:function(){var e=this;try{$("svg")[0].style.width=window.innerWidth}catch(e){}this.getView().byId("vdt").setWidth("100%");this.getView().byId("forecasting").setType("Transparent");this.getView().byId("floaterSettingsVisibility").setVisible(false);this.getView().byId("forecast").setVisible(false);this.getView().byId("comment").setVisible(false);this.getView().byId("nodeSettings").setVisible(false);this.getView().byId("nodeHidden").setState(false);this.getView().byId("nodeLocked").setState(false);this.getView().byId("nodePercent").setValue(0);this.getView().byId("hideNode").setVisible(false);try{if(this.nodeDetails.isHidden)sap.m.MessageBox.warning("Hidden node not saved. Do you want to save hidden node.?",{title:"Warning",initialFocus:sap.m.MessageBox.Action.NO,actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(t){if(t===sap.m.MessageBox.Action.YES){e.handleHiddenNode()}else{e.nodeDetails.isHidden=false;var a=$("#id"+e.nodeDetails.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.nodeDetails.value_org))[0];a.style.opacity=1}}})}catch(e){}},handleSaveHiddenNodes:function(e){var t=this.treeModel.oData[0].children;var a=this.nodeDetails.depth;if(a==1){for(var s=0;s<t.length;s++){if(t[s].title==this.nodeDetails.title&&t[s].isHidden){t[s].arrayPos=t[s].title+":"+s;this.hiddenNodes.push(t.slice(s,s+1)[0]);t.splice(s,1);s--}}}else if(a==2){for(var s=0;s<t.length;s++){var n=t[s].children==undefined?t[s]._children:t[s].children;for(var r=0;r<n.length;r++){if(n[r].title==this.nodeDetails.title&&n[r].isHidden){n[r].arrayPos=n[r].title+":"+r+":"+t[s].title;this.editDataLevel2.push(n.slice(r,r+1)[0]);n.splice(r,1);r--;break}}}}i.drawMeasureTree(this);this.nodeDetails.isHidden=false;this.getView().byId("saveTree").setVisible(false)},handleDeleteHiddenNode:function(e){var t=e.getParameters().listItem.getBindingContext().getObject().title;for(var a=0;a<this.hiddenNodes.length;a++){if(t===this.hiddenNodes[a].arrayPos.split(":")[0]){var i=this.hiddenNodes[a].arrayPos.split(":")[1];delete this.hiddenNodes[a].arrayPos;this.hiddenNodes[a].isHidden=false;if(this.nodeDetails.children===undefined){this.nodeDetails.children=[];this.nodeDetails.children.push(this.hiddenNodes[a])}else{this.nodeDetails.children.splice(i,0,this.hiddenNodes[a])}var s=this.hiddenNodes[a].title.indexOf(t);if(s>-1){this.hiddenNodes.splice(a,1)}}}this.variantObject.MeasureTree=JSON.stringify(this.treeData,function(e,t){if(e!=="parent"){return t}});if(this.hiddenNodes.length===0){this.hiddenNodes=[]}this.getView().byId("hiddenList").getModel().oData.splice(e.getParameters().listItem.getBindingContext().sPath.split("/")[1],1);this.getView().byId("hiddenList").getModel().updateBindings(true);this.handleVariantUpdate(this.selectedVariant,true,true);e.oSource.oParent.setVisible(false)},handleHiddenNode:function(e){this.nodeDetails.isHidden=e.getParameters("state").state;var t=$("#id"+this.nodeDetails.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(this.nodeDetails.value_org))[0];if(this.nodeDetails.isHidden){t.style.opacity=.4;this.getView().byId("nodeHidden").removeStyleClass("switchTextOff");this.getView().byId("nodeHidden").addStyleClass("switchTextOn");var a=this.nodeDetails.parent.children;for(var i=0;i<a.length;i++){if(this.nodeDetails.title==a[i].title&&a[i].isHidden){a[i].arrayPos=this.nodeDetails.title+":"+i+":"+this.nodeDetails.parent.title;this.hiddenNodes.push(a.slice(i,i+1)[0]);var s=this.treeData.children===null?this.treeData.children:this.treeData.children;a.splice(i,1)}}}else{t.style.opacity=1;this.getView().byId("nodeHidden").removeStyleClass("switchTextOn");this.getView().byId("nodeHidden").addStyleClass("switchTextOff")}},handleLockNode:function(e){this.nodeDetails.isLocked=e.getParameters("state").state;if(this.nodeDetails.isLocked){this.getView().byId("nodePercent").setEnabled(false);this.getView().byId("nodeLocked").removeStyleClass("switchTextOff");this.getView().byId("nodeLocked").addStyleClass("switchTextOn")}else{this.getView().byId("nodePercent").setEnabled(true);this.getView().byId("nodeLocked").removeStyleClass("switchTextOn");this.getView().byId("nodeLocked").addStyleClass("switchTextOff")}},handlethresholdInput:function(){this.nodeDetails.critical=this.getView().byId("Critical").getValue();this.nodeDetails.warning=this.getView().byId("Warning").getValue();this.nodeDetails.target=this.getView().byId("Target").getValue();var e=d3.select("#id"+this.nodeDetails.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(this.nodeDetails.value_org)).select(".slice")[0][0];var t=l.thresholdLevel(this.nodeDetails,e.getAttribute("fill"));e.style.fill=t;$("#"+this.getView().byId("legend1").sId+"-img").css("color",t);this.getView().byId("legend1").addStyleClass(l.getSapValueStateColor(t,this)[1])},handleImpactChange:function(e){this.impactSelected=true;var t=e.getParameters("value").value;var a=e.oSource.oParent.getLabel().getText();var i=this.nodeDetails.children;for(var s=0;s<i.length;s++){if(i[s].name===a)var n=i[s]}this.value=n.value_org;this.sliderChangeFunction(n,t,false);var i=n.parent.children;for(var s=0;s<i.length;s++){e.oSource.oParent.oParent.getFormElements()[s].getFields()[0].setText(i[s].value);e.oSource.oParent.oParent.getFormElements()[s].getFields()[1].setValue(i[s].value)}var r=parseFloat(n.parent.value)-parseFloat(n.parent.value_org);this.getView().byId("nodePie").getData()[0].setValue(parseInt(n.value_org));if(this.getView().byId("nodePie").getData()[0].getValue()>0){this.getView().byId("nodePie").getData()[0].setColor("Good")}else{this.getView().byId("nodePie").getData()[0].setColor("Error")}this.getView().byId("nodePie").getData()[1].setValue(parseInt(n.value));if(this.getView().byId("nodePie").getData()[1].getValue()>0){this.getView().byId("nodePie").getData()[1].setColor("Good")}else{this.getView().byId("nodePie").getData()[1].setColor("Error")}this.getView().byId("nodePie").getData()[2].setValue(parseInt(n.value-n.value_org));if(this.getView().byId("nodePie").getData()[2].getValue()>0){this.getView().byId("nodePie").getData()[2].setColor("Good")}else{this.getView().byId("nodePie").getData()[2].setColor("Error")}this.getView().byId("nodeCurrentValue").setText("Current Value : "+l.amountToMillions(n.parent.value));this.getView().byId("nodeDiffValue").setText("Difference : "+l.amountToMillions(r));var o=r>0?"Success":r<0?"Error":"None";this.getView().byId("nodeDiffValue").setState(o)},saveNodevalues:function(){var e=[];var t=this.treeData;var a={name:this.treeData["name"],originalValue:this.treeData["value"]};e.push(a);t.children.forEach(function(e){i(e)});function i(t){if(t.hasOwnProperty("name")){var a={name:t["name"],originalValue:t["value"]};e.push(a)}if(t.hasOwnProperty("children")){for(var s=0;s<t["children"].length;s++){i(t["children"][s])}}else{return}}var s,n;for(var r=0;r<e.length;r++){if(r==0){s=e[r].name;n=e[r].originalValue}else{s+=","+e[r].name;n+=","+e[r].originalValue}}},handleNodePercent:function(e){this.impactSelected=false;var t=e.getParameters("value");var a=this.nodeDetails.name;this.sliderChangeFunction(this.nodeDetails,t.value,false);var i=parseFloat(this.nodeDetails.value)-parseFloat(this.nodeDetails.value_org);this.getView().byId("nodePie").getData()[0].setValue(parseInt(this.nodeDetails.value_org));if(this.getView().byId("nodePie").getData()[0].getValue()>0){this.getView().byId("nodePie").getData()[0].setColor("Good")}else{this.getView().byId("nodePie").getData()[0].setColor("Error")}this.getView().byId("nodePie").getData()[1].setValue(parseInt(this.nodeDetails.value));if(this.getView().byId("nodePie").getData()[1].getValue()>0){this.getView().byId("nodePie").getData()[1].setColor("Good")}else{this.getView().byId("nodePie").getData()[1].setColor("Error")}this.getView().byId("nodePie").getData()[2].setValue(parseInt(this.nodeDetails.value-this.nodeDetails.value_org));if(this.getView().byId("nodePie").getData()[2].getValue()>0){this.getView().byId("nodePie").getData()[2].setColor("Good")}else{this.getView().byId("nodePie").getData()[2].setColor("Error")}this.getView().byId("nodeCurrentValue").setText("Current Value : "+l.amountToMillions(this.nodeDetails.value));this.getView().byId("nodeDiffValue").setText("Difference : "+l.amountToMillions(i));var s=i>0?"Success":i<0?"Error":"None";this.getView().byId("nodeDiffValue").setState(s)},sliderChangeFunction:function(e,t,a){var i=this;var s=t;var n=e.dtitle;e.value=s;var r=[];r.push(e.dtitle);if(e.parent!=undefined){if(a==true)e.parent.value=parseInt(e.parent.value_org-e.co_val*e.value_org);else e.parent.value=parseInt(e.parent.value_org-e.co_val*(e.value_org-e.value));i.nodeEffectedChange(e.parent)}if(e.hasOwnProperty("parent")){o(e)}if(e.parent==undefined){e.value=t;if(e.hasOwnProperty("children")){l(e)}else{return}}function o(e){if(e.isLocked==false){if(!r.includes(e.dtitle)){if(e.parent!=undefined){if(a==true)e.parent.value=parseInt(e.parent.value_org-e.co_val*e.value_org);else e.parent.value=parseInt(e.parent.value_org-e.co_val*(e.value_org-e.value));i.nodeEffectedChange(e.parent);r.push(e.dtitle)}}if(e.hasOwnProperty("parent")){o(e.parent)}else{l(e)}}}function l(e){if(e.children.length>0){for(var t=0;t<e.children.length;t++){if(e.children[t].isLocked==false){if(!r.includes(e.children[t].dtitle)){if(a==true)e.children[t].value=parseInt((e.value+e.children[t].co_val*e.children[t].value_org-e.value_org)/e.children[t].co_val);else e.children[t].value=parseInt((e.value+e.children[t].co_val*e.children[t].value_org-e.value_org)/e.children[t].co_val);i.nodeEffectedChange(e.children[t]);r.push(e.children[t])}if(e.children[t].hasOwnProperty("children")){l(e.children[t])}}}}else{return}}i.value=s;if(this.impactSelected)e.percent=s;this.nodeEffectedChange(e);i.dragged=true,i.variantChange=true},nodeEffectedChange:function(e){var t=d3.layout.pie().value(function(e){return e}).sort(null);var a=d3.svg.arc().outerRadius(40).innerRadius(20);var i=e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.value_org);var s=parseFloat(e.value)-parseFloat(e.value_org);e.difference=s;if(e.id!="NODE1"){e.difference=parseFloat(e.value)-e.value_org;var n=d3.select("#id"+i).selectAll("path");n.data(t([parseFloat(e.value_org),e.value,e.difference]));n.transition().duration(1).attr("d",a).attr("fill",function(e,t){if(t==1){if(e.data<=0){var a=["#427cac","#a1bed6","red"];return a[t]}else{var a=["#427cac","#a1bed6","green"];return a[t]}}else{if(e.data<=0){var a=["#427cac","#a1bed6","red"];return a[t]}else{var a=["#427cac","#a1bed6","green"];return a[t]}}})}else{e.difference=parseFloat(e.value)-e.value_org;var n=d3.select("#id"+i).selectAll("path");n.data(t([parseFloat(e.value_org),e.value,e.difference]));n.transition().duration(1).attr("d",a).attr("fill",function(e,t){if(t==1){if(e.data<=0){var a=["#427cac","#a1bed6","red"];return a[t]}else{var a=["#427cac","#a1bed6","green"];return a[t]}}else{if(e.data<=0){var a=["#427cac","#a1bed6","red"];return a[t]}else{var a=["#427cac","#a1bed6","green"];return a[t]}}})}$("#ct"+i).text(l.amountToMillions(e.value));$("#cv"+i).text("Current Value : "+l.amountToMillions(e.value));$("#dv"+i).text("Difference "+l.amountToMillions(e.difference));$("#dv"+i).css("fill",s>0?"green":s<0?"red":"black");$("#rt"+i).css("stroke",s>0?"green":s<0?"red":"black")},onSettingsPress:function(){var e=this;var t=sap.ui.core.UIComponent.getRouterFor(this);t.navTo("nodeSettings");var a=sap.ui.getCore().getEventBus();a.publish("treeData","settings",{node:e.nodeDetails,scenario:e.scenarioInfo,varianceInfo:e.varianceInfo,variant:e.variantObject})},handleSwithSettings:function(e){var t=e.getParameters("state").state;if(t)this.getView().byId("floatSliderVisibility").removeStyleClass("floatSliderVisibility");else this.getView().byId("floatSliderVisibility").addStyleClass("floatSliderVisibility")},handleFloatSliderChange:function(){var e=this;var a=e.getView().byId("floatSlider").getValue();e.getView().setBusy(true);var s=this.varianceInfo.timeDimension;var n=e.scenarioInfo.measures.toString();if(s.length>0){var r="Forecast?view="+e.scenarioInfo.serviceURL+"&Date="+s+"&target="+e.scenarioInfo.Entity+"&selectM="+n+"&Month="+a;t.callService("measurepredicttreeModel","measurepredicttreeModel",r,"IMS",true,"",function(t,a){if(t.oSource.oData=="Forecasting of data is not possible."){e.getView().setBusy(false);sap.m.MessageToast.show("Forecasting of data is not possible.")}else if(t.oSource.oData.root!=undefined){var s=sap.ui.getCore().getModel("measurepredicttreeModel");var n=e.treeData;var r=e.constructMeasureTreeJson(s.getData().root,e.selectedyear,e.x);e.getView().setBusy(false);var o=e.Quartervalue;var d=r.oData;d.value=r.oData.value;d.value_org=n.value_org;var g=d.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(d.value_org);var c=parseFloat(r.oData.value)-parseFloat(n.value_org);d.difference=c;$("#ct"+g).text(l.amountToMillions(d.value));$("#cv"+g).text("Current Value : "+l.amountToMillions(d.value));$("#dv"+g).text("Difference "+l.amountToMillions(c));$("#dv"+g).css("fill",c>0?"green":c<0?"red":"black");$("#rt"+g).css("stroke",c>0?"green":c<0?"red":"black");u(d.children);function u(e){var t=e;for(var a=0;a<t.length;a++){var i=t[a].title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(t[a].value_org);for(var s=0;s<n.children.length;s++){if(n.children[s].title==t[a].title){t[a].value=r.oData.children[a].value;t[a].value_org=n.children[a].value_org;var o=parseFloat(r.oData.children[a].value)-parseFloat(n.children[s].value_org);t[a].difference=o;break}}$("#ct"+i).text(l.amountToMillions(t[a].value));$("#cv"+i).text("Current Value : "+l.amountToMillions(t[a].value));$("#dv"+i).text("Difference "+l.amountToMillions(o));$("#dv"+i).css("fill",o>0?"green":o<0?"red":"black");$("#rt"+i).css("stroke",o>0?"green":o<0?"red":"black");e=t[a]._children==null?t[a].children:t[a]._children;if(e)u(e)}}e.treeData=d;e.variantObject.MeasureTree=JSON.stringify(d);i.drawMeasureTree(e)}else{e.getView().setBusy(false)}})}else{e.getView().setBusy(false);sap.m.MessageToast.show("Forecasting of data is not possible.")}},onSaveNewNode:function(){var e=this;e.nodeName=e.valueHelpForAddnodes.getContent()[0].getContent()[1].getItems()[0].getValue();var a=e.valueHelpForAddnodes.getContent()[1].getExpression();if(e.nodeName.length<0){sap.m.MessageToast.show("Please Enter node name")}else if(this.valueHelpForAddnodes.getContent()[1].getExpression().length==1){sap.m.MessageToast.show("Please Enter Expression")}else{var s={variantID:JSON.stringify(e.variantObject.VariantId),Parent_node:e.nodeDetails.name,node_name:e.nodeName,Cal_type:"On_Detail",formula:a};t.callCreateService("Adding_node.xsjs",JSON.stringify(s),"Mlsystem","POST",function(a,s,n){console.log("posted");e.onCancel();e.dailog.open();var r="MeasureTree.xsjs?view="+e.SelectedUrl;t.callService("treedataModel","treedataModel",r,"scenario",true,"",function(t,a){var s=e.constructMeasureTreeJson(sap.ui.getCore().getModel("treedataModel").oData,null,null);e.variantObject.MeasureTree=JSON.stringify(s.oData,function(e,t){if(e!="parent")return t});i.drawMeasureTree(e);e.segmentTree=false;e.dailog.close()})})}},addNode:function(e){var t=this;try{t.nodeDetails=e;var a=[];var i=t.ValueHelpForDataRecords.getModel().getData();i.forEach(function(e){if(e.FileName==t.scenarioInfo.serviceURL){a=e.MEASURES}});var s=new sap.ui.model.json.JSONModel(a);var n=[];for(var r=0;r<s.oData.length;r++){var o={key:s.oData[r],label:s.oData[r],items:[{key:s.oData[r]},{key:"+"},{key:s.oData[r]}]};n.push(o)}var l=new sap.ui.model.json.JSONModel(n);t.valueHelpForAddnodes.getContent()[1].setModel(l);t.valueHelpForAddnodes.open()}catch(a){t.addNode(e)}},addComment:function(e){this.getView().byId("nodeSettings").setVisible(false);var t=this;this.nodeDetails=e;var a=[];if(this.nodeDetails.nodecomments.length>0){var i={d:{results:this.nodeDetails.nodecomments}};var s=new sap.ui.model.json.JSONModel(i);t.valueHelpForAddComments.setModel(s)}else{var n={CreatedBy:t.user,CommentDescription:"",CreatedDate:new Date,template:true};a.unshift(n);var i={d:{results:a}};var s=new sap.ui.model.json.JSONModel(i);t.valueHelpForAddComments.setModel(s)}this.valueHelpForAddComments.open()},NodeComments:function(e){var t=this;var a=this.nodeDetails.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(this.nodeDetails.value_org);var i=e.oSource.oParent.getItems()[1].getValue();var s={CreatedBy:t.user,CommentDescription:"",CreatedDate:new Date,template:true};try{var n=t.valueHelpForAddComments.getModel().oData.d.results;for(var r=0;r<n.length;r++){n[r].template=false}t.valueHelpForAddComments.getModel().oData.d.results.unshift(s);t.valueHelpForAddComments.getModel().updateBindings(true)}catch(e){}if(t.valueHelpForAddComments.getModel().oData.d.results.length>1)this.nodeDetails.nodecomments=t.valueHelpForAddComments.getModel().oData.d.results;$("#Mc"+a).text(n.length-1)},exitfragment:function(){$("svg")[0].style.width=window.innerWidth;this.getView().byId("vdt").setWidth("100%");this.valueHelpForAddComments.close()},selectNodeChange:function(e){var t=e.oSource.getSelectedKey();if(t=="Data"){this.valueHelpForAddnodes.getContent()[0].getContent()[3].getItems()[0].setVisible(true);this.valueHelpForAddnodes.getContent()[0].getContent()[3].getItems()[1].setVisible(false);this.valueHelpForAddnodes.getContent()[0].getContent()[4].setVisible(false);this.valueHelpForAddnodes.getContent()[0].getContent()[5].setVisible(false)}else{this.valueHelpForAddnodes.getContent()[0].getContent()[3].getItems()[0].setVisible(false);this.valueHelpForAddnodes.getContent()[0].getContent()[3].getItems()[1].setVisible(true);this.valueHelpForAddnodes.getContent()[0].getContent()[4].setVisible(true);this.valueHelpForAddnodes.getContent()[0].getContent()[5].setVisible(true)}},onCancel:function(){this.valueHelpForAddnodes.getContent()[1].setExpression(" ");this.valueHelpForAddnodes.getContent()[0].getContent()[1].getItems()[0].setValue();this.valueHelpForAddnodes.close()},onSelectedSegments:function(e){var a=this;var s=" ",n;if(this.segmentItems.length>0){for(var r=0;r<this.segmentItems.length;r++){if(r==this.segmentItems.length-1)s+=this.segmentItems[r].title+" '"+this.segmentItems[r].items.join()+"' ";else s+=this.segmentItems[r].title+" '"+this.segmentItems[r].items.join()+"', "}var o="";for(var l=0;l<this.segmentItems.length;l++){if(l!=0){o+=" and "}if(this.segmentItems[l].title=="Measure"){for(var d=0;d<this.segmentItems[l].items.length;d++){if(d==0)o+=this.segmentItems[l].items[d]+" eq "+this.segmentItems[l].items[d];else o+=" and "+this.segmentItems[l].items[d]+" eq "+this.segmentItems[l].items[d]}}else{for(var d=0;d<this.segmentItems[l].items.length;d++){if(d==0)o+=this.segmentItems[l].title+" eq "+this.segmentItems[l].items[d];else o+=" and "+this.segmentItems[l].title+" eq "+this.segmentItems[l].items[d]}}}n="MeasureTree.xsjs?view="+a.SelectedUrl+"&filter="+o;console.log(o)}else{var s=" All ";n="MeasureTree.xsjs?view="+a.SelectedUrl}this.variantObject.SegmentTree=a.segmentTreeData;this.segmentTree=false;t.callService("selectedtreeModel","selectedtreeModel",n,"scenario",true,"",function(e,t){var n=sap.ui.getCore().getModel("selectedtreeModel");a.getView().byId("segments").setText("Segments : "+s);a.variantChange=true;a.variantObject.SegmentSelection=s;a.getView().byId("vdtVisualise").setVisible(false);var r=a.constructMeasureTreeJson(n.oData,null,null);a.variantObject.MeasureTree=JSON.stringify(r.oData);i.drawMeasureTree(a)})},onSelectedSegmentsCancel:function(){this.getView().byId("vdtVisualise").setVisible(false);this.segmentTree=false;i.drawMeasureTree(this)},onAddNewVariant:function(){var e=this;if(this.getView().byId("variantItems").getModel().oData.length>=3){sap.m.MessageToast.show("Please delete any existing variants to add new variant")}else{if(this.variantChange){sap.m.MessageBox.warning("Changes made are not saved to selected variant? Do you wish to save the variant",{title:"Warning",initialFocus:sap.m.MessageBox.Action.NO,actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(t){if(t===sap.m.MessageBox.Action.YES){e.handleVariantUpdate(e.selectedVariant,true,true);if(sap.ui.getCore().getModel("SelectedScenarioModel").oData.d.results[0].RoleFlag.length>0)e.valueHelpForVariant.getContent()[1].mAggregations.form.getFormContainers()[0].getFormElements()[1].getFields()[0].setVisible(true);else e.valueHelpForVariant.getContent()[1].mAggregations.form.getFormContainers()[0].getFormElements()[1].getFields()[0].setVisible(false);e.valueHelpForVariant.open()}else{e.resetVariantdata(e.variantObject.VariantId);if(sap.ui.getCore().getModel("SelectedScenarioModel").oData.d.results[0].RoleFlag.length>0)e.valueHelpForVariant.getContent()[1].mAggregations.form.getFormContainers()[0].getFormElements()[1].getFields()[0].setVisible(true);else e.valueHelpForVariant.getContent()[1].mAggregations.form.getFormContainers()[0].getFormElements()[1].getFields()[0].setVisible(false);e.valueHelpForVariant.open()}}})}else{if(sap.ui.getCore().getModel("SelectedScenarioModel").oData.d.results[0].RoleFlag.length>0)e.valueHelpForVariant.getContent()[1].mAggregations.form.getFormContainers()[0].getFormElements()[1].getFields()[0].setVisible(true);else e.valueHelpForVariant.getContent()[1].mAggregations.form.getFormContainers()[0].getFormElements()[1].getFields()[0].setVisible(false);this.valueHelpForVariant.open();this.existingVariants()}}},existingVariants:function(){var e=this;var a="VariantShare.xsjs?ScenId="+e.variantObject.ScenId;t.callService("existingVariants","existingVariants",a,"scenario",true,"",function(t,a){if(t.oSource.oData!="No Shared Variants for the Selected Scenario"){var i=sap.ui.getCore().getModel("existingVariants");e.valueHelpForVariant.getContent()[2].setModel(i)}})},onDeleteVariant:function(e){var a=this;sap.m.MessageBox.confirm("Are you sure you want to delete the ' "+a.variantObject.VariantName+" ' ?",{onClose:function(e){if(e==="OK"){a.getView().setBusy(true);var i="Variants("+a.variantObject.VariantId+")";t.callDeleteService(i,"scenario",function(){if(a.getView().byId("variantItems").getModel().oData.length==1){a.getView().byId("variantDelId").setVisible(false)}else{a.getView().byId("variantDelId").setVisible(true)}a.selectedScenarioModel(a.variantObject.ScenId)})}}})},onSegmentButtonPress:function(e){var t=this;this.segmentTree=false;if(this.getView().byId("dataStyle").getIcon()=="sap-icon://table-view"){this.getView().byId("chartArea").setVisible(true);this.getView().byId("reportContainerParent").setVisible(false);this.getView().byId("treeStyle").setVisible(true);this.getView().byId("customFloatEditBtn2").setVisible(true);this.getView().byId("forecasting").setVisible(true);this.getView().byId("scenariocommentId").setVisible(true)}this.getView().byId("vdtVisualise").setVisible(false);var a=e.oSource;if(this.variantChange)sap.m.MessageBox.warning("Changes made are not saved to selected variant? Do you wish to save the variant",{title:"Warning",initialFocus:sap.m.MessageBox.Action.YES,actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){t.handleVariantUpdate(t.selectedVariant,false,true);t.resetdata()}else{window.setTimeout(function(){t.resetVariantdata(t.variantObject.VariantId)},1e4)}$("svg")[0].style.width=window.innerWidth;t.getView().byId("vdt").setWidth("100%");t.selectedVariant=a.getText();t.variantObject=a.getBindingContext().getObject();if(t.variantObject.SegmentSelection.includes("'")){t.getView().byId("segments").setText("Segments : "+t.variantObject.SegmentSelection)}else{t.getView().byId("segments").setText("Segments : All")}if(t.variantObject.HiddenNodes){t.hiddenNodes=JSON.parse(t.variantObject.HiddenNodes)}else{t.hiddenNodes=[]}t.expandTree=true,t.editDataLevel2=[],t.dragged=false;t.getView().byId("treeStyle").setTooltip("Collapse second level child nodes");t.getView().byId("treeStyle").setIcon("sap-icon://collapse");t.variantChange=false;if(t.segmentTree){t.segmentsSelected=[],t.segmentItems=[];i.drawSegmentTree(t);t.getView().byId("vdtVisualise").setVisible(true)}else{t.loadDataToTreeForScenario(t.scenarioInfo,t.varianceInfo)}}});else{$("svg")[0].style.width=window.innerWidth;this.getView().byId("vdt").setWidth("100%");this.selectedVariant=e.oSource.getText();this.variantObject=e.oSource.getBindingContext().getObject();t.variantObject.VariantId=e.oSource.getBindingContext().getObject().VariantId;if(this.variantObject.SegmentSelection.includes("'")){t.getView().byId("segments").setText("Segments : "+t.variantObject.SegmentSelection)}else{t.getView().byId("segments").setText("Segments : All")}if(t.variantObject.HiddenNodes){t.hiddenNodes=JSON.parse(t.variantObject.HiddenNodes)}else{t.hiddenNodes=[]}this.expandTree=true,this.editDataLevel2=[],this.dragged=false;this.getView().byId("treeStyle").setTooltip("Collapse second level child nodes");this.getView().byId("treeStyle").setIcon("sap-icon://collapse");if(this.segmentTree){this.segmentsSelected=[],this.segmentItems=[];i.drawSegmentTree(this);this.getView().byId("vdtVisualise").setVisible(true)}else{t.loadDataToTreeForScenario(t.scenarioInfo,t.varianceInfo)}this.variantChange=false}},resetdata:function(){var e=this;$("svg")[0].style.width=window.innerWidth;e.getView().byId("vdt").setWidth("100%");e.selectedVariant=segment.getText();e.variantObject=segment.getBindingContext().getObject();if(e.variantObject.SegmentSelection.includes("'")){e.getView().byId("segments").setText("Segments : "+e.variantObject.SegmentSelection)}else{e.getView().byId("segments").setText("Segments : All")}if(e.variantObject.HiddenNodes){e.hiddenNodes=JSON.parse(e.variantObject.HiddenNodes)}else{e.hiddenNodes=[]}e.expandTree=true,e.editDataLevel2=[],e.dragged=false;e.getView().byId("treeStyle").setTooltip("Collapse second level child nodes");e.getView().byId("treeStyle").setIcon("sap-icon://collapse");e.variantChange=false;if(e.segmentTree){e.segmentsSelected=[],e.segmentItems=[];i.drawSegmentTree(e);e.getView().byId("vdtVisualise").setVisible(true)}else{e.loadDataToTreeForScenario(e.scenarioInfo,e.varianceInfo)}},resetVariantdata:function(e){var a=this;var i="Variants.xsjs?variantID="+e;t.callService("variantInfoModel","variantInfoModel",i,"scenario","true","",function(e){a.variantObject=sap.ui.getCore().getModel("variantInfoModel").oData[0];a.variantObject.MeasureTree=a.variantObject.MeasureTree;a.variantObject.SegmentSelection=a.variantObject.SegmentSelection;a.variantObject.SegmentTree=a.variantObject.SegmentTree;if(a.variantObject.HiddenNodes){a.hiddenNodes=JSON.parse(a.variantObject.HiddenNodes)}else{a.hiddenNodes=[]}a.resetdata()})},onVariantSave:function(){var e=this;var t=new sap.m.Dialog({title:"Confirm",type:"Message",content:[new sap.m.Label({text:"Are you sure you want to save changes to the selected variant as?"}),new sap.m.Input({value:e.variantObject.VariantName,width:"100%",placeholder:"Add Variant (required)"})],beginButton:new sap.m.Button({text:"Save",press:function(a){var i=a.getSource().getParent().getContent()[1].getValue();e.handleVariantUpdate(i,true,true);e.selectedVariant=i;t.close()}}),endButton:new sap.m.Button({text:"Cancel",press:function(){t.close()}})});t.open()},handleVariantUpdate:function(e,a,s){var n=this;var r=this.getView().byId("segments").getText().split(":")[1];this.variantObject.VariantName=e;this.variantObject.SegmentSelection=r;this.variantObject.MeasureTree=JSON.stringify(this.treeData,function(e,t){if(e!="parent")return t});n.saveNodevalues();this.variantObject.SegmentTree=JSON.stringify(n.segmentTreeData,function(e,t){if(e!="parent")return t});if(this.hiddenNodes.length>0){this.variantObject.HiddenNodes=JSON.stringify(this.hiddenNodes,function(e,t){if(e!="parent")return t})}else{this.variantObject.HiddenNodes=""}this.getView().byId("variantItems").getModel().updateBindings(true);var o={VariantName:this.variantObject.VariantName,ScenId:this.variantObject.ScenId,Page_Id:this.variantObject.ScenId,MeasureTree:this.variantObject.MeasureTree,SegmentTree:this.variantObject.SegmentTree,SegmentSelection:this.variantObject.SegmentSelection,HiddenNodes:this.variantObject.HiddenNodes};this.variantChange=false;if(this.Existing==false){t.callCreateService("Variants("+parseInt(this.variantObject.VariantId)+")",JSON.stringify(o),"scenario","PUT",function(e,t,r){if(t&&s){sap.m.MessageToast.show("Variant Updated successfully")}if(a){$("svg")[0].style.width=window.innerWidth;n.getView().byId("vdt").setWidth("100%");n.expandTree=true,n.dragged=false;n.getView().byId("treeStyle").setTooltip("Collapse second level child nodes");n.getView().byId("treeStyle").setIcon("sap-icon://collapse");if(n.segmentTree){n.segmentsSelected=[],n.segmentItems=[];i.drawSegmentTree(n);n.getView().byId("vdtVisualise").setVisible(true)}else i.drawMeasureTree(n)}})}},handleVariantDialogClose:function(){this.valueHelpForVariant.close()},handleVariantScenario:function(e){var a=this;var i=this.valueHelpForVariant.getContent()[1].getContent()[1].getValue();if(i===""){sap.m.MessageToast.show("Please Enter Variant Name")}else if(this.getView().byId("variantItems").getModel().oData.length>0){var s=false;for(var n=0;n<this.getView().byId("variantItems").getModel().oData.length;n++){if(i==this.getView().byId("variantItems").getModel().oData[n].VariantName){s=true;sap.m.MessageToast.show("Variant Name Exist");break}else{s=false}}}if(s==false){this.valueHelpForVariant.close();var r={VariantName:i,VariantId:Math.round(Math.random()*1e6),ScenId:parseInt(a.ScenId),Page_Id:parseInt(a.ScenId),MeasureTree:"",SegmentTree:"",SegmentSelection:"",HiddenNodes:"",Filter:"DTREE"};if(this.Existing){a.variantObject=r;a.selectedVariant=i;a.hiddenNodes=[];a.getView().byId("segments").setText("Segments : All");a.getView().byId("variantItems").getModel().oData.push(r);a.getView().byId("variantItems").getModel().updateBindings(true);var o=a.getView().byId("variantItems").getItems().length-1;a.getView().byId("variantItems").setSelectedItem(a.getView().byId("variantItems").getItems()[o].sId);if(a.getView().byId("variantItems").getModel().oData.length==1){a.getView().byId("variantDelId").setVisible(false)}else{a.getView().byId("variantDelId").setVisible(true)}a.onExistingScenarioPress("selection")}else{var l=this.valueHelpForVariant.getContent()[1].getContent()[3].getSelected();t.callCreateService("/Variants",JSON.stringify(r),"scenario","POST",function(e,t,s){sap.m.MessageToast.show("Variant is created successfully");a.variantObject=r;a.selectedVariant=i;a.hiddenNodes=[];a.getView().byId("segments").setText("Segments : All");a.getView().byId("variantItems").getModel().oData.push(r);a.getView().byId("variantItems").getModel().updateBindings(true);var n=a.getView().byId("variantItems").getItems().length-1;a.getView().byId("variantItems").setSelectedItem(a.getView().byId("variantItems").getItems()[n].sId);if(a.getView().byId("variantItems").getModel().oData.length==1){a.getView().byId("variantDelId").setVisible(false)}else{a.getView().byId("variantDelId").setVisible(true)}a.valueHelpForVariant.getContent()[1].getContent()[1].setValue();a.valueHelpForVariant.getContent()[1].getContent()[3].setSelected(false);a.expandTree=true;a.getView().byId("treeStyle").setTooltip("Collapse second level child nodes");a.getView().byId("treeStyle").setIcon("sap-icon://collapse");$("svg")[0].style.width=window.innerWidth;a.getView().byId("vdt").setWidth("100%");a.getView().byId("vdtVisualise").setVisible(false);var o=a.getView().byId("scenarioName").getText();a.getView().byId("segments").setText("Segments : All");a.loadDataToTreeForScenario(a.scenarioInfo,a.varianceInfo)})}}},onViewForcast:function(){this.onDeletePress();if(sap.ui.getCore().getModel("measurepredicttreeModel").oData!="Forecasting of data is not possible."){$("svg")[0].style.width=parseInt(window.innerWidth/100*73);this.getView().byId("forecast").setVisible(true);this.getView().byId("vdt").setWidth("75%");this.getView().byId("forecasting").setType("Emphasized");this.getView().byId("floaterSettingsVisibility").setVisible(true);var e=this;var a=this.getView().byId("floatSlider").getValue();var i=l.getQuater(a,e);var s=e.getView().byId("forecastMeasureId1").getSelectedKey();for(var n=0;n<e.getView().byId("yearId").getItems().length;n++){if(e.getView().byId("yearId").getSelectedItem()==e.getView().byId("yearId").getItems()[n].sId){e.selectedyear=e.getView().byId("yearId").getItems()[n].getText();break}}var r="ForecastGraph.xsjs?variantID="+e.variantObject.VariantId+"&select="+e.measuretreeurl.split("&select=")[1].split("&target=")[0]+"&year1="+e.selectedyear+"&Quarter1="+i+"&column="+s+"&time="+e.varianceInfo.timeDimension+"&year="+e.varianceInfo.timePeriod+"&Quarter="+e.varianceInfo.quarterInfo;e.getView().setBusy(true);t.callService("forcastModel","forcastModel",r,"scenario",true,"",function(t,a){var i=sap.ui.getCore().getModel("forcastModel");e.dynamicchart();e.getView().setBusy(false)})}else{sap.m.MessageToast.show("Forecasting of data is not possible.")}},dynamicchart:function(){var e=sap.ui.getCore().getModel("forcastModel");var t={key:"2",name:"Line",value:[["Current_Value","Forecast_Value"],["Current_Value","Forecast_Value"],["Current_Value","Forecast_Value"]],vizType:"line",json:["/timeaxis/actual_forecast.json","/timeaxis/actual_target.json","/timeaxis/semantic.json"],dataset:[{dimensions:[{name:"month",value:"{month}",dataType:"date"}],measures:[{name:"Current_Value",value:"{Current_Value}"},{name:"Forecast_Value",value:"{Forecast_Value}"}],data:{path:"/"}}],rules:[{plotArea:{dataPointStyle:{rules:[{dataContext:{Current_Value:"*"},properties:{color:"sapUiChartPaletteQualitativeHue1",lineColor:"sapUiChartPaletteQualitativeHue1",lineType:"line"},displayName:"Current_Value",dataName:{Actual:"Current_Value"}},{dataContext:{Forecast_Value:"*"},properties:{color:"sapUiChartPaletteQualitativeHue1",lineColor:"sapUiChartPaletteQualitativeHue1",lineType:"dash"},displayName:"Forecast_Value",dataName:{Forecast:"Forecast_Value"}}]}}}],commonrules:{plotArea:{dataLabel:{formatString:ChartFormatter.DefaultPattern.SHORTFLOAT_MFD2,visible:false},gap:{visible:false},window:{start:"firstDataPoint",end:"lastDataPoint"}},valueAxis:{label:{formatString:ChartFormatter.DefaultPattern.SHORTFLOAT},title:{visible:false}},title:{visible:false},categoryAxis:{title:{visible:false}}}};var a=t;var i=this.oView.byId("forecast");var s=0;var n=new sap.viz.ui5.controls.Popover({});var r=this.getView().byId("forcastevizId");r.removeAllFeeds();var o=sap.ui.getCore().getModel("forcastModel");r.setModel(o);var l=new sap.viz.ui5.data.FlattenedDataset(a.dataset[s]);r.setDataset(l);r.setVizType(a.vizType);r.setVizProperties(a.commonrules);r.setVizProperties(a.rules[s]);var d=new sap.viz.ui5.controls.common.feeds.FeedItem({uid:"categoryAxis",type:"Dimension",values:["month"]}),g=new sap.viz.ui5.controls.common.feeds.FeedItem({uid:"valueAxis",type:"Measure",values:a.value[s]});r.addFeed(g);r.addFeed(d);n.connect(r.getVizUid());n.setFormatString(ChartFormatter.DefaultPattern.STANDARDFLOAT)},onSelectVariant:function(e){var t=e.oSource.getSelectedKey();switch(t){case"newvariant":this.valueHelpForVariant.getContent()[2].setVisible(false);this.valueHelpForVariant.getContent()[1].setVisible(true);break;case"existsvariant":this.valueHelpForVariant.getContent()[1].setVisible(false);this.valueHelpForVariant.getContent()[2].setVisible(true)}},onTitlechange:function(e){var t=this;if(e.oSource.getValue()!=""){t.ValueHelpForService.getButtons()[2].setEnabled(true)}},hanldeNext:function(){var e=this;e.ValueHelpForService.getContent()[1].getItems()[2].setEnabled(true);e.ValueHelpForService.getContent()[1].setSelectedKey("data");e.ValueHelpForService.getButtons()[2].setVisible(false);e.ValueHelpForService.getButtons()[2].setEnabled(false);e.ValueHelpForService.getButtons()[0].setVisible(true)},handleIconTabPress:function(e){var t=this;var a=t.ValueHelpForService.getContent()[1];if(e.oSource.getSelectedKey()===a.getItems()[4].getKey()){t.ValueHelpForService.getButtons()[2].setVisible(false);t.ValueHelpForService.getButtons()[0].setVisible(true)}if(e.oSource.getSelectedKey()===a.getItems()[0].getKey()){t.ValueHelpForService.getButtons()[2].setVisible(true);t.ValueHelpForService.getButtons()[0].setVisible(false)}},onScenarioEdit:function(e){var t=this;this.ValueHelpForService.open();this.updateFlag=true;this.mArray=[];this.dArray=[];var a=e.oSource.getBindingContext().sPath.split("/")[3];this.ListId=e.oSource.oParent.getModel().oData.d.results[a].ListId;this.ScenId=e.oSource.oParent.getModel().oData.d.results[a].ScenId;var i=e.oSource.oParent.getModel().oData.d.results[a].RoleFlag;var s=this.ValueHelpForService.getContent()[1];if(i==="X"){s.getItems()[0].getContent()[0].getContent()[3].setSelected(true)}var n=JSON.parse(decodeURIComponent(escape(window.atob(e.oSource.getModel().oData.d.results[a].ScenConfig))));t.editvarianceInfo=JSON.parse(decodeURIComponent(escape(window.atob(e.oSource.getModel().oData.d.results[a].VariantSettings))));var t=this;var r="/Scenarios?$expand=Variants&$filter=ScenId eq "+this.ScenId+"&$format=json";s.getItems()[0].getContent()[0].getContent()[1].setValue(n.scenarioTitle);s.getItems()[2].setEnabled(true);s.setSelectedKey("data");t.ValueHelpForService.getButtons()[0].setVisible(false);t.ValueHelpForService.getButtons()[1].setVisible(true).setEnabled(true);t.ValueHelpForService.getButtons()[2].setVisible(true).setEnabled(true);if(n.dataSource==="file"){this.fileUploaded=true;this.onExistingFileSelected("",n)}else{s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].setValue(n.serviceURL);s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].setValueState("Success");var o=t.ValueHelpForDataRecords.getContent()[1];o.getItems().forEach(function(e){if(e.getBindingContext().getObject().FileName==n.serviceURL){t.setMeasuresAndDimensionsForEnity(new sap.ui.model.json.JSONModel(e.getBindingContext().getObject()),n)}});s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[7].setValue(n.Entity);this.targetValue=n.Entity}},createTabledata:function(e){var t=this.ValueHelpForService.getContent()[1];var a=t.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[0];var i=t.getItems()[2].getContent()[0].getItems()[0].getItems()[1].getItems()[1];for(var s=0;s<e.measures.length;s++){for(var n=0;n<a.getItems().length;n++){if(a.getItems()[n].getTitle()===e.measures[s]){a.setSelectedItem(a.getItems()[n])}}}for(var r=0;r<e.dimension.length;r++){for(var o=0;o<i.getItems().length;o++){if(i.getItems()[o].getTitle()===e.dimension[r]){i.setSelectedItem(i.getItems()[o])}}}for(var l=0;l<a.getSelectedItems().length;l++){this.mArray.push(a.getSelectedItems()[l].getTitle())}for(var d=0;d<i.getSelectedItems().length;d++){this.dArray.push(i.getSelectedItems()[d].getTitle())}this.batchCall(e)},handleInput:function(e){var t=e.oSource.getValue();e.oSource.setEditable(false)},onviewSearch:function(e){var t=this.ValueHelpForDataRecords.getContent()[1];var a=t.getBinding("items");var i=e.getSource().getValue();if(i&&i.length>0){var s=[];var n=new sap.ui.model.Filter("FileName",sap.ui.model.FilterOperator.Contains,i);s.push(n);a.filter(new sap.ui.model.Filter(s,false))}else{a.filter([])}},onmeasureSearch:function(e){var t=this.valueHelpRequestForEntity.getContent()[1];var a=t.getBinding("items");var i=e.getSource().getValue();if(i&&i.length>0){var s=[];var n=new sap.ui.model.Filter("",sap.ui.model.FilterOperator.Contains,i);s.push(n);a.filter(new sap.ui.model.Filter(s,false))}else{a.filter([])}},addScenarioTabChange:function(e){var t=this;var a=e.oSource.getSelectedKey();switch(a){case"data":t.ValueHelpForService.getButtons()[2].setVisible(true);t.ValueHelpForService.getButtons()[2].setEnabled(true);t.ValueHelpForService.getButtons()[0].setVisible(false);break;case"general":t.ValueHelpForService.getButtons()[2].setVisible(true);t.ValueHelpForService.getButtons()[2].setEnabled(true);t.ValueHelpForService.getButtons()[0].setVisible(false);t.ValueHelpForService.getButtons()[1].setVisible(false);break;case"variance":t.ValueHelpForService.getButtons()[2].setVisible(false);t.ValueHelpForService.getButtons()[0].setVisible(true);t.ValueHelpForService.getButtons()[0].setEnabled(true);if(this.updateFlag===true){t.ValueHelpForService.getButtons()[0].setVisible(false);t.ValueHelpForService.getButtons()[1].setVisible(true);t.ValueHelpForService.getButtons()[1].setEnabled(true);this.hanldeNextStep()}break}},fileuploadmeasuresanddimensionsForMeasuretree:function(e,a){var i=this;var s=this.ValueHelpForService.getContent()[1];if(i.updateFlag===true){i.viewName=s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].getValue()}if(this.fileUploaded===false){var n=s.getItems()[2].getContent()[0].getItems()[0].getItems()[0].getContent()[5].getValue();var r="Views.xsjs?ViewName="+this.SelectedUrl.split("=")[0].split("&")[0]+""+"&aggregate=true&select="+e.join()+"&$format=json";var o="true"}else{o="true";if(this.mArray.length>0&&this.dArray.length===0){r="FileUploader.xsjs?aggregate=true&FileName="+a+"&selectM="+this.mArray.join()}else if(this.mArray.length===0&&this.dArray.length>0){r="FileUploader.xsjs?aggregate=true&FileName="+a+"&selectD="+this.dArray.join()}else{r="FileUploader.xsjs?aggregate=true&FileName="+a+"&selectM="+this.mArray.join()+"&selectD="+this.dArray.join()}}t.callService("FileSelectedModel","FileSelectedModel",r,"scenario",true,n,function(e){var t=sap.ui.getCore().getModel("FileSelectedModel");i.segmentTable=t.oData.d.results[1];i.segmentTableeditable=t.oData.d.results[1]})},handleinputPress:function(e){var a=this;var i=e.oSource.getValue();var s=e.oSource.mBindingInfos.value.parts[0].path;var n=Object.keys(e.oSource.getBindingContext().getObject());var r="",o="";for(var l=0;l<Object.keys(e.oSource.getBindingContext().getObject()).length;l++){if(Object.values(e.oSource.getBindingContext().getObject())[l].toString().indexOf("All")==-1&&Object.keys(e.oSource.getBindingContext().getObject())[l]!="Parent"&&Object.keys(e.oSource.getBindingContext().getObject())[l]!="expanded"&&Object.keys(e.oSource.getBindingContext().getObject())[l]!="ParentNew"){if(r.length==0){r=Object.keys(e.oSource.getBindingContext().getObject())[l]}else{r+=","+Object.keys(e.oSource.getBindingContext().getObject())[l]}if(typeof Object.values(e.oSource.getBindingContext().getObject())[l]=="string"&&Object.values(e.oSource.getBindingContext().getObject())[l]!=i&&Object.keys(e.oSource.getBindingContext().getObject())[l]!="ParentNew"&&Object.keys(e.oSource.getBindingContext().getObject())[l]!="Parent"){if(o.length==0){o=Object.keys(e.oSource.getBindingContext().getObject())[l]+" eq "+Object.values(e.oSource.getBindingContext().getObject())[l]}else{o=o+" and "+Object.keys(e.oSource.getBindingContext().getObject())[l]+" eq "+Object.values(e.oSource.getBindingContext().getObject())[l]}}}}var d="Disaggregation.xsjs?variantID="+this.variantObject.VariantId+"&select="+r+"&target="+a.selectedscenarioInfo.Entity+"&filter="+o+"&column1="+s+"&value="+i;t.callService("TableUpdateModel","TableUpdateModel",d,"scenario",true,"",function(e,t){var a=sap.ui.getCore().getModel("TableUpdateModel")})},onExistingVariantPress:function(e){var a=this;a.selectvariant=e.mParameters.listItem.getBindingContext().getObject();a.dialog=new sap.m.Dialog({title:"Confirm",type:"Message",content:[new sap.m.Label({text:"Are you sure you want to create shared variant?",labelFor:"Scenario Name"}),new sap.m.Input({value:e.mParameters.listItem.getTitle(),width:"100%"}),new sap.m.Label({text:"Share: "}),new sap.m.CheckBox({})],beginButton:new sap.m.Button({text:"Save",press:function(){var e={VariantId:JSON.stringify(Math.round(Math.random()*1e6)),VariantName:a.dialog.getContent()[1].getValue(),ScenId:a.variantObject.ScenId,SegmentTree:a.selectvariant.SegmentTree,SegmentSelection:a.selectvariant.SegmentSelection,MeasureTree:a.selectvariant.MeasureTree,HiddenNodes:a.selectvariant.HiddenNodes,Filter:"DTREE"};t.callCreateService("Variants.xsjs?&RoleFlag="+a.dialog.getContent()[3].getSelected(),JSON.stringify(e),"","POST",function(e,t,i){a.dialog.close();a.valueHelpForVariant.close();a.getView().setBusy(false);a.variantObject=e.oData;a.selectedVariant=e.oData.VariantName;a.getView().byId("variantItems").getModel().oData.push(e.oData);a.getView().byId("variantItems").getModel().updateBindings(true);var s=a.getView().byId("variantItems").getItems().length-1;a.getView().byId("variantItems").setSelectedItem(a.getView().byId("variantItems").getItems()[s].sId);if(a.getView().byId("variantItems").getModel().oData.length==1){a.getView().byId("variantDelId").setVisible(false)}else{a.getView().byId("variantDelId").setVisible(true)}a.valueHelpForVariant.getContent()[1].getContent()[1].setValue();a.valueHelpForVariant.getContent()[1].getContent()[3].setSelected(false);a.variantObject.VariantId=e.oData.VariantId;if(a.variantObject.SegmentSelection.includes("'")){a.getView().byId("segments").setText("Segments : "+that.variantObject.SegmentSelection)}else{a.getView().byId("segments").setText("Segments : All")}if(a.variantObject.HiddenNodes){a.hiddenNodes=JSON.parse(a.variantObject.HiddenNodes)}else{a.hiddenNodes=[]}a.loadDataToTreeForScenario(a.scenarioInfo,a.varianceInfo)});a.dialog.close()}}),endButton:new sap.m.Button({text:"Cancel",press:function(){a.dialog.close()}})});a.dialog.open()},onTableColumnDataTypeChanged:function(e){if(e.getSource().getSelectedKey()=="String"){e.getSource().getBindingContext().getObject().TYPE="DIMENSION"}else{e.getSource().getBindingContext().getObject().TYPE="MEASURE"}}})});