var d3plus={};d3plus.textwrap=function(){var t=false;var e=false;var r;var n;var a;var i;var s;var o="center";var l=0;var c;var f=null;var u;var d;var v=null;function p(t,e){var r=[];var n=d3.select("body").append("svg");var a=n.append("text").selectAll("tspan").data(t.words).enter().append("tspan").attr("left","0px").attr("position","absolute").attr("top","0px").attr("x",0).attr("y",0).style("font-size",e+"px").text(function(t){return t}).each(function(t){var e=this.getComputedTextLength();var n=this.offsetHeight||this.getBoundingClientRect().height||this.parentNode.getBBox().height;var a=d3.select(this).selectAll("tspan");if(a.size()){alert("didn't expect to get here")}return r.push({height:n,width:e,text:t})});a.remove();n.remove();return r}function g(e){e.container.x=n||parseFloat(e.element.attr("x"),10)||0;e.container.y=a||parseFloat(e.element.attr("y"),10)||0;if(e.shape==="rect"){var r=parseFloat(e.container.attr("x"),10)||0;var o=parseFloat(e.container.attr("y"),10)||0;var h=parseFloat(e.container.attr("width")||e.container.style("width"),10);var f=parseFloat(e.container.attr("height")||e.container.style("height"),10);var u=Math.abs(r-e.container.x)}else if(e.shape==="circle"){var r=parseFloat(e.container.attr("cx"),10)||0;var o=parseFloat(e.container.attr("cy"),10)||0;var u=Math.abs(r-e.container.x);var d=parseFloat(e.container.attr("r"),10)||0;var h=d*2;var f=h;r-=d;o-=d}e.x=n||r;e.y=a||o;e.padding=v||u;e.height=s||f;e.width=i||h;e.innerHeight=e.height-2*v;e.innerWidth=e.width-2*v;e.rotate=l;e.fontSize=parseFloat(e.element.attr("font-size")||e.element.style("font-size"),10);e.container.dy=parseFloat(e.element.attr("dy"),10);e.size=c||t?[4,80]:[e.fontSize/2,e.fontSize];if(v){e.container.x=r+v;e.container.y=o+v}}function x(t){for(var e=0;e<t.words.length-1;e++){t.words[e]=t.words[e]+" "}var r=Math.floor(t.size[1]);var n=t.shape==="circle"?t.width*.75:t.width;var a=p(t,r);var i=d3.max(a,function(t){return t.width});var s=1.165+t.width/t.height*.11;var o=d3.sum(a,function(e){h=t.dy||r*1.2;return e.width*h})*s;if(t.shape==="circle"){var l=Math.PI*Math.pow(t.width/2,2)}else{var l=n*t.height}if(i>n||o>l){var c=Math.sqrt(l/o);var f=n/i;var u=d3.min([c,f]);var r=d3.max([t.size[0],Math.floor(r*u)])}var d=Math.floor(t.height*.8);if(r>d){r=d}if(i*(r/t.size[1])<=n){if(r!==t.size[1]){t.size=[t.size[0],r]}m(t)}else{}}function m(e){var r;var n=f||"top";var a;var i=0;var s=t?e.size[1]:e.fontSize||e.size[0];var o=e.container.dy||s*1.1;var l=e.container.x;var r=e.container.dx||0;var c=e.innerHeight;var u=e.innerWidth;var d;var v=false;var p=function(t,n){if(!t){t=""}return e.element.append("tspan").attr("x",l+"px").attr("dx",r+"px").attr("dy",o+"px").style("baseline-shift","0%").attr("dominant-baseline","alphabetic").text(t)};if(e.shape==="circle"){a="middle";if(n==="middle"){i=c/o%1*o/2}else if(n==="end"){i=c/o%1*o}}else{a=e.align||e.container.align||"start"}e.element.attr("text-anchor",a).attr("font-size",s+"px").style("font-size",s+"px").attr("x",e.container.x).attr("y",e.container.y);switch(a){case"middle":r=e.width/2;break;case"end":r=e.width;break;default:r=0;break}e.container.attr("text-anchor",a).attr("font-size",s+"px").attr("x",e.container.x).attr("y",e.container.y);truncate=function(){d.remove();if(v){x++;d=e.container.select("tspan")}else{x--;d=d3.select(e.container.node().lastChild)}if(!d.empty()){words=d.text().match(/[^\s-]+-?/g);return ellipsis()}};lineWidth=function(){var t;if(e.shape==="circle"){t=(x-1)*o+i;if(t>c/2){t+=o}return 2*Math.sqrt(t*(2*(u/2)-t))}else{return u}};ellipsis=function(){var t,r;if(words&&words.length){r=words.pop();t=r.charAt(r.length-1);if(r.length===1&&e.text.split.value.indexOf(r)>=0){return ellipsis()}else{if(e.text.split.value.indexOf(t)>=0){r=r.substr(0,r.length-1)}d.text(words.join(" ")+" "+r+"...");if(d.node().getComputedTextLength()>lineWidth()){return ellipsis()}}}else{return truncate()}};placeWord=function(t){var r,n,a;r=d.text();if(v){a=e.text.charAt(e.text.length-progress.length-1);n=a===" "?" ":"";progress=t+n+progress;d.text(t+n+r)}else{a=e.text.charAt(progress.length);n=a===" "?" ":"";progress+=n+t;d.text(r+n+t)}if(d.node().getComputedTextLength()>lineWidth()){d.text(r);d=p(t);if(v){return x--}else{return x++}}};var g=1;var x=null;var m=null;var w=function(){e.container.selectAll("tspan").remove();e.container.html("");var t=null;var r=e.words.slice(0);progress=r[0];d=p(r.shift(),true);x=g;var n=r.length;for(var a=0;a<n;a++){t=r[a];if(x*o>c){truncate();break}placeWord(t);var i=true;while(i){var s=e.text.charAt(progress.length+1);i=["-","/",";",":","&"].indexOf(s)>=0;if(i){placeWord(s)}}}if(x*o>c){truncate()}return m=Math.abs(x-g)+1};w();m=x;if(e.shape.value==="circle"){space=c-m*o;if(space>o){if(valign==="middle"){g=(space/o/2>>0)+1;w()}else if(valign==="bottom"){v=true;g=c/o>>0;w()}}}if(n==="top"){y=0}else{h=m*o;y=n==="middle"?c/2-h/2:c-h}y-=o*.2;translate="translate(0,"+y+")";if(e.rotate===180||e.rotate===-180){rx=e.container.x+u/2;ry=e.container.y+c/2}else{rmod=e.rotate<0?u:c;rx=e.container.x+rmod/2;ry=e.container.y+rmod/2}rotate="rotate("+e.rotate+", "+rx+", "+ry+")";return e.container.attr("transform",rotate+translate)}this.draw=function(){if(!r)return this;r.each(function(e){var r={};r.element=d3.select(this);var o=r.element.node().previousElementSibling;r.shape=o?o.tagName.toLowerCase():"";r.container=d3.select(o);g(r);var l=/[^\s\-\/\;\:\&]+\-?\/?\;?\:?\&?/g;r.text=r.element.text();r.words=r.text.match(l);r.element.html("");if(t){x(r)}else{m(r)}if(r.size[0]<=r.innerHeight){}return;d3.select("svg").append("rect").attr({x:n,y:a,width:i,height:s}).style("stroke","red").style("fill","none");(function(){var t=element.text().split(" ");var e=[];for(var r=0;r<t.length;r++){e.push(t[r]+(r===t.length?"":" "))}size();if(c[0]<=u){t();wrap()}})();console.log(n,a,i,s)});return this};this.align=function(t){if(!arguments.length)return o;switch(t){case"center":t="middle";break;case"right":t="end";break;case"left":t="start";break}o=t;return this};this.config=function(h){if(!arguments.length)return{alignment:o,container:r,resize:t,rotate:l,fontSizeRange:_fontSizeRange,valign:f,height:s,width:i,padding:v,x:n,y:a,wrap:e};for(var c in h){if(h.hasOwnProperty(c)){if(this[c]){this[c](h[c])}}}return this};this.container=function(t){if(!arguments.length)return r;r=t;return this};this.height=function(t){if(!arguments.length)return s;s=t;return this};this.padding=function(t){if(!arguments.length)return v;v=t;return this};this.resize=function(e){if(!arguments.length)return t;t=e;return this};this.wrap=function(t){if(!arguments.length)return e;e=t;return this};this.rotate=function(t){if(!arguments.length)return l;l=t;return this};this.fontSizeRange=function(t){if(!arguments.length)return _fontSizeRange;_fontSizeRange=t;return this};this.valign=function(t){if(!arguments.length)return f;f=t;return this};this.width=function(t){if(!arguments.length)return i;i=t;return this};this.x=function(t){if(!arguments.length)return n;n=t;return this};this.y=function(t){if(!arguments.length)return a;a=t;return this};return this};