sap.ui.define(["Brevo/BrevoDtree/util/Formatter"],function(e){"use strict";return{drawMeasureTree:function(t){var r=t;var n="#"+t.getView().byId("chartArea").sId;if(r.OmeasureModel!=undefined){t.treeData=r.OmeasureModel.oData}try{if(t.variantObject.MeasureTree.length>0)t.treeData=JSON.parse(t.variantObject.MeasureTree)}catch(e){}var a=40;var i=$(n).width();var s=window.innerHeight;var l=0,o=450,d,c;var u=d3.layout.tree().size([s,i]).separation(function(e,t){return e.parent==t.parent?1:2});var f=d3.scale.linear().domain([1,100]).range([1,100]).clamp(true);var g=d3.scale.ordinal();var m=d3.svg.diagonal().projection(function(e){return[e.y,e.x]});var h=d3.layout.pie().value(function(e){if(isNaN(parseFloat(e)))return 0;else return parseFloat(e)}).sort(null);var p=d3.svg.arc().outerRadius(40).innerRadius(20);d3.select(n).select("svg").remove();r.zoomListener=d3.behavior.zoom().scaleExtent([.1,3]).on("zoom",function(e){y(e)});var v=d3.select(n).append("svg").attr("width",i).attr("height",s).attr("class","tooltip").call(r.zoomListener);function y(e){if(r.hMode)x.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")rotate(90,50,50)");else x.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}var x=v.append("g").attr("transform",function(){if(r.hMode)return"translate("+i/2+","+s/2/2+") rotate(90,50,50)";else return"translate("+s/2+","+-i/2+")"});d=t.treeData;d.x0=s/2;d.y0=0;var I=d3.select("body").append("div").attr("class","tooltip").style("opacity","0");function b(e){if(e.children){e._children=e.children;e._children.forEach(b);e.children=null}}function w(e){var t=e.children?e.children:e._children;if(e._children){e.children=e._children;e._children=null}if(t)t.forEach(w)}t.expandTree?w(d):d.children?d.children.forEach(b):d._children.forEach(b);_(d);D(d);var k=35;var S=v.append("svg:defs");S.append("svg:pattern").attr("id","image").attr("width","15").attr("height","15").append("svg:image").attr("xlink:href",jQuery.sap.getModulePath("Brevo.BrevoDtree")+"/images/Settings.png").attr("width","15").attr("height","15").attr("x",0).attr("y",0);var V=v.append("svg:defs");V.append("svg:pattern").attr("id","editImage").attr("width","15").attr("height","15").append("svg:image").attr("xlink:href",jQuery.sap.getModulePath("Brevo.BrevoDtree")+"/images/edit.png").attr("width","15").attr("height","15").attr("x",0).attr("y",0);var M=v.append("svg:defs");M.append("svg:pattern").attr("id","commentImage").attr("width","15").attr("height","15").append("svg:image").attr("xlink:href",jQuery.sap.getModulePath("Brevo.BrevoDtree")+"/images/Comment.png").attr("width","15").attr("height","15").attr("x",0).attr("y",0);var O=v.append("svg:defs");O.append("svg:text").attr("id","commentnum").attr("width","15").attr("height","15").attr("x",10).attr("y",0);function _(t){var n=[1];var a=function(e,t){if(t.children&&t.children.length>0){if(n.length<=e+1)n.push(0);n[e+1]+=t.children.length;t.children.forEach(function(t){a(e+1,t)})}};a(0,d);var i=r.hMode?d3.max(n)*25:d3.max(n)*163.6;u=u.nodeSize([250,window.innerHeight]);r.hx=n[2]?n[1]==n[2]?i/1.75:i/1.5:n[1]>20?i/1.75:i/1.5;var s=u.nodes(d).reverse(),f=u.links(s);s.forEach(function(e){r.hMode?e.y=e.depth*180:e.y=e.depth*280});var g=x.selectAll("g.node").data(s,function(e){return e.id||(e.id=++l)});var v=g.enter().append("g").attr("id",function(e){return"id"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.value_org)}).attr("class","node").attr("transform",function(e){if(r.hMode)return"translate("+t.y0+","+t.x0+") rotate(-90)";else return"translate("+t.y0+","+t.x0+") rotate(0)"}).on("mouseover",function(e){b(e)}).on("mousemove",function(e){w(e)}).on("mouseout",function(e){k(e)}).on("mousedown",function(){c=new Date}).on("mouseup",function(e){var t=new Date;r.duration=t-c;if(t-c>2e3){}});v.append("rect").attr("id",function(e){return"rt"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.value_org)}).attr("width","130px").attr("transform","translate(48,-37)").attr("height","75px").attr("rx","15").attr("ry","15").style("fill",function(e){var t="rgba(77, 166, 77, 0.5)";var n="rgba(221, 58, 66, 0.53)";var a="rgba(255, 255, 255, 0.22)";var i=parseFloat(e.value)-parseFloat(e.value_org);if(i>0||i<0){r.dragged=true;return i>0?t:n}else return a}).style("opacity","0.9").style("stroke",function(e){var t=parseFloat(e.value)-parseFloat(e.value_org);if(t>0||t<0){r.dragged=true;return t>0?"green":"red"}else return"white"}).style("stroke-width","0");v.append("rect").attr("id","settingsButton").attr("width","15px").attr("transform","translate(180,-35)").attr("rx","5").attr("ry","5").attr("height","15px").style("fill","url(#image)").on("click",function(e){if(e.isHidden===false){var t=sap.ui.core.UIComponent.getRouterFor(r);t.navTo("nodeSettings");var n=sap.ui.getCore().getEventBus();n.publish("treeData","settings",{node:e,scenario:r.scenarioInfo,varianceInfo:r.varianceInfo,variant:r.variantObject})}});v.append("text").attr("id","addButton").attr("width","15px").attr("transform","translate(180,0)").style("font","25px sans-serif").attr("height","15px").text("+").on("click",function(e){if(e.isHidden===false){r.addNode(e)}});v.append("rect").attr("id","editButton").attr("width","15px").attr("transform","translate(180,2)").attr("rx","5").attr("ry","5").attr("height","18px").style("fill","url(#editImage)").on("click",function(e){if(e.isHidden===false){r.onDeletePress();$("svg")[0].style.width=parseInt(window.innerWidth/100*73);r.getView().byId("nodeSettings").setVisible(true);r.getView().byId("vdt").setWidth("75%");r.nodeSettings(e);r.setImpactMeasuresValues(e)}});v.append("rect").attr("id",function(e){return"cmt"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.value_org)}).attr("width","25px").attr("transform","translate(180,20)").attr("rx","5").attr("ry","5").style("font","35px sans-serif").attr("height","15px").style("fill","url(#commentImage)").on("click",function(e){if(e.isHidden===false){$("svg")[0].style.width=parseInt(window.innerWidth/100*73);r.getView().byId("nodeSettings").setVisible(true);r.getView().byId("vdt").setWidth("100%");r.addComment(e)}});v.append("text").attr("id",function(e){return"Mc"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.value_org)}).attr("transform","translate(195,25)").attr("rx","55").attr("ry","5").text(function(e){if(e.nodecomments.length){return e.nodecomments.length-1}}).style("font","10px sans-serif");v.append("circle").attr("r","40").on("click",E);v.append("text").attr("id",function(e){return"ct"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.value)}).attr("x","-8").text(function(t){return e.amountToMillions(t.value)}).on("click",E);v.append("text").attr("id","nodeSettings").attr("transform","translate(60,-25)").text(function(e){var t=e.title;if(e.title.toString().length>15)t=e.title.slice(0,15)+"...";if(e.id=="NODE1")return e.name.toString().length>15?e.name.toString().slice(0,15)+"...":e.name;else return t}).style("fill","rgb(0, 0, 0)");v.append("text").attr("transform","translate(55,-10)").text(function(t){return"Org Value : "+e.amountToMillions(t.value_org)}).style("fill","ligtgrey");v.append("text").style("fill","ligtgrey").attr("id",function(e){return"cv"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.value_org)}).attr("transform","translate(55,5)").text(function(t){return"Current Value : "+e.amountToMillions(t.value)});v.append("text").attr("id",function(e){return"dv"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.value_org)}).attr("transform","translate(55,20)").text(function(t){return"Difference  "+e.amountToMillions(parseFloat(t.difference))}).style("fill",function(e){var t=parseFloat(e.value)-parseFloat(e.value_org);if(t>0)return"green";else if(t<0)return"red";else return"lightgrey"});v.append("g").attr("class","slicers");v.append("g").attr("class","lines");var y=v.select(".slicers").selectAll("path").data(function(e,t){if(e.id=="NODE1"||e.value==e.parent.value){var r=0}else{var r=e.parent.value}r=r==0?1:r;return h([e.value,e.value_org,e.difference])}).enter().append("svg:path").attr("class","slice").attr("fill",function(e,t){if(t==1){if(e.data<0){var r=["#427cac","#a1bed6","red"];return r[t]}else{var r=["#427cac","#a1bed6","green"];return r[t]}}else{if(e.data<0){var r=["#427cac","#a1bed6","red"];return r[t]}else{var r=["#427cac","#a1bed6","green"];return r[t]}}}).each(function(e){e}).attr("d",p);function b(e){I.transition().duration(500).style("opacity",.9).style("display","block")}function w(e){var t=e.name.length>13?e.name.slice("0","13"):e.name;I.html("<b>"+e.title+"</b><table>"+"<tr><td>"+t+":</td><td>"+parseFloat(e.value).toFixed(1)+"</td></tr></table>").style("left",d3.event.pageX+50+"px").style("top",d3.event.pageY+0+"px")}function k(e){I.transition().duration(500).style("display","none")}var S=g.transition().duration(o).attr("transform",function(e){if(r.hMode)return"translate("+e.y+","+e.x+") rotate(-90)";else return"translate("+e.y+","+e.x+") rotate(0)"});S.select("circle");S.select("text");S.select("rect");S.select("foreignObject");var V=g.exit().transition().duration(o).attr("transform",function(e){if(r.hMode)return"translate("+t.y+","+t.x+") rotate(-90)";else return"translate("+t.y+","+t.x+") rotate(0)"}).remove();V.select("circle");V.select("text");V.select("rect");V.select("foreignObject");var M=x.selectAll("path.link").data(f,function(e){return e.target.id});M.enter().insert("path","g").attr("class","link").attr("stroke",function(e){var t=parseFloat(e.target.value_org);var n=parseFloat(e.target.value);var a=n-t;return r.simulate?a==0?"#e4e0e0":a<0?"#e22d2d":"#1de01d":"#e4e0e0"}).style("stroke",function(e){var t=parseFloat(e.target.value_org);var n=parseFloat(e.target.value);var a=n-t;return r.simulate?a==0?"#e4e0e0":a<0?"#e22d2d":"#1de01d":"#e4e0e0"}).attr("d",function(e){var r={x:t.x0,y:t.y0};return m({source:r,target:r})});M.transition().duration(o).attr("d",m);M.exit().transition().duration(o).attr("d",function(e){var r={x:t.x,y:t.y+100};return m({source:r,target:r})}).remove();s.forEach(function(e){e.x0=e.x;e.y0=e.y})}function D(e){var t=r.zoomListener.scale();var n=-e.y0;var a=-e.x0;if(r.hMode){d3.select("g").transition().duration(1).attr("transform","translate("+r.hx+","+s/2/2+")scale("+t+")rotate(90,50,50)");r.zoomListener.translate([r.hx,s/2/2])}else{d3.select("g").transition().duration(1).attr("transform","translate("+s/2+","+-r.hx/2+")scale("+t+")");r.zoomListener.translate([s/2,-r.hx/2])}r.zoomListener.scale(t)}function E(e){if(e.children){e._children=e.children;e.children=null;D(e)}else{e.children=e._children;e._children=null}_(e)}r.ValueHelpForService.close();$("svg")[0].style.width=window.innerWidth;r.getView().byId("vdt").setWidth("100%");r.getView().byId("nodeSettings").setVisible(false)},drawSegmentTree:function(t){t.getView().byId("floaterSettingsVisibility").setVisible(false);t.getView().byId("vdtVisualise").setVisible(true);var r=t;var n="#"+t.getView().byId("chartArea").sId;if(t.Existing)t.segmentTreeData=t.OsegmentModel.oData;else t.segmentTreeData=t.segmentTreeData;try{if(t.variantObject.SegmentTree.length>0){t.segmentTreeData=JSON.parse(t.variantObject.SegmentTree)}}catch(e){}var a=$(n).width();var i=window.innerHeight;var s=0,l=450,o;var d=d3.layout.tree().size([i,a]).separation(function(e,t){return e.parent==t.parent?1:2});var c=d3.svg.diagonal().projection(function(e){return[e.y,e.x]});d3.select(n).select("svg").remove();r.zoomListener=d3.behavior.zoom().scaleExtent([.1,3]).on("zoom",function(e){f(e)});var u=d3.select(n).append("svg").attr("width",a).attr("height",i).attr("class","tooltip").call(r.zoomListener);function f(e){if(r.hMode)g.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")rotate(90,50,50)");else g.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}var g=u.append("g").attr("transform",function(){if(r.hMode)return"translate("+a/2+","+i/2/2+") rotate(90,50,50)";else return"translate("+i/2+","+-a/2+")"});o=t.segmentTreeData;o.x0=i/2;o.y0=0;var m=d3.select("body").append("div").attr("class","tooltip").style("opacity","0");function h(e){if(e.children){e._children=e.children;e._children.forEach(h);e.children=null}}function p(e){var t=e.children?e.children:e._children;if(e._children){e.children=e._children;e._children=null}if(t)t.forEach(p)}t.expandTree?p(o):o.children?o.children.forEach(h):o._children.forEach(h);v(o);y(o);function v(t){var n=[1];var a=function(e,t){if(t.children&&t.children.length>0){if(n.length<=e+1)n.push(0);n[e+1]+=t.children.length;t.children.forEach(function(t){a(e+1,t)})}};a(0,o);var i=r.hMode?d3.max(n)*25:d3.max(n)*163.6;d=d.nodeSize([200,window.innerHeight]);r.hx=n[2]?n[1]==n[2]?i/1.75:i/1.5:n[1]>20?i/1.75:i/1.5;var u=d.nodes(o).reverse(),f=d.links(u);u.forEach(function(e){r.hMode?e.y=e.depth*180:e.y=e.depth*280});var m=g.selectAll("g.node").data(u,function(e){return e.id||(e.id=++s)});var h=m.enter().append("g").attr("id",function(e){return"id"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.Value)}).attr("class","node").attr("transform",function(e){if(r.hMode)return"translate("+t.y0+","+t.x0+") rotate(-90)";else return"translate("+t.y0+","+t.x0+") rotate(0)"});h.append("rect").attr("id",function(e){return"st"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.id)}).attr("width","195px").attr("transform","translate(-87,-37)").attr("height","70px").attr("rx","15").attr("ry","15").style("fill",function(t){if(t.selected)return"darkorange";else if(t.impact!=undefined){return e.setRectanglecolor(t.impact)}return"bisque"}).style("opacity","0.9").style("stroke",function(e){if(e.selected){var t="No Item";if(r.segmentsSelected.indexOf(e.id)==-1)r.segmentsSelected.push(e.id);for(var n=0;n<r.segmentItems.length;n++){if(e.dtitle===r.segmentItems[n].title){t=n;break}}if(e.id!="NODE1"){if(t==="No Item")r.segmentItems.unshift({title:e.dtitle,items:[e.title]});else{if(r.segmentItems[t].items.indexOf(e.title)===-1)r.segmentItems[t].items.push(e.title)}}return"darkslateblue"}else return"darkslateblue"}).style("stroke-width","2").on("click",function(t){if(this.style.fill!="darkorange"){this.style.fill="darkorange";this.style.stroke="#ea8326";t.selected=true;var n=t.parent;while(n!=null){var a="No Item";var i="st"+n.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(n.id);$("#"+i).css("fill","darkorange");$("#"+i).css("stroke","darkslateblue");if(r.segmentsSelected.indexOf(n.id)==-1)r.segmentsSelected.push(n.id);for(var s=0;s<r.segmentItems.length;s++){if(n.dtitle===r.segmentItems[s].title){a=s;break}}if(n.id!="NODE1"){if(a==="No Item")r.segmentItems.push({title:n.dtitle,items:[n.title]});else{if(r.segmentItems[a].items.indexOf(n.title)===-1)r.segmentItems[a].items.push(n.title)}}n.selected=true;n=n.parent}r.segmentsSelected.push(t.id);var a="No Item";for(var s=0;s<r.segmentItems.length;s++){if(t.dtitle===r.segmentItems[s].title){a=s;break}}if(a==="No Item")r.segmentItems.push({title:t.dtitle,items:[t.title]});else{if(r.segmentItems[a].items.indexOf(t.title)===-1)r.segmentItems[a].items.push(t.title)}r.getView().byId("vdtVisualise").setVisible(true)}else{var l=this;o(t);function o(t){if(t.hasOwnProperty("id")){var n=[t["id"]];if(r.segmentsSelected.includes(n[0])){var a="st"+t.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(t.id);if(t.impact!=undefined){$("#"+a).css("fill",e.setRectanglecolor(t.impact))}else{$("#"+a).css("fill","bisque")}$("#"+a).css("stroke","darkslateblue");for(var i=r.segmentItems.length-1;i>=0;i--){if(r.segmentItems[i].title==t.dtitle){for(var s=r.segmentItems[i].items.length-1;s>=0;s--){if(r.segmentItems[i].items[s]==t.title){r.segmentItems[i].items.splice(s,1)}}if(r.segmentItems[i].items.length==0)r.segmentItems.splice(i,1)}}t.selected=false}}if(t.hasOwnProperty("children")){if(t["children"].length>0){for(var l=0;l<t["children"].length;l++){o(t["children"][l])}}else{return}}else{return}}if(r.segmentsSelected.length==0)r.getView().byId("vdtVisualise").setVisible(false)}});h.append("text").attr("id",function(e){return"st"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.id)}).attr("transform","translate(15,-20)").on("click",x).text(function(e){return e.dtitle}).attr("class","textAlign").style("fill",function(e){if(e.selected)return"orange";else return"lightsteelblue"}).style("opacity","0.9").style("stroke-width","2");h.append("text").attr("id",function(e){return"st"+e.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(e.id)}).on("click",x).attr("transform","translate(-12,-5)").text(function(e){return e.title.toString().length>20?e.title.toString().slice(0,15)+"..":e.title});h.append("text").attr("transform","translate(10,12)").text(function(t){if(t.percentvalue!=undefined){return t.percentvalue.toFixed(2)+"%"}else{return e.amountToMillions(t.Value)}}).style("font","13px sans-serif").style("text-anchor","middle");h.append("g").attr("class","lines");var p=m.transition().duration(l).attr("transform",function(e){if(r.hMode)return"translate("+e.y+","+e.x+") rotate(-90)";else return"translate("+e.y+","+e.x+") rotate(0)"});p.select("text");p.select("rect");p.select("foreignObject");var v=m.exit().transition().duration(l).attr("transform",function(e){if(r.hMode)return"translate("+t.y+","+t.x+") rotate(-90)";else return"translate("+t.y+","+t.x+") rotate(0)"}).remove();v.select("text");v.select("rect");v.select("foreignObject");var y=g.selectAll("path.link").data(f,function(e){return e.target.id});y.enter().insert("path","g").attr("class","link").attr("stroke","#e4e0e0").style("stroke","#e4e0e0").attr("d",function(e){var r={x:t.x0,y:t.y0};return c({source:r,target:r})});y.transition().duration(l).attr("d",c);y.exit().transition().duration(l).attr("d",function(e){var r={x:t.x,y:t.y+100};return c({source:r,target:r})}).remove();u.forEach(function(e){e.x0=e.x;e.y0=e.y})}function y(e){var t=r.zoomListener.scale();var n=-e.y0;var a=-e.x0;if(r.hMode){d3.select("g").transition().duration(1).attr("transform","translate("+r.hx+","+i/2/2+")scale("+t+")rotate(90,50,50)");r.zoomListener.translate([r.hx,i/2/2])}else{d3.select("g").transition().duration(1).attr("transform","translate("+i/2+","+-r.hx/2+")scale("+t+")");r.zoomListener.translate([i/2,-r.hx/2])}r.zoomListener.scale(t)}function x(t){if(this.textLength!==undefined){var n=this.id;var a=document.getElementsByTagName("rect");for(var i=0;i<a.length;i++){if(n==a[i].id){var s=a[i];if(s.style.fill!="darkorange"){s.style.fill="darkorange";s.style.stroke="#ea8326";t.selected=true;var l=t.parent;while(l!=null){var o="No Item";var d="st"+l.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(l.id);$("#"+d).css("fill","darkorange");$("#"+d).css("stroke","darkslateblue");if(r.segmentsSelected.indexOf(l.id)==-1)r.segmentsSelected.push(l.id);for(var i=0;i<r.segmentItems.length;i++){if(l.dtitle===r.segmentItems[i].title){o=i;break}}if(l.id!="NODE1"){if(o==="No Item")r.segmentItems.push({title:l.dtitle,items:[l.title]});else{if(r.segmentItems[o].items.indexOf(l.title)===-1)r.segmentItems[o].items.push(l.title)}}l.selected=true;l=l.parent}r.segmentsSelected.push(t.id);var o="No Item";for(var i=0;i<r.segmentItems.length;i++){if(t.dtitle===r.segmentItems[i].title){o=i;break}}if(o==="No Item")r.segmentItems.push({title:t.dtitle,items:[t.title]});else{if(r.segmentItems[o].items.indexOf(t.title)===-1)r.segmentItems[o].items.push(t.title)}r.getView().byId("vdtVisualise").setVisible(true)}else{var c=this;u(t);function u(t){if(t.hasOwnProperty("id")){var n=[t["id"]];if(r.segmentsSelected.includes(n[0])){var a="st"+t.title.toString().replace(/[^A-Z0-9]+/gi,"")+parseInt(t.id);if(t.impact!=undefined){$("#"+a).css("fill",e.setRectanglecolor(t.impact))}else{$("#"+a).css("fill","bisque")}$("#"+a).css("stroke","darkslateblue");for(var i=r.segmentItems.length-1;i>=0;i--){if(r.segmentItems[i].title==t.dtitle){for(var s=r.segmentItems[i].items.length-1;s>=0;s--){if(r.segmentItems[i].items[s]==t.title){r.segmentItems[i].items.splice(s,1)}}if(r.segmentItems[i].items.length==0)r.segmentItems.splice(i,1)}}t.selected=false}}if(t.hasOwnProperty("children")){if(t["children"].length>0){for(var l=0;l<t["children"].length;l++){u(t["children"][l])}}else{return}}else{return}}if(r.segmentsSelected.length==0)r.getView().byId("vdtVisualise").setVisible(false)}break}}}}r.ValueHelpForService.close()}}});