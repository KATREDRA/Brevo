sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/core/routing/History","Brevo/QueryBuilder/model/Service","Brevo/QueryBuilder/util/Formatter"],function(e,t,a,i,s,r){"use strict";return e.extend("Brevo.QueryBuilder.controller.CreateQuery",{onInit:function(){var e=this;this.formulas=[];this.formulaFlag=false;this.join="";this.queryName="";this.sortItems=[];this.viewId="";this.filterValues=[];this.sColumns=[];this.editMode=false;this.dbName="Brevo";this.filterUrl="";this.viewData="";this.conditions=[];this.tableData=[];this.table1Name="";this.selectedTables=[];this.joinsCount=0;this.joinTablePosition=190;this._wizard=this.byId("createQueryWizard");this._oNavContainer=this.byId("wizardNavContainer");this._oWizardContentPage=this.byId("wizardContentPage");this._oWizardReviewPage=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.ReviewPage",this);e.BusyDialog=new sap.m.BusyDialog;e.tableCount=1;e.addFormulafrag=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.addFormula",e);var t=this.addFormulafrag.getContent()[0].getItems()[1];t.getItems()[0].getItems()[1].onAfterRendering=function(){e.enableAutoComplete()};if(!this.ValueHelpForFilterValues)this.ValueHelpForFilterValues=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.valueHelpForFilters",e);if(!this.valueHelpForSort)this.valueHelpForSort=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.valueHelpForSort",this);if(!e._oPopover){e._oPopover=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.linkingPopOver",e);e.getView().addDependent(e._oPopover)}s.callService("databases","databases","database_list","",true,function(t){var a=sap.ui.getCore().getModel("databases");e.getView().byId("database").setModel(a)});s.callService("Brevo"+"Tables","Brevo"+"Tables","getAllTablesAndViews?db=Brevo","",true,function(t){var a=sap.ui.getCore().getModel("Brevo"+"Tables");e.getView().byId("tables").setModel(a)});var a=sap.ui.getCore().getEventBus();sap.ui.core.UIComponent.getRouterFor(this).getRoute("createQuery").attachPatternMatched(this.onPatternMatched,this);if(!e.createViewDialog){e.createViewDialog=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.createView",e)}if(!e.editViewDialog){e.editViewDialog=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.editView",e)}this.graph=new joint.dia.Graph;this.position=30;this.posCount=0},onPatternMatched:function(e){var t=this;this.editMode=e.getParameter("arguments").isEditMode;var a=e.getParameter("arguments").isWizardDataPresent;t.filterValues=[];t.sColumns=[];t.tableData=[];if(this.editMode!=undefined){if(t.editMode||t.editMode=="true"){t.getView().byId("editorButton").setEnabled(false);t.BusyDialog.open();t.getView().byId("formulaId").setVisible(true);var i=sap.ui.getCore().getModel("queryInfo");var r=i.getData().tables[0].split(".")[0];var o=i.getData().selected_columns;var l=[];var n=[];l=o.split(",");for(var d=0;d<l.length;d++){var g=l[d].includes("as");var u=l[d].includes("(");if(g&&u){n.push(l[d])}}var m=[];var h=[];var p=[];for(var f=0;f<n.length;f++){if(n[f].includes("Quarter(")||n[f].includes("Month(")||n[f].includes("Log(")||n[f].includes("Int(")||n[f].includes("Float(")||n[f].includes("Double(")){var v=n[f].split(" as ");var c=v[0].trim();var b=c.substring(1,c.length-1);h.push(b);p.push(v[1].trim())}else{m=n[f].split("(")[1];h.push(m.split(")")[0]);p.push(m.split(" as ")[1].trim())}}var w=[];for(var V=0;V<h.length;V++){var y={};y["Formula"]=h[V];y["Aliasname"]=p[V];w.push(y)}var D=new sap.ui.model.json.JSONModel(w);t.getView().byId("comboBoxFormulaId").setModel(D);s.callService(r+"TablesonEdit",r+"TablesonEdit","getAllTablesAndViews?db="+r,"",true,function(e){var a=sap.ui.getCore().getModel(r+"TablesonEdit");t.getView().byId("tables").setModel(a);t.onEditMode()})}else{t.getView().byId("editorButton").setEnabled(true)}}else if(a){var C=sap.ui.getCore().getModel("wizardDataModel");t.setDataforOutputView(C.getData())}},onDatabaseChange:function(e){var t=this;var a=e.mParameters.selectedItem.getKey();this.dbName=a;s.callService(a+"Tables",a+"Tables","getAllTablesAndViews?db="+a,"",true,function(e){var i=sap.ui.getCore().getModel(a+"Tables");t.getView().byId("tables").setModel(i);t.selectedTables=[];var s={selectedTables:t.selectedTables};var r=new sap.ui.model.json.JSONModel(s);t.getView().byId("selectedTables").setModel(r)});this.removeContent()},onEditorPress:function(e){var t=this.getView().byId("selectedTables").getModel();if(t){if(t.oData.selectedTables!==undefined&&t.oData.selectedTables.length>0){var a=this.constructPayloadForWizard();var i=sap.ui.core.UIComponent.getRouterFor(this);var r="GetQuery";var o=sap.ui.getCore().getModel("queryInfo");s.callCreateService(r,JSON.stringify(a),"POST",function(e,t,a){if(t){var s=JSON.parse(e);var r=new sap.ui.model.json.JSONModel(s);sap.ui.getCore().setModel(r,"dataQueryModel");i.navTo("sqlEditor",{isQueryPresent:true})}else if(JSON.parse(e).message==="View with this ID already exists"){sap.m.MessageToast.show("Query Name already exists.Please give a different Query Name")}else{sap.m.MessageToast.show("Unable to create view.Try again")}})}else{var i=sap.ui.core.UIComponent.getRouterFor(this);i.navTo("sqlEditor")}}else{var i=sap.ui.core.UIComponent.getRouterFor(this);i.navTo("sqlEditor")}},onEditMode:function(){var e=this;e.tableData=[];this.graph=new joint.dia.Graph;this.position=30;this.posCount=0;this.sColumns=[];var t;var a=sap.ui.getCore().getModel("queryInfo");this.viewData=a.getData();this.conditions=a.getData().conditions;var i=e.getView().byId("database").getItems();var s=a.getData().tables[0].split(".")[0];e.dbName=a.getData().tables[0].split(".")[0];if(a.getData().orderby){var r=a.getData().orderby.split(" ")[1];var o=a.getData().orderby.split(" ")[0];this.sortItems=[{sortOperator:r,selectedSortItem:o}];this.getView().byId("sortById").setValue(o)}else{this.sortItems=[];this.getView().byId("sortById").setValue()}for(var l=0;l<i.length;l++){if(i[l].getBindingContext().getObject().name===s){e.getView().byId("database").setSelectedKey(s)}}e.viewId=a.getData()._id;var n="TableMetadata?db="+s;e.addLinkingItem(e.tableData);var d=e.getView().byId("tables").getItems();var g=a.getData().parent_table.split(".")[1];var u=n+"&table="+g;e.callService(g,true,u);var m=a.getData().tables;var h=[];for(var p=0;p<m.length;p++){var f=m[p].split(".")[1];h.push(f);u=n+"&table="+f;e.callService(f,true,u)}for(l=0;l<d.length;l++){if(d[l].getBindingContext().getObject().TABLE_NAME===g){e.getView().byId("tables").setSelectedItem(d[l])}else{for(var v=0;v<h.length;v++){if(d[l].getBindingContext().getObject().TABLE_NAME===h[v]){e.getView().byId("tables").setSelectedItem(d[l])}}}}var c=e.getView().byId("tables").getSelectedItems();var b=[];for(l=0;l<c.length;l++){if(c[l].getBindingContext().getObject().TABLE_NAME===g){b.push(c[l].getBindingContext().getObject())}}for(v=0;v<h.length;v++){for(l=0;l<c.length;l++){if(c[l].getBindingContext().getObject().TABLE_NAME===h[v]){b.push(c[l].getBindingContext().getObject())}}}e.selectedTables=b;var w={selectedTables:b};var V=new sap.ui.model.json.JSONModel(w);e.getView().byId("selectedTables").setModel(V);e.BusyDialog.close();var y=new sap.ui.model.json.JSONModel(JSON.parse(a.getData().table_config));e.getView().byId("columnSelectionTableId").setModel(y);this._handleNavigationToStep(3);e.setDataforOutputView()},clickNext:function(e){var t=this;var a=this.getView().byId("database").getSelectedKey();var i="TableMetadata?db="+a;try{var s=e.mParameters.listItem.getBindingContext().getObject().TABLE_NAME;var r=e.mParameters.selected}catch(e){var s=""}if(r&&s.length>0){var o=i+"&table="+s;t.callService(s,r,o)}else if(!r){for(var l=0;l<t.tableData.length;l++){if(t.tableData[l].table===s){t.tableData.splice(l,1)}}}var n=this.getView().byId("tables").getSelectedItems();var d=n.length;if(d>=2){this._wizard.validateStep(this.byId("ProductTypeStep"))}else if(d<2){this._wizard.invalidateStep(this.byId("ProductTypeStep"))}if(e){if(e.mParameters.selected===true){t.clickedTable=e.getParameter("listItem").getBindingContext().getObject().TABLE_NAME;this.selectedTables.push(e.mParameters.listItem.getBindingContext().getObject())}else{t.clickedTable=undefined;try{for(var g=0;g<this.selectedTables.length;g++){if(this.selectedTables[g].TABLE_NAME===e.mParameters.listItem.getBindingContext().getObject().TABLE_NAME){this.selectedTables.splice(g,1)}}var u=t.graph.getCells();for(var l=0;l<u.length;l++){if(u[l].attributes.type==="mapping.Record"){if(u[l].attributes.attrs.headerLabel.textWrap.text===s){u[l].remove()}}}var m=[[{id:"value",label:"Output Values"},{id:"value_12",label:""}]];for(var l=0;l<u.length;l++){if(u[l].attributes.type=="mapping.Join"){u[l].remove()}else if(u[l].attributes.type=="mapping.Output"){u[l].set("items",m)}}this.joinsCount=0;this.joinTablePosition=190;if(this.selectedTables.length===0){for(var l=0;l<u.length;l++){u[l].remove();t.posCount=0}}}catch(e){}}}var h={selectedTables:this.selectedTables};var p=new sap.ui.model.json.JSONModel(h);this.getView().byId("selectedTables").setModel(p)},callService:function(e,t,a){var i=this;i.BusyDialog.open();s.callService(e+"tablefields",e+"tablefields",a,"",true,function(a){i.BusyDialog.close();var s=sap.ui.getCore().getModel(e+"tablefields");var r=[],o=[];var l=[],n=[],d=[];for(var g=0;g<s.oData.COLUMN_DET.length;g++){if(s.oData.COLUMN_DET[g].TYPE==="MEASURE"||s.oData.COLUMN_DET[g].DATATYPE=="Date"){o.push({measureObj:s.oData.COLUMN_DET[g]})}else{n.push({dimensionObj:s.oData.COLUMN_DET[g]})}var u={col_datatype:s.oData.COLUMN_DET[g].DATATYPE,datatype:s.oData.COLUMN_DET[g].TYPE,id:s.oData.TABLENAME+s.oData.COLUMN_DET[g].COLUMN_NAME,label:s.oData.COLUMN_DET[g].LABEL,max_length:15,name:s.oData.COLUMN_DET[g].COLUMN_NAME,tablename:s.oData.TABLENAME};d.push(u)}var m={table:s.oData.TABLENAME,measures:s.oData.MEASURES,dimensions:s.oData.DIMENSIONS,measureObject:o,dimensionObject:n,fields:d};if(t&&e===s.oData.TABLENAME){i.tableData.push(m);if(!i.editMode){var h=i.graph.getCells();for(var g=0;g<h.length;g++){if(h[g].attributes.type==="mapping.Record"){if(h[g].attributes.attrs.headerLabel.textWrap.text===e){h[g].remove()}}}var p=new joint.shapes.mapping.Record({attrs:{itemLabels:{fill:"#fe854f",itemHighlight:{fill:"#000000"}}},items:[[{id:m.table,label:"Columns",icon:"images/table.svg",group:"disabled",items:m.fields}]]});var f=m.fields.length*22+400;var v=parseInt(document.getElementById("linkingProperties").style.height);if(f>v){document.getElementById("linkingProperties").style.height=f+"px"}if(i.posCount===0){i.addLinkingItem(i.tableData);i.position=30;var c=new joint.shapes.mapping.Output({attrs:{headerLabel:{cursor:"pointer",magnet:false}},items:[[{id:"value",label:"Output Values"},{id:"value_12",label:""}]]});c.position(1e3,180);c.addTo(i.graph);c.setName("Output Columns");i.posCount=1}else{i.position=i.position+190}var f=m.fields.length*22+400;var v=parseInt(document.getElementById("linkingProperties").style.height);if(f>v){document.getElementById("linkingProperties").style.height=f+"px"}p.setName(m.table);p.position(i.position,300);p.addTo(i.graph)}else if(i.editMode&&i.clickedTable===e){if(i.posCount===0){i.addLinkingItem(i.tableData);i.position=30;var c=new joint.shapes.mapping.Output({attrs:{headerLabel:{cursor:"pointer",magnet:false}},items:[[{id:"value",label:"Output Values"},{id:"value_12",label:""}]]});c.position(1e3,180);c.addTo(i.graph);c.setName("Output Columns");var p=new joint.shapes.mapping.Record({attrs:{itemLabels:{fill:"#fe854f",itemHighlight:{fill:"#000000"}}},items:[[{id:m.table,label:"Columns",icon:"images/table.svg",group:"disabled",items:m.fields}]]});p.setName(m.table);p.position(i.position,300);p.addTo(i.graph);i.posCount=1}else{i.position=i.position+190;var p=new joint.shapes.mapping.Record({attrs:{itemLabels:{fill:"#fe854f",itemHighlight:{fill:"#000000"}}},items:[[{id:m.table,label:"Columns",icon:"images/table.svg",group:"disabled",items:m.fields}]]});p.setName(m.table);p.position(i.position,300);p.addTo(i.graph)}}}else{for(g=0;g<i.tableData.length;g++){if(i.tableData[g].table===e){i.tableData.splice(g,1)}}}})},addLinkingItem:function(e){var t=this;joint.setTheme("material");var a=[{id:"value_1",label:"Value1",group:"headers"},{id:"value3",label:""},{id:"value4",label:""}];var i=[{id:"value_2",label:"Value2",group:"headers"},{id:"value3",label:""},{id:"value4",label:""}];var s=[];s.push(a);s.push(i);var r=false;var o=new joint.dia.Paper({el:document.getElementById("linkingProperties"),model:this.graph,width:"100%",height:1e3,gridSize:10,background:{color:"#f6f6f6"},magnetThreshold:"onleave",moveThreshold:5,clickThreshold:5,linkPinning:false,interactive:{linkMove:false,elementMove:false},markAvailable:true,snapLinks:{radius:40},defaultRouter:{name:"mapping",args:{padding:30}},defaultConnectionPoint:{name:"anchor"},defaultAnchor:{name:"mapping"},defaultConnector:{name:"jumpover",args:{jump:"cubic"}},highlighting:{magnetAvailability:{name:"addClass",options:{className:"record-item-available"}},connecting:{name:"stroke",options:{padding:8,attrs:{stroke:"none",fill:"#7c68fc","fill-opacity":.2}}}},defaultLink:function(){return new joint.shapes.mapping.Link},validateConnection:function(e,t,a,i,s){if(e===a)return false;if(e.model.isLink()||a.model.isLink())return false;if(s==="target")return a.model.getItemSide(a.findAttribute("item-id",i))!=="right";return e.model.getItemSide(e.findAttribute("item-id",t))!=="left"}});o.on("link:mouseenter",function(e){this.removeTools();n(e)});o.on("link:mouseleave",function(e){this.removeTools();if(e.targetMagnet!==undefined&&e.targetMagnet!==null){try{var a=e.targetMagnet.getAttribute("item-id");var i=e.sourceMagnet.getAttribute("item-id");var s=t.graph.getCells();if(e.targetMagnet.getAttribute("item-id")===a){if(e.targetView.model.attributes.type==="mapping.Join"&&e.sourceView.model.attributes.type==="mapping.Join"){for(var r=0;r<s.length;r++){if(s[r].attributes.type==="mapping.Link"){if(e.model!==s[r]){if(s[r].attributes.source.id===e.model.attributes.source.id&&s[r].attributes.target.id===e.model.attributes.target.id){s[r].remove()}}}}var o=[];var l=false;var n=[];for(var r=0;r<e.sourceView.model.attributes.items.length;r++){for(var d=0;d<e.sourceView.model.attributes.items[r].length;d++){if(d==0){delete e.sourceView.model.attributes.items[r][d].group;n.push(e.sourceView.model.attributes.items[r][d])}else{n.push(e.sourceView.model.attributes.items[r][d])}}}var g=e.sourceMagnet.getAttribute("item-id");for(var r=0;r<n.length;r++){if(g===n[r].id){o.push(n[r]);l=true}}if(l){for(d=0;d<n.length;d++){if(n[d].id!==g){o.push(n[d])}}}o[0]["group"]="headers";f=e.targetView.model.attributes.items;f.splice(0,1,o);var u;if(f[0].length>f[1].length){u=f[0].length*22+400}else if(f[1].length>f[0].length){u=f[1].length*22+400}var m=parseInt(document.getElementById("linkingProperties").style.height);if(u>m){document.getElementById("linkingProperties").style.height=u+"px"}e.targetView.model.set("items",f);e.targetView.model.toggleItemHighlight(e.targetView.model.attributes.items[1][0].id)}else if(e.targetView.model.attributes.type==="mapping.Join"){if(e.sourceView.model.attributes.type!=="mapping.Output"){for(var r=0;r<s.length;r++){if(s[r].attributes.type==="mapping.Link"){if(e.model!==s[r]){if(s[r].attributes.source.id===e.model.attributes.source.id&&s[r].attributes.target.id===e.model.attributes.target.id){s[r].remove()}}}}var o=[];var l=false;var h=e.sourceView.model.attributes.items[0][0].id;var g=e.sourceMagnet.getAttribute("item-id");for(var r=0;r<t.tableData.length;r++){if(t.tableData[r].table===h){for(var d=0;d<t.tableData[r].fields.length;d++){if(g===t.tableData[r].fields[d].id){o.push(t.tableData[r].fields[d]);l=true}}}}if(l){var p=e.sourceView.model.attributes.items[0][0].items;for(d=0;d<p.length;d++){if(!e.sourceView.model.isItemHighlighted(p[d].id)){if(p[d].id!==g){o.push(p[d])}}}}o[0]["group"]="headers";f=e.targetView.model.attributes.items;f.splice(0,1,o);var u;if(f[0].length>f[1].length){u=f[0].length*22+400}else if(f[1].length>f[0].length){u=f[1].length*22+400}var m=parseInt(document.getElementById("linkingProperties").style.height);if(u>m){document.getElementById("linkingProperties").style.height=u+"px"}e.targetView.model.set("items",f);e.targetView.model.toggleItemHighlight(e.targetView.model.attributes.items[1][0].id)}else if(e.sourceView.model.attributes.type==="mapping.Output"){e.remove()}}else if(e.targetView.model.attributes.type==="mapping.Output"){if(e.sourceView.model.attributes.type==="mapping.Join"){o=[];l=false;n=[];for(var r=0;r<e.sourceView.model.attributes.items.length;r++){for(var d=0;d<e.sourceView.model.attributes.items[r].length;d++){if(d==0){delete e.sourceView.model.attributes.items[r][d].group;n.push(e.sourceView.model.attributes.items[r][d])}else{n.push(e.sourceView.model.attributes.items[r][d])}}}var g=e.sourceMagnet.getAttribute("item-id");for(var r=0;r<n.length;r++){if(g===n[r].id){o.push(n[r]);l=true}}if(l){for(d=0;d<n.length;d++){if(n[d].id!==g){o.push(n[d])}}}var f=[];f.push(o);var u;u=o.length*22+400;var m=parseInt(document.getElementById("linkingProperties").style.height);if(u>m){document.getElementById("linkingProperties").style.height=u+"px"}e.targetView.model.set("items",f);t.validateStepFour()}else if(e.sourceView.model.attributes.type==="mapping.Record"){e.remove()}}else if(e.sourceView.model.attributes.type==="mapping.Record"&&e.targetView.model.attributes.type==="mapping.Record"){e.remove()}else if(e.sourceView.model.attributes.type==="mapping.Output"){e.remove()}else if(e.sourceMagnet.getAttribute("item-id")===i){if(e.sourceMagnet!==undefined&&e.sourceMagnet!==null){if(e.targetView.model.attributes.type==="mapping.Join"&&e.sourceView.model.attributes.type==="mapping.Join"){o=[];l=false;n=[];for(var r=0;r<e.targetView.model.attributes.items.length;r++){for(var d=0;d<e.targetView.model.attributes.items[r].length;d++){n.push(e.targetView.model.attributes.items[r][d])}}var g=e.sourceMagnet.getAttribute("item-id");for(var r=0;r<n.length;r++){if(g===n[r].id){o.push(n[r]);l=true}}if(l){for(d=0;d<n.length;d++){if(!e.targetView.model.isItemHighlighted(n[d].id)){if(n[d].id!==g){o.push(n[d])}}}}o[0]["group"]="headers";var f=e.sourceView.model.attributes.items;f.splice(1,1,o);var u;if(f[0].length>f[1].length){u=f[0].length*22+400}else if(f[1].length>f[0].length){u=f[1].length*22+400}var m=parseInt(document.getElementById("linkingProperties").style.height);if(u>m){document.getElementById("linkingProperties").style.height=u+"px"}e.sourceView.model.set("items",f)}else if(e.sourceView.model.attributes.type==="mapping.Join"){for(var r=0;r<s.length;r++){if(s[r].attributes.type==="mapping.Link"){if(e.model!==s[r]){if(s[r].attributes.source.id===e.model.attributes.source.id&&s[r].attributes.target.id===e.model.attributes.target.id){s[r].remove()}}}}var o=[];var l=false;var h=e.targetView.model.attributes.items[0][0].id;var g=e.targetMagnet.getAttribute("item-id");for(var r=0;r<t.tableData.length;r++){if(t.tableData[r].table===h){for(var d=0;d<t.tableData[r].fields.length;d++){if(g===t.tableData[r].fields[d].id){o.push(t.tableData[r].fields[d]);l=true}}}}if(l){var p=e.targetView.model.attributes.items[0][0].items;for(d=0;d<p.length;d++){if(!e.targetView.model.isItemHighlighted(p[d].id)){if(p[d].id!==g){o.push(p[d])}}}}o[0]["group"]="headers";var f=e.sourceView.model.attributes.items;f.splice(1,1,o);var u;if(f[0].length>f[1].length){u=f[0].length*22+400}else if(f[1].length>f[0].length){u=f[1].length*22+400}var m=parseInt(document.getElementById("linkingProperties").style.height);if(u>m){document.getElementById("linkingProperties").style.height=u+"px"}e.sourceView.model.set("items",f);e.sourceView.model.toggleItemHighlight(e.sourceView.model.attributes.items[0][0].id)}}}}}catch(e){}}});o.on("element:magnet:pointerdblclick",function(e,t,a){t.stopPropagation();m(e.model,e.findAttribute("item-id",a))});o.on("element:magnet:pointerclick",function(e,a,i){var s=e.model;if(i.textContent==="inner join"||i.textContent==="left join"||i.textContent==="right join"||i.textContent==="full join"){var r=e.model.getItemTools();if(r){a.stopPropagation();g(e.el,e,r)}}else if(i.textContent==="Output Columns"){t._wizard.setCurrentStep(t.byId("Linking"))}else if(s.attributes.type!=="mapping.Join"){var o=e.findAttribute("item-id",i);s.toggleItemHighlight(o)}});o.on("element:contextmenu",function(e,t){var a=e.model.getTools();if(a){t.stopPropagation();u(e.el,e,a)}});o.on("element:pointerclick",function(e){l(e)});o.on("element:pointermove",function(e,t,a,i){var s=t.data;if(s.ghost){s.ghost.attr({x:a-s.dx,y:i-s.dy})}else{var r=e.model.getBBox();var o=V("rect");o.attr(r);o.attr({fill:"transparent",stroke:"#5755a1","stroke-dasharray":"4,4","stroke-width":2});o.appendTo(this.viewport);t.data.ghost=o;t.data.dx=a-r.x;t.data.dy=i-r.y}});o.on("element:pointerup",function(e,t,a,i){var s=t.data;if(s.ghost){s.ghost.remove();e.model.position(a-s.dx,i-s.dy)}});function l(e){var t=e.model;var a=new joint.ui.Halo({cellView:e,handles:[{name:"remove",position:"ne",events:{pointerdown:"removeElement"},attrs:{".handle":{"data-tooltip-class-name":"small","data-tooltip":"Click to remove the object","data-tooltip-position":"right","data-tooltip-padding":15}}}]});if(t.attributes.type==="mapping.Join"){a.render()}var i=new joint.ui.FreeTransform({cellView:e,allowRotation:false});i.render();i.listenTo(t,"change",s);s();function s(){var e=t.getMinimalSize();i.options.minHeight=e.height;i.options.minWidth=e.width}}function n(e){var t=new joint.dia.ToolsView({tools:[new joint.linkTools.mapping.SourceArrowhead,new joint.linkTools.mapping.TargetArrowhead({restrictArea:false}),new joint.linkTools.mapping.Remove({distance:"25%",action:function(){h(this.model)}})]});e.addTools(t)}function d(e,t,a,i){var s=new joint.ui.ContextToolbar({target:e,padding:5,vertical:true,tools:i})}function g(e,t,a){var i=t.model;var s=new joint.ui.ContextToolbar({target:e,padding:5,vertical:true,tools:a});s.render();s.on({"action:on-inner-join":function(){s.remove();i.setName("inner join")},"action:on-full-join":function(){s.remove();i.setName("full join")},"action:on-left-join":function(){s.remove();i.setName("left join")},"action:on-right-join":function(){s.remove();i.setName("right join")}})}function u(e,t,a){var i=t.model;var s=new joint.ui.ContextToolbar({target:e,padding:5,vertical:true,tools:a});s.render();s.on({"action:remove":function(){s.remove();i.remove()},"action:add-item":function(){s.remove();i.addItemAtIndex(0,Infinity,i.getDefaultItem())}})}function m(e,t){}function h(e){var t=new sap.m.Dialog({title:"Confirm",type:"Message",content:new sap.m.Text({text:"Are you sure you want to delete this link ?"}),beginButton:new sap.m.Button({text:"Remove",press:function(){e.remove();t.close()}}),endButton:new sap.m.Button({text:"Cancel",press:function(){t.close()}}),afterClose:function(){t.destroy()}});t.open()}if(this.editMode){}else{this.validateStepFour()}if(this.editMode&&t.clickedTable!==undefined)this.validateStepFour()},onAddJoinPress:function(){var e=new joint.shapes.mapping.Join({attrs:{headerLabel:{cursor:"pointer",magnet:false,class:"iconClass"}},items:[[{id:"value_1",label:"Value 1",group:"headers"},{id:"value_12",label:""},{id:"value_3",label:""}],[{id:"value_2",label:"Value 2",group:"headers"},{id:"value3",label:""},{id:"value4",label:""}]]});if(this.joinsCount===0){this.joinTablePosition=190;this.joinsCount=this.joinsCount+1}else{this.joinTablePosition=this.joinTablePosition+400}e.position(this.joinTablePosition,30);e.addTo(this.graph);e.setName("inner join")},validateStepThree:function(){var e=this;e._wizard.validateStep(e.byId("linkingDimension"))},validateStepFour:function(){var e=[];for(var t=0;t<this.graph.attributes.cells.models.length;t++){if(this.graph.attributes.cells.models[t].attributes.type==="mapping.Output"){for(var a=0;a<this.graph.attributes.cells.models[t].attributes.items[0].length;a++){e.push(this.graph.attributes.cells.models[t].attributes.items[0][a])}}}var i=new sap.ui.model.json.JSONModel(e);for(var s=0;s<i.oData.length;s++){if(!i.oData[s].hasOwnProperty("aggregationType"))i.oData[s]["aggregationType"]="";if(!i.oData[s].hasOwnProperty("customLabel"))i.oData[s]["customLabel"]="";if(!i.oData[s].hasOwnProperty("filters"))i.oData[s]["filters"]="";if(!i.oData[s].hasOwnProperty("filters1"))i.oData[s]["filters1"]="";if(!i.oData[s].hasOwnProperty("filterOperator"))i.oData[s]["filterOperator"]="";if(!i.oData[s].hasOwnProperty("descriptions"))i.oData[s]["descriptions"]="";if(!i.oData[s].hasOwnProperty("synonyms"))i.oData[s]["synonyms"]="";if(!i.oData[s].hasOwnProperty("formatpattern"))i.oData[s]["formatpattern"]="";if(!i.oData[s].hasOwnProperty("hidden"))i.oData[s]["hidden"]=false}for(var t=0;t<i.oData.length-1;t++){for(var a=t+1;a<i.oData.length;a++){if(i.oData[t].label===i.oData[a].label){i.oData[a].customLabel=i.oData[a].tablename+"_"+i.oData[a].name}}}this.getView().byId("columnSelectionTableId").setModel(i);this.getView().byId("columnSelectionTableId").getModel().updateBindings(true)},onAddButtonPress:function(){var e=this;this.editFormula=false;e.validateFormula=false;this.addFormulafrag.open()},handleTableSelect:function(e){var t=this;var a=e.getParameter("selectedItem").getText();var i=[];for(var s=0;s<this.tableData.length;s++){for(var r=0;r<this.tableData[s].measureObject.length;r++){if(this.addFormulafrag.getContent()[0].getItems()[0].getItems()[3].getSelectedKey()==this.tableData[s].table){i.push(this.tableData[s].measureObject[r].measureObj)}}}this.cMeasureModel.setData(i);var o=this.addFormulafrag.getContent()[0].getItems()[2];this.addFormulafrag.getContent()[0].getItems()[2].getItems()[0].getItems()[1].setValue()},enableAutoComplete:function(){var e=this;this.cMeasureModel=new sap.ui.model.json.JSONModel;var t=this.addFormulafrag.getContent()[0].getItems()[1];var a=t.getItems()[0].getItems()[1];var i=[];e.tableNameArr=[];for(var s=0;s<this.tableData.length;s++){for(var r=0;r<this.tableData[s].measureObject.length;r++){this.tableData[s].measureObject[r].measureObj.name=this.tableData[s].measureObject[r].measureObj.COLUMN_NAME;this.tableData[s].measureObject[r].measureObj.tablename=this.tableData[s].table;i.push(this.tableData[s].measureObject[r].measureObj)}}if(this.editMode){e.viewname=sap.ui.getCore().getModel("queryInfo").oData.view_name}this.cMeasureModel.setData(i);var o=jQuery("#"+a.getId()).find("textarea");o.textcomplete([{match:/(\b(\w+))$/,search:function(t,a){var i=Promise.resolve(e.cMeasureModel.getData());i.then(function(e){a(e.filter(function(e){return e.name.toUpperCase().includes(t.toUpperCase())}))})},template:function(e){return e.tablename+"."+e.name},replace:function(t){if(e.tableNameArr.includes(e.dbName+"."+t.tablename)===false)e.tableNameArr.push(e.dbName+"."+t.tablename);return t.tablename+"."+t.name}}])},onFunctionPress:function(e){var t=e.getSource().getText();var a=this.addFormulafrag.getContent()[0].getItems()[1].getItems()[0].getItems()[1];if(a.getValue().length>0&&t!="If()")a.setValue(a.getValue()+" "+t);else if(a.getValue().length>0&&t=="If()")a.setValue("CASE WHEN "+a.getValue()+" THEN     ELSE   END");else if(a.getValue().length<=0&&t=="If()")a.setValue("CASE WHEN       THEN     ELSE   END");else a.setValue(t)},onConditionPress:function(e){var t=e.getSource().getText();if(t==="And")t="and";else if(t==="Or")t="or";else if(t==="Greater Than")t=">";else if(t==="Greater Than Equals")t=">=";else if(t==="Less Than")t="<";else if(t==="Less Than Equals")t="<=";var a=this.addFormulafrag.getContent()[0].getItems()[1].getItems()[0].getItems()[1];a.setValue(a.getValue()+" "+t)},onOperatorPress:function(e){var t=e.getSource().getText();var a=this.addFormulafrag.getContent()[0].getItems()[1].getItems()[0].getItems()[1];a.setValue(a.getValue()+" "+t)},onValidateFormula:function(e){var t=this;t.validateFormula=false;var a=this.addFormulafrag.getContent()[0].getItems();var i=a[0].getItems()[1].getSelectedKey();if(this.editMode)var r=this.viewname;else var r=a[0].getItems()[3].getValue();var o=a[1].getItems()[0].getItems()[1];if(o.getValue().length===0){o.setValueState("Error");sap.m.MessageToast.show("Please Enter Formula");return}o.setValueState("None");var l=this.graph.attributes.cells.models;var n=[];var d=[];var g=[];var u=[];var m=[];for(var h=0;h<l.length;h++){if(l[h].attributes.type=="mapping.Join"){d.push(l[h])}else if(l[h].attributes.type=="mapping.Record"){g.push(l[h])}}g=g.sort(function(e,t){return e.attributes.position.x-t.attributes.position.x});d=d.sort(function(e,t){return e.attributes.position.x-t.attributes.position.x});for(var p=0;p<d.length;p++){var f=d[p].attributes.items[0][0];var v=d[p].attributes.items[1][0];var c=f.tablename+"."+f.name+"="+v.tablename+"."+v.name;n.push(c);var b=d[p].attributes.attrs.headerLabel.textWrap.text;m.push(b)}var w=t.dbName+"."+g[0].attributes.attrs.headerLabel.textWrap.text;for(h=1;h<g.length;h++){u.push(t.dbName+"."+g[h].attributes.attrs.headerLabel.textWrap.text)}var V={table_name:w,encodecondition:btoa(o.getValue()),tables:u,conditions:n,join_type:m};s.callCreateService("ValidateFormula",JSON.stringify(V),"POST",function(e,a,i){var s=JSON.parse(e);if(s.status==="Error"){o.setValueState("Error");t.validateFormula=false;var r=new sap.m.Dialog({title:"Error Message",type:"Message",content:new sap.m.Text({text:s.message}),beginButton:new sap.m.Button({text:"OK",press:function(){r.close()}}),afterClose:function(){r.destroy()}});r.open()}else{t.validateFormula=true;sap.m.MessageToast.show("Valid Formula");o.setValueState("None")}})},handleCustomMeasureSave:function(e){var t=this;t.formulaFlag=true;var a=this.addFormulafrag.getContent()[0].getItems();var i=a[0].getItems()[1].getSelectedKey();var s=a[0].getItems()[3].getValue();var r=a[1].getItems()[0].getItems()[1].getValue().trim();var o="";if(i=="Conditional"){if(s.length==0){a[0].getItems()[1].setValueState(sap.ui.core.ValueState.Error);o="Please enter measure name"}else if(r.length==0){a[0].getItems()[1].setValueState("None");a[1].getItems()[0].getItems()[1].setValueState(sap.ui.core.ValueState.Error);o="Please enter formula"}else if(t.validateFormula===false||t.validateFormula==undefined){a[0].getItems()[1].setValueState("None");a[1].getItems()[0].getItems()[1].setValueState(sap.ui.core.ValueState.Error);o="Please validate formula"}if(o.length>0){sap.m.MessageToast.show(o)}else if(this.validateFormula){var l={Viewname:this.viewname,Aliasname:s.replace(/[^a-zA-Z0-9]/g,"_"),Formula:r};if(!this.editFormula){if(this.editMode)this.formulas=this.getView().byId("comboBoxFormulaId").getModel().getData();this.formulas.push(l);var n=new sap.ui.model.json.JSONModel(this.formulas);this.getView().byId("comboBoxFormulaId").setModel(n)}else{this.getView().byId("comboBoxFormulaId").getItems()[t.listSelectedPath].getBindingContext().getObject()["Aliasname"]=s.replace(/[^a-zA-Z0-9]/g,"_");this.getView().byId("comboBoxFormulaId").getItems()[t.listSelectedPath].getBindingContext().getObject()["Formula"]=r}this.getView().byId("comboBoxFormulaId").getModel().updateBindings(true);var d=this.getView().byId("comboBoxFormulaId").getItems();a[0].getItems()[3].setValue();a[1].getItems()[0].getItems()[1].setValue();this.addFormulafrag.close()}else{sap.m.MessageToast.show("Please enter valid formula")}}},handleCustomMeasureCancel:function(e){this.addFormulafrag.getContent()[0].getItems()[0].getItems()[3].setValue();this.addFormulafrag.getContent()[0].getItems()[1].getItems()[0].getItems()[1].setValue();this.addFormulafrag.close()},removeContent:function(){var e=this;e.tableData=[];e.selectedTables=[];var t=new sap.ui.model.json.JSONModel;e.getView().byId("tables").setModel(t);e.getView().byId("selectedTables").setModel(t);e.getView().byId("columnSelectionTableId").setModel(t);this._handleNavigationToStep(1)},setDataforOutputView:function(e){var t=this;if(!e){var a=sap.ui.getCore().getModel("queryInfo");var i=JSON.parse(a.getData().graph_data);var r=a.getData().conditions;for(var o=0;o<i.length;o++){if(i[o].type=="mapping.Record"){var l=new joint.shapes.mapping.Record(i[o]);l.addTo(t.graph);t.position=l.attributes.position.x}else if(i[o].type=="mapping.Join"){for(var n=0;n<i[o].items[0].length;n++){if(n===0){i[o].items[0][n]["group"]="headers"}else{i[o].items[0][n]["group"]=""}}for(var d=0;d<i[o].items[1].length;d++){if(d===0){i[o].items[1][d]["group"]="headers"}else{i[o].items[1][d]["group"]=""}}var l=new joint.shapes.mapping.Join(i[o]);l.addTo(t.graph);t.joinTablePosition=l.attributes.position.x;this.joinsCount=1}else if(i[o].type=="mapping.Output"){t.posCount=1;for(var n=0;n<i[o].items[0].length;n++){i[o].items[0][n]["group"]=""}var l=new joint.shapes.mapping.Output(i[o]);l.addTo(t.graph)}}var i=this.graph.attributes.cells.models;var g=[];for(var d=0;d<i.length;d++){if(i[d].attributes.type==="mapping.Join"){var u=i[d];var m=i[d].attributes.items[0][0].tablename;var h=i[d].attributes.items[0][0].id;var p=i[d].attributes.items[1][0].tablename;var f=i[d].attributes.items[1][0].id;var v=new joint.shapes.mapping.Link;for(var o=0;o<i.length;o++){if(i[o].attributes.attrs.headerLabel.textWrap.text===m){var c=i[o];v.attributes.source.id=c.id;v.attributes.source.port=h;v.attributes.target.id=u.id;v.attributes.target.port=h}}g.push(v);var b=new joint.shapes.mapping.Link;for(var o=0;o<i.length;o++){if(i[o].attributes.attrs.headerLabel.textWrap.text===p){var c=i[o];b.attributes.source.id=u.id;b.attributes.source.port=f;b.attributes.target.id=c.id;b.attributes.target.port=f}}g.push(b)}}g.forEach(function(e){t.graph.addCell(e)})}else if(e){t.tableData=[];this.graph=new joint.dia.Graph;this.position=30;this.posCount=0;this.sColumns=[];this.viewData=e;this.conditions=e.conditions;var w=t.getView().byId("database").getItems();var V=e.parent_table.split(".")[0];t.dbName=V;for(var n=0;n<w.length;n++){if(w[n].getBindingContext().getObject().name===V){t.getView().byId("database").setSelectedKey(V)}}var y="getAllTablesAndViews?db="+V;s.callService(V+"Tables",V+"Tables","getAllTablesAndViews?db="+V,"",true,function(a){var i=sap.ui.getCore().getModel(V+"Tables");t.getView().byId("tables").setModel(i);var s=t.getView().byId("tables").getItems();t.setOutputColumns(e);var r=e.parent_table.split(".")[1].trim();t.addLinkingItem(t.tableData);var o=[];for(var l=0;l<e.tables.length;l++){var d=e.tables[l].split(".")[1].trim();o.push(d)}for(n=0;n<s.length;n++){if(s[n].getBindingContext().getObject().TABLE_NAME===r){t.getView().byId("tables").setSelectedItem(s[n])}else{for(var g=0;g<o.length;g++){if(s[n].getBindingContext().getObject().TABLE_NAME===o[g]){t.getView().byId("tables").setSelectedItem(s[n])}}}}var u=t.getView().byId("tables").getSelectedItems();var m=[];for(g=0;g<o.length;g++){for(n=0;n<u.length;n++){if(u[n].getBindingContext().getObject().TABLE_NAME===o[g]){m.push(u[n].getBindingContext().getObject())}}}t.selectedTables=m;var h={selectedTables:m};var p=new sap.ui.model.json.JSONModel(h);t.getView().byId("selectedTables").setModel(p)});this._handleNavigationToStep(3)}},setOutputColumns:function(e){var t=this;var a=e.parent_table.split(".")[0];var i="TableMetadata?db="+a;var s=e.parent_table.split(".")[1].trim();var r=i+"&table="+s;t.callService(s,true,r);var o=[];for(var l=0;l<e.tables.length;l++){var n=e.tables[l].split(".")[1].trim();o.push(n);r=i+"&table="+n;t.callService(n,true,r)}},handletableColumnFilters:function(e){var t=e.oSource.oParent.getBindingContext().getObject().name;var a=this;this.selectedFilterValueField=e.oSource;this.filterParameter=t;this.BusyDialog.open();var i=e.oSource.oParent.getBindingContext().getObject().tablename;var r="TableData?db="+a.dbName+"&table="+i+"&select="+t;s.callService("dataSrcSystem",jQuery.sap.getModulePath("Brevo.QueryBuilder")+"/neo-app.json",r,"","false",function(e){a.BusyDialog.close();var i=sap.ui.getCore().getModel("dataSrcSystem");if(i.oData.tables.length>0){var s={};for(var r=0,o=i.oData.tables.length;r<o;r++)s[i.oData.tables[r][t]]=i.oData.tables[r];i.oData.tables=new Array;for(var l in s)i.oData.tables.push(s[l]);var n=new sap.m.StandardListItem({title:"{"+t+"}"});a.ValueHelpForFilterValues.bindAggregation("items",{path:"/tables",template:n})}a.ValueHelpForFilterValues.setModel(i);var d=a.ValueHelpForFilterValues.getItems();a.ValueHelpForFilterValues.open()})},handleFilterSearch:function(e){var t=[];var a=e.getParameter("value");var i=e.mParameters.itemsBinding;if(a&&a.length>0){var s=new sap.ui.model.Filter("property",sap.ui.model.FilterOperator.Contains,a);t.push(s);i.filter(new sap.ui.model.Filter(t,false))}else{i.filter([])}},handleFilterValueConfirm:function(e){var t="";var a=[];var i;var s=e.getParameter("selectedContexts");if(s.length>0){for(var r=0;r<s.length;r++){i=s[r].oModel.getProperty(s[r].sPath);a.push(i[this.filterParameter]);if(s.length===1){t=i[this.filterParameter]}else{if(r===0){t=i[this.filterParameter]}else{t=t+","+i[this.filterParameter]}}}this.selectedValues=a;this.selectedFilterValueField.setValue(t)}else{sap.m.MessageToast.show("Select atleast one filter value");this.selectedFilterValueField.setValue()}e.getSource().getBinding("items").filter([])},constructFilterUrlForTable:function(e){var t="",a="";for(var i=0;i<e.length;i++){var s=e[i].filterName;var o=r.filterUrlOperator(e[i].filterOperator);var l=e[i].filterTable;if(e[i].filterDataType.indexOf("date")>-1){if(e[i].filterOperator=="bw"){var n=e[i].filterValue.split(",");var d=e[i].filterValue1.split(",");t="("+l+"."+s+" > '"+n+" 00:00:00.000')and("+l+"."+s+" < '"+d+" 00:00:00.000')"}else{var g=e[i].filterValue.split(",");for(var u=0;u<g.length;u++){if(u==0)t=l+"."+s+o+"'"+g[u]+"'";else t=t+" OR "+l+"."+s+o+"'"+g[u]+"'"}}}else{if(e[i].filterOperator=="bw"){var n=e[i].filterValue.split(",");var d=e[i].filterValue1.split(",");if(n.length>0&&d.length>0){if(n.indexOf(",")==-1&&d.indexOf(",")==-1){t="("+s+" > '"+n+"')and("+s+" < '"+d+"')"}else{var m=n.split(",");var h,p;for(var u=0;u<m.length;u++){m[u]=m[u].trim().replace(/\s/g,"%20");if(u===0){h="("+l+"."+l+"."+s+" > '"+m[0]+"')"}else{h=h+"or ("+l+"."+s+" > '"+m[u]+"')"}}var f=d.split(",");for(var v=0;v<f.length;v++){m[v]=f[v].trim().replace(/\s/g,"%20");if(v===0){p="("+l+"."+s+" < '"+m[0]+"')"}else{p=p+"or ("+l+"."+s+" < '"+m[v]+"')"}}t=h+"and"+p}}}else{var g=e[i].filterValue.split(",");for(var u=0;u<g.length;u++){if(u==0)t=l+"."+s+o+"'"+g[0]+"'";else t=t+" OR "+l+"."+s+o+"'"+g[u]+"'"}}}t="("+t+")";if(a.length==0){a=t}else{a=a+"and"+t}}if(a.length>0)return a;else return""},wizardCompletedHandler:function(){if(this.graph.attributes.cells.models.length>0){var e=this.getView().byId("columnSelectionTableId").getModel().getProperty("/");var t=[];var a=[];var i=new sap.ui.model.json.JSONModel;for(var s=0;s<e.length;s++){if(!e[s].hidden){t.push(e[s])}}var r=new sap.ui.model.json.JSONModel(t);var o=this._oWizardReviewPage.getContent();o[0].getContent()[1].setText(this.dbName);var l=this.getView().byId("selectedTables").getModel();o[1].getContent()[1].setModel(l);o[3].getContent()[1].setModel(r);var n=this.getView().byId("comboBoxFormulaId").getModel();o[3].getContent()[3].setModel(n);if(this.editMode){this._oWizardReviewPage.mAggregations.footer.mAggregations.contentRight[2].setVisible(true);this._oWizardReviewPage.mAggregations.footer.mAggregations.contentRight[1].setVisible(false)}else{this._oWizardReviewPage.mAggregations.footer.mAggregations.contentRight[2].setVisible(false);this._oWizardReviewPage.mAggregations.footer.mAggregations.contentRight[1].setVisible(true)}this._oNavContainer.addPage(this._oWizardReviewPage);this._oNavContainer.to(this._oWizardReviewPage);var d=new joint.dia.Graph;var g=new joint.dia.Paper({el:document.getElementById("reviewLinkingProperties"),model:d,width:"100%",height:150,gridSize:10,background:{color:"#f6f6f6"},magnetThreshold:"onleave",moveThreshold:5,clickThreshold:5,linkPinning:false,interactive:{linkMove:false,elementMove:false},markAvailable:true,snapLinks:{radius:40},defaultRouter:{name:"mapping",args:{padding:30}},defaultConnectionPoint:{name:"anchor"},defaultAnchor:{name:"mapping"},defaultConnector:{name:"jumpover",args:{jump:"cubic"}},highlighting:{magnetAvailability:{name:"addClass",options:{className:"record-item-available"}},connecting:{name:"stroke",options:{padding:8,attrs:{stroke:"none",fill:"#7c68fc","fill-opacity":.2}}}},defaultLink:function(){return new joint.shapes.mapping.Link},validateConnection:function(e,t,a,i,s){if(e===a)return false;if(e.model.isLink()||a.model.isLink())return false;if(s==="target")return a.model.getItemSide(a.findAttribute("item-id",i))!=="right";return e.model.getItemSide(e.findAttribute("item-id",t))!=="left"}});function u(e){var t=e.model;var a=new joint.ui.FreeTransform({cellView:e,allowRotation:false});a.render();a.listenTo(t,"change",i);i();function i(){var e=t.getMinimalSize();a.options.minHeight=e.height;a.options.minWidth=e.width}}var m=this.graph.attributes.cells.models;var h;var p=30;for(s=0;s<m.length;s++){if(m[s].attributes.type=="mapping.Join"){var f=[];var v=[];f.push(m[s].attributes.items[0][0]);v.push(m[s].attributes.items[1][0]);f[0]["group"]="headers";v[0]["group"]="headers";var h=new joint.shapes.mapping.Join({size:{width:500},attrs:{headerLabel:{magnet:null},itemLabels:{magnet:null},itemLabels_1:{magnet:null}},items:[f,v]});h.position(p,50);h.addTo(d);p=p+550;h.setName(m[s].attributes.attrs.headerLabel.textWrap.text)}}}else{sap.m.MessageToast.show("Incomplete Data")}},_handleNavigationToStep:function(e){var t=function(){this._wizard.goToStep(this._wizard.getSteps()[e]);this._oNavContainer.detachAfterNavigate(t)}.bind(this);this._oNavContainer.attachAfterNavigate(t);this.backToWizardContent()},backToWizardContent:function(){this._oNavContainer.backToPage(this._oWizardContentPage.getId())},editStepOne:function(){this._handleNavigationToStep(0)},editStepTwo:function(){this._handleNavigationToStep(1)},editStepThree:function(){this._handleNavigationToStep(2)},editStepFour:function(){this._handleNavigationToStep(3)},onPreviewDataPress:function(){var e=this;e.BusyDialog.open();var t=e.constructPayloadForWizard();if(e.sortItems.length>0)t.orderby=this.sortItems[0].selectedSortItem+" "+this.sortItems[0].sortOperator;else t.orderby="";var a=sap.ui.core.UIComponent.getRouterFor(e);var i="DataPreview";s.callCreateService(i,JSON.stringify(t),"POST",function(t,i,s){if(i){var r=JSON.parse(t).data;var o=new sap.ui.model.json.JSONModel(r);sap.ui.getCore().setModel(o,"dataPreviewModel");a.navTo("dataPreview");e.BusyDialog.close()}else{e.BusyDialog.close();sap.m.MessageToast.show("No data to Preview")}})},constructPayloadForWizard:function(){var e=this;var t=this.getView().byId("columnSelectionTableId").getModel().getProperty("/");this.tableColumns=[];this.tableFilters=[];var a=[];for(var i=0;i<t.length;i++){this.tableColumns.push(t[i]);if(t[i].filters.length>0){this.tableFilters.push({filterDataType:this.tableColumns[i].datatype,filterName:this.tableColumns[i].name,filterOperator:this.tableColumns[i].filterOperator,filterValue:this.tableColumns[i].filters,filterValue1:this.tableColumns[i].filters1,selectParam:this.tableColumns[i].name,filterTable:this.tableColumns[i].tablename})}}var s=this.constructFilterUrlForTable(this.tableFilters);var r="";if(s.length>0){if(r.length>0)r+="and"+s;else r=s}var o=[];for(i=0;i<this.tableColumns.length;i++){o.push(this.tableColumns[i]);if(!this.tableColumns[i].hidden){if(this.tableColumns[i].customLabel){var l=this.tableColumns[i].customLabel.replace(/[^a-zA-Z0-9]/g,"_");a.push(this.tableColumns[i].tablename+"."+this.tableColumns[i].name+" as "+l)}else{a.push(this.tableColumns[i].tablename+"."+this.tableColumns[i].name)}}}if(this.getView().byId("comboBoxFormulaId").getModel()!==undefined){if(this.getView().byId("comboBoxFormulaId").getModel().oData.length>0){for(var n=0;n<this.getView().byId("comboBoxFormulaId").getModel().oData.length;n++){var d=this.getView().byId("comboBoxFormulaId").getModel().oData[n].Formula;a.push("("+d+")"+" as "+this.getView().byId("comboBoxFormulaId").getModel().oData[n].Aliasname)}}}var g=r;var u=[];var m=this.graph.attributes.cells.models;var h=[];var p=[];var f=[];var v=[];for(n=0;n<m.length;n++){if(m[n].attributes.type=="mapping.Join"){v.push(m[n])}else if(m[n].attributes.type=="mapping.Record"){f.push(m[n])}}f=f.sort(function(e,t){return e.attributes.position.x-t.attributes.position.x});v=v.sort(function(e,t){return e.attributes.position.x-t.attributes.position.x});for(n=0;n<v.length;n++){var c=v[n].attributes.items[0][0];var b=v[n].attributes.items[1][0];var w=c.tablename+"."+c.name+"="+b.tablename+"."+b.name;h.push(w);var V=v[n].attributes.attrs.headerLabel.textWrap.text;p.push(V)}var y=this.getView().byId("database").getSelectedKey();var D=y+"."+f[0].attributes.attrs.headerLabel.textWrap.text;for(n=1;n<f.length;n++){u.push(y+"."+f[n].attributes.attrs.headerLabel.textWrap.text)}var C={tables:u,selected_columns:a.toString(),conditions:h,join_type:p,parent_table:D,filter_url:g};return C},onCreateViewPress:function(){var e=sap.ui.getCore().getModel("Departments");var t=new sap.ui.model.json.JSONModel;t.oData.tables=[];for(var a=0;a<e.oData.tables.length;a++){t.oData.tables.push(e.oData.tables[a])}var i=t.oData.tables.map(function(e){return e.Department_name});if(!i.includes("Add a New Department")){t.oData.tables.push({Department_name:"Add a New Department"})}t.setDefaultBindingMode("OneWay");this.createViewDialog.getContent()[0].getContent()[1].setValue("");this.createViewDialog.getContent()[0].getContent()[3].setValue("");this.createViewDialog.getContent()[0].getContent()[5].setModel(t);this.createViewDialog.getContent()[0].getContent()[6].setVisible(false);this.createViewDialog.getContent()[0].getContent()[7].setVisible(false);this.createViewDialog.open()},onCreateCancelPress:function(){this.createViewDialog.getContent()[0].getContent()[1].setValue("");this.createViewDialog.close()},onDepartmentChangeOnCreate:function(){var e=this.createViewDialog.getContent()[0].getContent()[5].getSelectedKey();if(e==="Add a New Department"){this.createViewDialog.getContent()[0].getContent()[6].setVisible(true);this.createViewDialog.getContent()[0].getContent()[6].setValue("");this.createViewDialog.getContent()[0].getContent()[7].setVisible(true)}},onDepartmentChangeOnEdit:function(){var e=this.editViewDialog.getContent()[0].getContent()[5].getSelectedKey();if(e==="Add a New Department"){this.editViewDialog.getContent()[0].getContent()[6].setVisible(true);this.editViewDialog.getContent()[0].getContent()[6].setValue("");this.editViewDialog.getContent()[0].getContent()[7].setVisible(true)}},onAddDeptPressOnCreate:function(){var e=this;var t=this.createViewDialog.getContent()[0].getContent()[5].getModel();var i=this.createViewDialog.getContent()[0].getContent()[6].getValue();var r=false;for(var o=0;o<t.oData.tables.length;o++){if(t.oData.tables[o].Department_name===i){var l="Department already exists";a.show(l);r=true}}if(r){this.createViewDialog.getContent()[0].getContent()[5].setSelectedKey(i);this.createViewDialog.getContent()[0].getContent()[6].setVisible(false);this.createViewDialog.getContent()[0].getContent()[7].setVisible(false)}else{var n={Department_name:i};s.callCreateService("AddDepartment",JSON.stringify(n),"POST",function(a,s,r){if(s){t.oData.tables.splice(t.oData.tables.length-1,1);var o={Department_name:i};var l={Department_name:"Add a New Department"};t.oData.tables.push(o);t.oData.tables.push(l);e.createViewDialog.getContent()[0].getContent()[5].getModel().updateBindings(true);e.createViewDialog.getContent()[0].getContent()[5].setSelectedKey(i);e.createViewDialog.getContent()[0].getContent()[6].setVisible(false);e.createViewDialog.getContent()[0].getContent()[7].setVisible(false)}else{sap.m.MessageToast.show("Unable to add Department.Try again")}})}},onAddDeptPressOnEdit:function(){var e=this;var t=this.editViewDialog.getContent()[0].getContent()[5].getModel();var i=this.editViewDialog.getContent()[0].getContent()[6].getValue();var r=false;for(var o=0;o<t.oData.tables.length;o++){if(t.oData.tables[o].Department_name===i){var l="Department already exists";a.show(l);r=true}}if(r){this.editViewDialog.getContent()[0].getContent()[5].setSelectedKey(i);this.editViewDialog.getContent()[0].getContent()[6].setVisible(false);this.editViewDialog.getContent()[0].getContent()[7].setVisible(false)}else{var n={Department_name:i};s.callCreateService("filters/add_department",n,"POST",function(a,s,r){if(s){t.oData.tables.splice(t.oData.tables.length-1,1);var o={Department_name:i};var l={Department_name:"Add a New Department"};t.oData.tables.push(o);t.oData.tables.push(l);e.editViewDialog.getContent()[0].getContent()[5].getModel().updateBindings(true);e.editViewDialog.getContent()[0].getContent()[5].setSelectedKey(i);e.editViewDialog.getContent()[0].getContent()[6].setVisible(false);e.editViewDialog.getContent()[0].getContent()[7].setVisible(false)}else{sap.m.MessageToast.show("Unable to add Department.Try again")}})}},onCreatePress:function(){var e=this;var t=this.constructPayloadForWizard();var a=this.createViewDialog.getContent()[0].getContent()[1].getValue();var i=this.createViewDialog.getContent()[0].getContent()[3].getValue();var r=this.createViewDialog.getContent()[0].getContent()[5].getSelectedKey();var o=this.graph.attributes.cells.models;t.view_name="";t.last_change=new Date;t.table_config=JSON.stringify(this.tableColumns);t.graph_data=JSON.stringify(o);t.user_name="";t.description=i;t.department=r;t.created_through="wizard";if(e.sortItems.length>0)t.orderby=this.sortItems[0].selectedSortItem+" "+this.sortItems[0].sortOperator;else t.orderby="";var l=sap.ui.core.UIComponent.getRouterFor(this);if(a.length>0){var n;t.view_name=a.replace(/[^a-zA-Z0-9]/g,"_");n="CreateView";s.callCreateService(n,JSON.stringify(t),"POST",function(t,a,i){if(a){e.BusyDialog.close();sap.m.MessageToast.show("View Created Successfully");var s=JSON.parse(t);l.navTo("home");e.tile=s.view_name;e.viewId=s.id;e.handleWizardCancel();e.editMode=false;e.createViewDialog.close()}else if(JSON.parse(t).message==="View with this ID already exists"){e.BusyDialog.close();sap.m.MessageToast.show("Query Name already exists.Please give a different Query Name")}else if(JSON.parse(t).message==="Query has 0 results"){e.BusyDialog.close();sap.m.MessageToast.show(JSON.parse(t).message)}else{e.BusyDialog.close();sap.m.MessageToast.show("Unable to create view.Try again")}})}else{e.BusyDialog.close();sap.m.MessageToast.show("Query Name cannot be empty")}},onUpdateViewPress:function(){var e=sap.ui.getCore().getModel("queryInfo");var t=sap.ui.getCore().getModel("Departments");var a=new sap.ui.model.json.JSONModel;a.oData.tables=[];for(var i=0;i<t.oData.tables.length;i++){a.oData.tables.push(t.oData.tables[i])}var s=a.oData.tables.map(function(e){return e.Department_name});if(!s.includes("Add a New Department")){a.oData.tables.push({Department_name:"Add a New Department"})}a.setDefaultBindingMode("OneWay");this.editViewDialog.getContent()[0].getContent()[1].setValue(this.viewData.view_name);this.editViewDialog.getContent()[0].getContent()[3].setValue(e.getData().description);this.editViewDialog.getContent()[0].getContent()[5].setModel(a);this.editViewDialog.getContent()[0].getContent()[5].setSelectedKey(e.getData().department);this.editViewDialog.getContent()[0].getContent()[6].setVisible(false);this.editViewDialog.getContent()[0].getContent()[7].setVisible(false);this.editViewDialog.open()},onUpdateCancelPress:function(){this.editViewDialog.getContent()[0].getContent()[1].setValue("");this.editViewDialog.close()},onUpdatePress:function(){var e=this;e.BusyDialog.open();var t=e.constructPayloadForWizard();var a=this.graph.attributes.cells.models;this.viewData.tables=t.tables;this.viewData.selected_columns=t.selected_columns;this.viewData.conditions=t.conditions;this.viewData.join_type=t.join_type;this.viewData.parent_table=t.parent_table;this.viewData.filter_url=t.filter_url;this.viewData.db_name=this.dbName;this.viewData.last_change=new Date;this.viewData.table_config=JSON.stringify(this.tableColumns);this.viewData.graph_data=JSON.stringify(a);var i=sap.ui.core.UIComponent.getRouterFor(this);var r=this.editViewDialog.getContent()[0].getContent()[1].getValue();var o=this.editViewDialog.getContent()[0].getContent()[3].getValue();var l=this.editViewDialog.getContent()[0].getContent()[5].getSelectedKey();if(e.sortItems.length>0)this.viewData.orderby=this.sortItems[0].selectedSortItem+" "+this.sortItems[0].sortOperator;else this.viewData.orderby="";if(r.length>0){var n;var d;this.viewData.view_name=r.replace(/[^a-zA-Z0-9]/g,"_");this.viewData.user_name="";this.viewData.description=o;this.viewData.department=l;n=this.viewData;d="UpdateView";s.callCreateService(d,JSON.stringify(n),"POST",function(t,a,s){if(a){e.BusyDialog.close();e.clickedTable=undefined;sap.m.MessageToast.show("View Updated Successfully");i.navTo("home");e.handleWizardCancel();e.editViewDialog.close()}else if(JSON.parse(t).message==="View with this ID already exists"){e.BusyDialog.close();sap.m.MessageToast.show("Query Name already exists.Please give a different Query Name")}else{e.BusyDialog.close();sap.m.MessageToast.show("Unable to update view.Try again")}})}else{e.BusyDialog.close();sap.m.MessageToast.show("Query Name cannot be empty")}},onTableSearch:function(e){var t=[];var a=e.getSource().getValue();if(a&&a.length>0){var i=new sap.ui.model.Filter("TABLE_NAME",sap.ui.model.FilterOperator.Contains,a);t.push(i)}var s=this.byId("tables");var r=s.getBinding("items");r.filter(t)},onViewSearch:function(e){var t=[];var a=e.getSource().getValue();if(a&&a.length>0){var i=new sap.ui.model.Filter("TABLE_NAME",sap.ui.model.FilterOperator.Contains,a);t.push(i)}var s=this.byId("selectedTables");var r=s.getBinding("items");r.filter(t)},onNavBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);var t=i.getInstance();var a=t.getPreviousHash();if(a!==undefined){window.history.go(-1)}else{e.navTo("home",{},true)}this.handleWizardCancel()},handleWizardCancel:function(){var e=this;this.selectedTables=[];this.sortItems=[];this.clickedTable=undefined;this.graph=new joint.dia.Graph;this.position=30;this.posCount=0;this.joinsCount=0;this.joinTablePosition=190;e.editMode=false;this.getView().byId("sortById").setValue();e.getView().byId("formulaId").setVisible(true);e.getView().byId("editorButton").setEnabled(true);var t=new sap.ui.model.json.JSONModel;this.getView().byId("database").setSelectedKey("Brevo");s.callService("Brevo"+"Tables","Brevo"+"Tables","getAllTablesAndViews?db=Brevo","",true,function(t){var a=sap.ui.getCore().getModel("Brevo"+"Tables");e.getView().byId("tables").setModel(a)});this.getView().byId("tables").removeSelections();this.getView().byId("selectedTables").setModel(t);this.getView().byId("columnSelectionTableId").setModel(t);this.getView().byId("comboBoxFormulaId").setModel(t);this._handleNavigationToStep(0);this._wizard.discardProgress(this._wizard.getSteps()[0]);this._oNavContainer.removePage(this._oWizardReviewPage)},handleSubmitCancel:function(){this._handleNavigationToStep(0)},onListItemPress:function(e){var t=this;this.editFormula=true;t.listSelectedPath=e.oSource.getBindingContext().sPath.split("/")[1];this.addFormulafrag.open();var a=e.oSource.getBindingContext().getObject();var i=a.Aliasname;this.addFormulafrag.getContent()[0].getItems()[0].getItems()[3].setValue(i);var s=a.Formula;this.addFormulafrag.getContent()[0].getItems()[1].getItems()[0].getItems()[1].setValue(s)},handleDelete:function(e){var t=this;e.mParameters.listItem.getBindingContextPath();e.oSource.getModel().oData.splice(e.mParameters.listItem.getBindingContextPath().split("/")[1],1);e.oSource.getModel().updateBindings(true)},onValueHelpRequestForSortValue:function(e){var t=this;var a=[];var i=this.getView().byId("columnSelectionTableId").getModel().getProperty("/");if(t.fileUploaded==true){for(var s=0;s<i.length;s++){a.push(i[s].tablename+"."+i[s].name)}}else{for(var s=0;s<i.length;s++){if(i[s].datatype=="MEASURE")a.push(i[s].tablename+"."+i[s].name)}}if(t.valueHelpForSort.getSortItems().length>0){t.valueHelpForSort.removeAllSortItems()}for(var r=0;r<a.length;r++){t.valueHelpForSort.addSortItem(new sap.m.ViewSettingsItem({text:a[r],key:a[r]}))}var o=this.getView().byId("comboBoxFormulaId").getModel().getData();for(var r=0;r<o.length;r++){t.valueHelpForSort.addSortItem(new sap.m.ViewSettingsItem({text:o[r].Aliasname,key:o[r].Aliasname}))}if(t.sortItems.length>0){t.valueHelpForSort.setSelectedSortItem(t.sortItems[0].selectedSortItem);if(t.sortItems[0].sortOperator=="DESC")t.valueHelpForSort.setSortDescending(true);else t.valueHelpForSort.setSortDescending(false)}t.valueHelpForSort.open()},handleViewSettingsConfirm:function(e){if(e.mParameters.sortDescending==false)var t="ASC";else var t="DESC";var a=e.mParameters.sortItem.getText();this.sortItems=[{sortOperator:t,selectedSortItem:a}];this.getView().byId("sortById").setValue(a)}})});