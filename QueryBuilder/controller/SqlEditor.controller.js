sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/m/MessageToast","Brevo/QueryBuilder/model/Service"],function(e,t,a,s){"use strict";return e.extend("Brevo.QueryBuilder.controller.SqlEditor",{escapePreventDialog:null,onInit:function(){var e=this;this.edit=false;this.query="";e.BusyDialog=new sap.m.BusyDialog;this.queryId="";this.tile="";this.created="";this.dbName="";e.getView().byId("aCodeEditor").setValue("");if(!e.createViewDialog){e.createViewDialog=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.createView",e)}if(!e.editViewDialog){e.editViewDialog=sap.ui.xmlfragment("Brevo.QueryBuilder.fragment.editView",e)}sap.ui.core.UIComponent.getRouterFor(this).getRoute("sqlEditor").attachPatternMatched(this.onPatternMatched,this)},onPatternMatched:function(e){var t=this;var a=e.getParameter("arguments").isQueryPresent;var s=e.getParameter("arguments").isEditMode;if(a){var i=sap.ui.getCore().getModel("dataQueryModel");t.getView().byId("aCodeEditor").setValue(i.getData().query);t.getView().byId("create").setVisible(true);t.getView().byId("update").setVisible(false);t.getView().byId("wizardButton").setEnabled(true);t.dataModel=sap.ui.getCore().getModel("queryInfo")}else if(s){var i=sap.ui.getCore().getModel("queryInfo");t.getView().byId("aCodeEditor").setValue(i.getData().query);t.getView().byId("create").setVisible(false);t.getView().byId("update").setVisible(true);t.getView().byId("wizardButton").setEnabled(false)}},onNavBack:function(){this.getView().byId("aCodeEditor").setValue("");var e=t.getInstance();var a=e.getPreviousHash();if(a!==undefined){window.history.go(-1)}else{var s=sap.ui.core.UIComponent.getRouterFor(this);s.navTo("home",{},true)}},onWizardPress:function(e){var t=this;this.editMode=false;var a=this.editMode;var i=this.getView().byId("aCodeEditor").getValue();var o=sap.ui.core.UIComponent.getRouterFor(this);var n=i.split(" ");var r="WizardDetail";var l={query:i};if(i.length===0){sap.m.MessageToast.show("Invalid Query")}else if(n[0]!=="select"&&n[0]!=="SELECT"){sap.m.MessageToast.show("Only select operation can be performed")}else{t.BusyDialog.open();this.validateQuery(i,false,true,function(e){if(e){t.BusyDialog.close();s.callCreateService(r,JSON.stringify(l),"POST",function(e,t,a){if(t){var s=JSON.parse(e).data;var i=new sap.ui.model.json.JSONModel(s);sap.ui.getCore().setModel(i,"wizardDataModel");o.navTo("createQuery",{isWizardDataPresent:true})}else{sap.m.MessageToast.show("Internal Service Error")}})}else{sap.m.MessageToast.show("Invalid Query")}})}},onValidatePress:function(){var e=this;e.BusyDialog.open();var t=this.getView().byId("aCodeEditor").getValue();var a=t.split(" ");if(a[0]!=="select"&&a[0]!=="SELECT"){sap.m.MessageToast.show("Only select operation can be performed")}else{this.validateQuery(t,false,true,function(t){if(t){e.BusyDialog.close();sap.m.MessageToast.show("Valid Query")}else{e.BusyDialog.close();sap.m.MessageToast.show("Invalid Query")}})}},validateQuery:function(e,t,a,i){var o=this;var n={query:e,data_preview:t,sql_validate:a};var r="ValidateQuery";s.callCreateService(r,JSON.stringify(n),"POST",function(e,t,a){if(t){i(true,e)}else{i(false)}})},onDepartmentChangeOnCreate:function(){var e=this.createViewDialog.getContent()[0].getContent()[5].getSelectedKey();if(e==="Add a New Category"){this.createViewDialog.getContent()[0].getContent()[6].setVisible(true);this.createViewDialog.getContent()[0].getContent()[6].setValue("");this.createViewDialog.getContent()[0].getContent()[7].setVisible(true)}},onDepartmentChangeOnEdit:function(){var e=this.editViewDialog.getContent()[0].getContent()[5].getSelectedKey();if(e==="Add a New Department"){this.editViewDialog.getContent()[0].getContent()[6].setVisible(true);this.editViewDialog.getContent()[0].getContent()[6].setValue("");this.editViewDialog.getContent()[0].getContent()[7].setVisible(true)}},onExecutePress:function(){var e=this;if(this.getView().byId("aCodeEditor").getValue().length>0){e.BusyDialog.open();var t=e.dbName;var a=this.getView().byId("aCodeEditor").getValue();var s=a.split(" ");if(a.length===0){sap.m.MessageToast.show("Invalid Query")}else if(s[0]!=="select"&&s[0]!=="SELECT"){sap.m.MessageToast.show("Only select operation can be performed")}else{this.validateQuery(a,false,true,function(t){if(t){e.validateQuery(a,true,false,function(t,a){if(t){var s=JSON.parse(a).tables;var i=sap.ui.core.UIComponent.getRouterFor(e);var o=new sap.ui.model.json.JSONModel(s);sap.ui.getCore().setModel(o,"dataPreviewModel");i.navTo("dataPreview");e.BusyDialog.close()}else{e.BusyDialog.close();sap.m.MessageToast.show("No Data to Preview")}})}else{e.BusyDialog.close();sap.m.MessageToast.show("Invalid Query")}})}}else{sap.m.MessageToast.show("Please enter the query")}},onCreateViewPress:function(){var e=this;var t=e.dbName;var a=this.getView().byId("aCodeEditor").getValue();var s=a.split(" ");if(a.length===0){sap.m.MessageToast.show("Please Enter the Query")}else if(s[0]!=="select"&&s[0]!=="SELECT"){sap.m.MessageToast.show("Only select operation can be performed")}else{this.validateQuery(a,false,true,function(t){if(t){var a=sap.ui.getCore().getModel("Departments");var s=new sap.ui.model.json.JSONModel;s.oData.tables=[];for(var i=0;i<a.oData.tables.length;i++){s.oData.tables.push(a.oData.tables[i])}var o=s.oData.tables.map(function(e){return e.Department_name});if(!o.includes("Add a New Department")){s.oData.tables.push({Department_name:"Add a New Department"})}e.createViewDialog.getContent()[0].getContent()[1].setValue("");e.createViewDialog.getContent()[0].getContent()[3].setValue("");e.createViewDialog.getContent()[0].getContent()[5].setModel(s);e.createViewDialog.open()}else{sap.m.MessageToast.show("Invalid Query")}})}},onCreatePress:function(){var e=this;var t=this.getView().byId("aCodeEditor").getValue();var a=sap.ui.core.UIComponent.getRouterFor(this);var i=this.createViewDialog.getContent()[0].getContent()[1].getValue();var o=this.createViewDialog.getContent()[0].getContent()[3].getValue();var n=this.createViewDialog.getContent()[0].getContent()[5].getSelectedKey();if(i.length>0){var r;var l;r={last_change:new Date,table_config:"",query:t,view_name:i.replace(/[^a-zA-Z0-9]/g,"_"),created_through:"editor",user_name:"",description:o,department:n};l="CreateView";s.callCreateService(l,JSON.stringify(r),"POST",function(t,s,i){if(s){sap.m.MessageToast.show("View Created Successfully");a.navTo("home");e.createViewDialog.close()}else if(JSON.parse(t).message==="View with this ID already exists"){sap.m.MessageToast.show("Query Name already exists.Please give a different Query Name")}else{sap.m.MessageToast.show("Unable to create view.Try again")}})}else{sap.m.MessageToast.show("Query Name cannot be empty")}},onCreateCancelPress:function(){this.createViewDialog.getContent()[0].getContent()[1].setValue("");this.createViewDialog.close()},onUpdateViewPress:function(){var e=this;var t=this.getView().byId("aCodeEditor").getValue();var a=t.split(" ");if(t.length===0){sap.m.MessageToast.show("Invalid Query")}else if(a[0]!=="select"&&a[0]!=="SELECT"){sap.m.MessageToast.show("Only select operation can be performed")}else{this.validateQuery(t,false,true,function(t){if(t){var a=sap.ui.getCore().getModel("queryInfo");var s=sap.ui.getCore().getModel("Departments");var i=new sap.ui.model.json.JSONModel;i.oData.tables=[];for(var o=0;o<s.oData.tables.length;o++){i.oData.tables.push(s.oData.tables[o])}var n=i.oData.tables.map(function(e){return e.Department_name});if(!n.includes("Add a New Department")){i.oData.tables.push({Department_name:"Add a New Department"})}e.editViewDialog.getContent()[0].getContent()[1].setValue(a.getData().view_name);e.editViewDialog.getContent()[0].getContent()[3].setValue(a.getData().description);e.editViewDialog.getContent()[0].getContent()[5].setModel(i);e.editViewDialog.getContent()[0].getContent()[5].setSelectedKey(a.getData().department);e.editViewDialog.open()}else{sap.m.MessageToast.show("Invalid Query")}})}},onUpdatePress:function(){var e=this;var t=this.getView().byId("aCodeEditor").getValue();var a=sap.ui.getCore().getModel("queryInfo");var i=this.editViewDialog.getContent()[0].getContent()[1].getValue();var o=sap.ui.core.UIComponent.getRouterFor(this);if(i.length>0){var n;var r;var l=this.editViewDialog.getContent()[0].getContent()[3].getValue();var g=this.editViewDialog.getContent()[0].getContent()[5].getSelectedKey();n={last_change:new Date,table_config:"",query:t,view_name:i.replace(/[^a-zA-Z0-9]/g,"_"),created_through:"editor",user_name:"",description:l,department:g,_id:a.getData()._id};r="UpdateView";s.callCreateService(r,JSON.stringify(n),"POST",function(t,a,s){if(a){sap.m.MessageToast.show("View Updated Successfully");o.navTo("home");e.editViewDialog.close()}else if(JSON.parse(t).message==="View with this ID already exists"){sap.m.MessageToast.show("Query Name already exists.Please give a different Query Name")}else{sap.m.MessageToast.show("Unable to update view.Try again")}})}else{sap.m.MessageToast.show("Query Name cannot be empty")}},onUpdateCancelPress:function(){this.editViewDialog.getContent()[0].getContent()[1].setValue("");this.editViewDialog.close()},onAddDeptPressOnCreate:function(){var e=this;var t=this.createViewDialog.getContent()[0].getContent()[5].getModel();var i=this.createViewDialog.getContent()[0].getContent()[6].getValue();var o=false;for(var n=0;n<t.oData.tables.length;n++){if(t.oData.tables[n].Department_name===i){var r="Department already exists";a.show(r);o=true}}if(o){this.createViewDialog.getContent()[0].getContent()[5].setSelectedKey(i);this.createViewDialog.getContent()[0].getContent()[6].setVisible(false);this.createViewDialog.getContent()[0].getContent()[7].setVisible(false)}else{var l={Department_name:i};s.callCreateService("AddDepartment",JSON.stringify(l),"POST",function(a,s,o){if(s){t.oData.tables.splice(t.oData.tables.length-1,1);var n={Department_name:i};var r={Department_name:"Add a New Department"};t.oData.tables.push(n);t.oData.tables.push(r);e.createViewDialog.getContent()[0].getContent()[5].getModel().updateBindings(true);e.createViewDialog.getContent()[0].getContent()[5].setSelectedKey(i);e.createViewDialog.getContent()[0].getContent()[6].setVisible(false);e.createViewDialog.getContent()[0].getContent()[7].setVisible(false)}else{sap.m.MessageToast.show("Unable to add Department.Try again")}})}},onAddDeptPressOnEdit:function(){var e=this;var t=this.editViewDialog.getContent()[0].getContent()[5].getModel();var i=this.editViewDialog.getContent()[0].getContent()[6].getValue();var o=false;for(var n=0;n<t.oData.tables.length;n++){if(t.oData.tables[n].Department_name===i){var r="Department already exists";a.show(r);o=true}}if(o){this.editViewDialog.getContent()[0].getContent()[5].setSelectedKey(i);this.editViewDialog.getContent()[0].getContent()[6].setVisible(false);this.editViewDialog.getContent()[0].getContent()[7].setVisible(false)}else{var l={Department_name:i};s.callCreateService("filters/add_department",JSON.stringify(l),"POST",function(a,s,o){if(s){t.oData.tables.splice(t.oData.tables.length-1,1);var n={Department_name:i};var r={Department_name:"Add a New Department"};t.oData.tables.push(n);t.oData.tables.push(r);e.editViewDialog.getContent()[0].getContent()[5].getModel().updateBindings(true);e.editViewDialog.getContent()[0].getContent()[5].setSelectedKey(i);e.editViewDialog.getContent()[0].getContent()[6].setVisible(false);e.editViewDialog.getContent()[0].getContent()[7].setVisible(false)}else{sap.m.MessageToast.show("Unable to add Department.Try again")}})}}})});