sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","inhance/userManagementSecurity/util/formatter"],function(e,t,o){"use strict";return e.extend("inhance.userManagementSecurity.controller.rolesDetail",{formatter:o,onInit:function(){var e=this;if(!this.valueHelpForRoles)this.valueHelpForRoles=new sap.ui.xmlfragment("inhance.userManagementSecurity.fragments.valueHelpForRoles",this);if(!this.valueHelpForNewUser)this.valueHelpForNewUser=new sap.ui.xmlfragment("inhance.userManagementSecurity.fragments.valueHelpForNewUser",this);this.getView().addDependent(this.valueHelpForRoles);this.getView().addDependent(this.valueHelpForNewUser);sap.ui.core.UIComponent.getRouterFor(this).getRoute("rolesDetail").attachPatternMatched(this.objMatched,this)},objMatched:function(e){this.roleId=e.getParameter("arguments").roleId;this.roleItemIndex=e.getParameter("arguments").path;var t=new sap.ui.model.Context(this.getOwnerComponent().getModel("rolesDetails"),"/"+e.getParameter("arguments").path);this.getView().setBindingContext(t,"rolesDetails");this.getView().byId("userIconTabFilter").setCount(t.getObject().user.length);this.getView().setModel(new sap.ui.model.json.JSONModel(t.getObject()),"roleDetail");this.getView().getModel("appView").setProperty("/sideMenuVisible",true);this.destination=this.getView().getModel("appView").getProperty("/destination");this.file={organisationid:this.getView().getModel("appView").getProperty("/loginDetails/0/organisationid")}},handleDetailBinding:function(){var e=this;var t=new sap.ui.model.Context(e.getOwnerComponent().getModel("rolesDetails"),"/"+e.roleItemIndex);e.getView().setBindingContext(t,"rolesDetails");e.getView().byId("userIconTabFilter").setCount(t.getObject().users.length)},handleSaveCancelButton:function(e){this.getView().byId("saveButtonId").setVisible(e);this.getView().byId("cancelButtonId").setVisible(e);this.getView().byId("editButtonId").setVisible(!e);this.getView().byId("deleteButtonId").setVisible(!e)},handleSaveUser:function(){var e=this;t.confirm("Are you Sure want to save your changes",function(o){if(o=="OK"){e.handleSaveCancelButton(false);t.information("Changes are saved Successfully")}})},handleCancelUser:function(){var e=this;t.confirm("Are you sure want to cancel your changes",{onClose:function(t){if(t=="OK"){e.handleSaveCancelButton(false)}}})},handleDeleteRolePress:function(){var e=this;this.getView().setBusy(true);t.confirm("Are yo sure want to delete the role?",function(o){if(o=="OK"){var s=e.getView().getBindingContext("rolesDetails").oModel.oData[e.roleItemIndex]._id;$.post(e.destination+"/UM/deleterole?param1="+s,function(o){if(o=="Invalid Session"){t.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else if(o=="role"){e.getView().setBusy(false);e.getOwnerComponent().getModel("rolesDetails").oData.splice(e.roleItemIndex,1);e.getOwnerComponent().getModel("rolesDetails").updateBindings(true);t.success("Role deleted successfully");e.getView().getModel("appView").setProperty("/layout","OneColumn")}else e.getView().setBusy(false)})}else{e.getView().setBusy(false)}})},handleEditRolePress:function(){var e={id:this.getView().getBindingContext("rolesDetails").getObject()._id,type:this.getView().getBindingContext("rolesDetails").getObject().type,description:this.getView().getBindingContext("rolesDetails").getObject().description,createdate:this.getView().getBindingContext("rolesDetails").getObject().createdate,modifydate:(new Date).toJSON(),countofcreatepage:this.getView().getBindingContext("rolesDetails").getObject().countofcreatepage,countofcreateuser:"",organisationid:this.getView().getBindingContext("rolesDetails").getObject().organisationid};this.valueHelpForRoles.setModel(new sap.ui.model.json.JSONModel(e));this.handleLicenseFields();this.valueHelpForRoles.setTitle("Edit Role");this.valueHelpForRoles.open()},handleLicenseFields:function(){var e=this.getView().getModel("appView");this.valueHelpForRoles.getContent()[1].getContent()[1].setSelectedKey(e.getData().loginDetails[0].license.license_type);this.valueHelpForRoles.getContent()[1].getContent()[3].setValue(e.getProperty("/loginDetails/0/license/startdate")+" - "+e.getProperty("/loginDetails/0/license/enddate"));var t=o.getNoOfDays(e.getProperty("/loginDetails/0/license/startdate"),e.getProperty("/loginDetails/0/license/enddate"));this.valueHelpForRoles.getContent()[1].getContent()[5].setValue(t)},handleRolesFragmentCancel:function(){this.valueHelpForRoles.close()},handleCreatePageCount:function(e){var t=this;if(parseInt(e.getSource().getValue())>parseInt(t.getView().getModel("appView").getData().loginDetails[0].license.dashboardcountallowed)){e.getSource().setValueState("Error").setValueStateText("Assigned Dashboard Creation count is "+this.getView().getModel("appView").oData.loginDetails[0].dashboardcountallowed)}else{e.getSource().setValueState("None").setValueStateText("")}},handleRolesFragmentSave:function(){var e=this;if(this.handleValidationsForRoles()&&e.valueHelpForRoles.getContent()[1].getContent()[7].getValueState()!="Error"){this.rolesObj=this.valueHelpForRoles.getModel().getData();var o=this.getView().getModel("roleDetail").getData().organisationid;var s=this.getView().getModel("roleDetail").getData()._id;$.post(e.destination+"/UM/editrole?param1="+o+"&param2="+s,this.rolesObj,function(o){if(o=="Invalid Session"){t.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else if(o=="okk"){t.success("Role Updated Successfully");e.getOwnerComponent().getModel("rolesDetails").setProperty(e.getView().getBindingContext("rolesDetails").sPath+"/type",e.rolesObj.type);e.getOwnerComponent().getModel("rolesDetails").setProperty(e.getView().getBindingContext("rolesDetails").sPath+"/description",e.rolesObj.description);e.getOwnerComponent().getModel("rolesDetails").setProperty(e.getView().getBindingContext("rolesDetails").sPath+"/countofcreatepage",e.rolesObj.countofcreatepage);e.getOwnerComponent().getModel("rolesDetails").setProperty(e.getView().getBindingContext("rolesDetails").sPath+"/modifydate",e.rolesObj.modifydate);e.getView().getModel("roleDetail").setProperty("/type",e.rolesObj.type);e.getView().getModel("roleDetail").setProperty("/description",e.rolesObj.description);e.getView().getModel("roleDetail").setProperty("/countofcreatepage",e.rolesObj.countofcreatepage);e.getView().getModel("roleDetail").updateBindings(true)}else{t.error(o)}});this.valueHelpForRoles.close()}else{sap.m.MessageBox.error("Please fill the mandatory fields!")}},handleValidationsForRoles:function(){var e=true;if(this.valueHelpForRoles.getContent()[0].getContent()[1].getValue().length==0||this.valueHelpForRoles.getContent()[0].getContent()[3].getValue().length==0||this.valueHelpForRoles.getContent()[1].getContent()[7].getValue().length==0){e=false}return e},handleDateRange:function(e){var t=e.getSource().getDateValue();var o=e.getSource().getSecondDateValue();var s=Math.abs(o.getTime()-t.getTime());var n=Math.ceil(s/(1e3*60*60*24));this.valueHelpForRoles.getContent()[1].getContent()[5].setValue(n)},handleAddUsersPress:function(){this.valueHelpForNewUser.getContent()[2].setVisible(true);this.valueHelpForNewUser.getContent()[2].getContent()[1].setValue(null);this.valueHelpForNewUser.getContent()[2].getContent()[3].setValue(null);this.valueHelpForNewUser.getContent()[2].getContent()[5].setValue(null);this.valueHelpForNewUser.getContent()[2].getContent()[7].setValue(null);this.valueHelpForNewUser.getContent()[1].setVisible(false);this.valueHelpForNewUser.getContent()[2].getContent()[9].setSelectedKey(this.roleId);this.valueHelpForNewUser.getContent()[0].setVisible(true);this.valueHelpForNewUser.getContent()[0].setSelectedKey("Create User");this.valueHelpForNewUser.setTitle("Create User");this.valueHelpForNewUser.open()},handleRolesModel:function(){var e=this;var o=this.getView().getModel("appView").oData.loginDetails[0].organisationid;$.get(this.destination+"/UM/getroles?param1="+o,function(o){if(o=="Invalid Session"){t.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else{try{o=JSON.parse(o)}catch(e){}var s=new sap.ui.model.json.JSONModel(o);e.getOwnerComponent().setModel(s,"rolesDetails")}})},onUpload:function(e){var t=this;var o=e.getParameter("files")[0];var s=new FileReader;s.onload=function(){t.file.data=s.result;console.log(s.result)};s.onerror=function(e){console.log("Error: ",e)};s.readAsDataURL(o)},uploadUsers:function(){if(this.file.data){var e=this;$.post(this.destination+"/UM/UploadUsers",this.file,function(o){if(o=="Invalid Session"){t.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else if(JSON.parse(o).status=="Success"){t.success("User Created Successfully");e.handleUserModel(true);e.getView().getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");e.valueHelpForNewUser.close()}else t.error("Following Error occured while uploading users: "+JSON.parse(o).message)})}else t.error("Please select a file to upload")},handleAddUserOkPress:function(){if(this.valueHelpForNewUser.getContent()[0].getSelectedKey()=="Upload Users")this.uploadUsers();else{var e=this;if(this.valueHelpForNewUser.getContent()[2].getContent()[1].getValue().length==0||this.valueHelpForNewUser.getContent()[2].getContent()[5].getValue().length==0){t.error("Please fill the mandatory fileds")}else{this.userObj={firstname:this.valueHelpForNewUser.getContent()[2].getContent()[1].getValue(),lastname:this.valueHelpForNewUser.getContent()[2].getContent()[3].getValue(),password:"Vaspp@123",organisationid:this.getView().getModel("appView").getProperty("/loginDetails/0/organisationid"),roleid:this.valueHelpForNewUser.getContent()[2].getContent()[9].getSelectedItem().getBindingContext("rolesDetails").getObject()._id,typevalue:this.valueHelpForNewUser.getContent()[2].getContent()[9].getSelectedItem().getBindingContext("rolesDetails").getObject().type,user_emailid:this.valueHelpForNewUser.getContent()[2].getContent()[5].getValue(),contactnumber:this.valueHelpForNewUser.getContent()[2].getContent()[7].getValue(),verified:"verified",createdate:(new Date).toJSON(),modifydate:(new Date).toJSON()};var o=this.getView().getModel("appView").getProperty("/loginDetails/0/organisationid");var s=this.valueHelpForNewUser.getContent()[2].getContent()[9].getSelectedItem().getBindingContext("rolesDetails").getObject()._id;$.post(e.destination+"/UM/createuser?param1="+s+"&param2="+o,this.userObj,function(o){if(o=="Invalid Session"){t.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else if(o=="ok"){t.success("User Created Successfully");e.handleUserModel()}else{t.error(o)}});this.valueHelpForNewUser.close()}}},handleUserModel:function(){var e=this;var o=this.getView().getModel("appView").oData.loginDetails[0].organisationid;$.get(e.destination+"/UM/getrole?param1="+o,function(o){if(o=="Invalid Session"){t.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else{try{o=JSON.parse(o)}catch(e){}var s=new sap.ui.model.json.JSONModel(o);e.getOwnerComponent().setModel(s,"rolesDetails");e.getOwnerComponent().getModel("rolesDetails").updateBindings(true);var n=new sap.ui.model.Context(e.getOwnerComponent().getModel("rolesDetails"),"/"+e.roleItemIndex);e.getView().setBindingContext(n,"rolesDetails");e.getView().byId("userIconTabFilter").setCount(n.getObject().user.length);e.getView().setModel(new sap.ui.model.json.JSONModel(n.getObject()),"roleDetail")}})},handleAddUserCancelPress:function(){this.valueHelpForNewUser.close()},handleChangeUsersCreate:function(e){if(e.getParameter("item").getText()=="Create User"){this.valueHelpForNewUser.getContent()[2].setVisible(true);this.valueHelpForNewUser.getContent()[1].setVisible(false)}else{this.valueHelpForNewUser.getContent()[2].setVisible(false);this.valueHelpForNewUser.getContent()[1].setVisible(true)}},handleInvalidSession:function(){var e=this;e.getView().getModel("appView").setProperty("/layout","OneColumn");var t=sap.ui.core.UIComponent.getRouterFor(e);t.navTo("login");function o(){window.history.forward()}setTimeout("preventBack()",0);window.onunload=function(){null};window.localStorage.removeItem("loginDetails")},onCloseDetailPress:function(){var e=this.getView().getModel("appView").getProperty("/actionButtonsInfo/midColumn/closeColumn");this.getView().getModel("appView").setProperty("/actionButtonsInfo/midColumn/closeColumn",!e);this.getView().getModel("appView").setProperty("/layout","OneColumn");var t=sap.ui.core.UIComponent.getRouterFor(this);t.navTo("rolesMaster")}})});