sap.ui.define(["sap/ui/core/mvc/Controller","inhance/userManagementSecurity/util/formatter","sap/m/MessageBox"],function(e,t,s){"use strict";return e.extend("inhance.userManagementSecurity.controller.usersMaster",{formatter:t,onInit:function(){if(!this.valueHelpForNewUser)this.valueHelpForNewUser=new sap.ui.xmlfragment("inhance.userManagementSecurity.fragments.valueHelpForNewUser",this);this.getView().addDependent(this.valueHelpForNewUser);sap.ui.core.UIComponent.getRouterFor(this).getRoute("usersMaster").attachPatternMatched(this._objPatternMatched,this)},_objPatternMatched:function(){this.getView().getModel("appView").getProperty("/sideContent").getItem().getItems()[1].getItems()[0]._selectItem(true);this.getView().getModel("appView").setProperty("/sideMenuVisible",true);this.destination=this.getView().getModel("appView").getProperty("/destination");this.file={organisationid:this.getView().getModel("appView").getProperty("/loginDetails/0/organisationid")};this.handlePageModel();this.handleUserModel();this.handleRolesModel()},handlePageModel:function(){var e=this;$.get(this.destination+"/odata/mongodb/OVPPageConfig",function(t){if(t=="Invalid Session"){s.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else{try{t=JSON.parse(t)}catch(e){}var n=new sap.ui.model.json.JSONModel(t);e.getOwnerComponent().setModel(n,"pages")}})},onAfterRendering:function(){this.handleUserModel();this.handleRolesModel()},handleUserModel:function(e){var t=this;var n=this.getView().getModel("appView").getProperty("/loginDetails/0/organisationid");$.get(this.destination+"/UM/getusers?param1="+n,function(n){if(n=="Invalid Session"){s.information("Your session has expired. Please log in again.",{onClose:function(e){if(e=="OK"){t.handleInvalidSession()}}})}else{try{n=JSON.parse(n)}catch(e){}var i=new sap.ui.model.json.JSONModel(n);t.getOwnerComponent().setModel(i,"usersList");if(e){var o=t.getView().byId("itemlistId").getItems();o[o.length-1].setSelected(true);t.getRouter().navTo("usersDetail",{userId:o[o.length-1].getBindingContext("usersList").getObject()._id,path:o[o.length-1].getBindingContext("usersList").getPath().split("/")[1]})}}})},handleRolesModel:function(){var e=this;var t=this.getView().getModel("appView").oData.loginDetails[0].organisationid;$.get(this.destination+"/UM/getroles?param1="+t,function(t){if(t=="Invalid Session"){s.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else{try{t=JSON.parse(t)}catch(e){}var n=new sap.ui.model.json.JSONModel(t);e.getOwnerComponent().setModel(n,"rolesDetails")}})},handleUsersListPress:function(e){this.getView().getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("usersDetail",{userId:e.getParameter("listItem").getBindingContext("usersList").getObject()._id,path:e.getParameter("listItem").getBindingContext("usersList").getPath().split("/")[1]})},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},onNavBack:function(){this.getView().getModel("appView").setProperty("/layout","OneColumn");this.getRouter().navTo("Home")},handleAddNewCutsomer:function(){this.valueHelpForNewUser.getContent()[2].setVisible(true);this.valueHelpForNewUser.getContent()[2].getContent()[1].setValue(null);this.valueHelpForNewUser.getContent()[2].getContent()[3].setValue(null);this.valueHelpForNewUser.getContent()[2].getContent()[5].setValue(null);this.valueHelpForNewUser.getContent()[2].getContent()[7].setValue(null);this.valueHelpForNewUser.getContent()[2].getContent()[9].setSelectedKey("");this.valueHelpForNewUser.getContent()[1].setVisible(false);this.valueHelpForNewUser.getContent()[2].setTitle("Create User");this.valueHelpForNewUser.getContent()[0].setVisible(true);this.valueHelpForNewUser.getContent()[0].setSelectedKey("Create User");this.valueHelpForNewUser.setTitle("Create User");this.valueHelpForNewUser.open()},onUpload:function(e){var t=this;var s=e.getParameter("files")[0];var n=new FileReader;n.onload=function(){t.file.data=n.result;console.log(n.result)};n.onerror=function(e){console.log("Error: ",e)};n.readAsDataURL(s)},uploadUsers:function(){if(this.file.data){var e=this;$.post(this.destination+"/UM/UploadUsers",this.file,function(t){if(t=="Invalid Session"){s.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else if(JSON.parse(t).status=="Success"){s.success("User Created Successfully");e.handleUserModel(true);e.getView().getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");e.valueHelpForNewUser.close()}else s.error("Following Error occured while uploading users: "+JSON.parse(t).message)})}else s.error("Please select a file to upload")},handleAddUserOkPress:function(){if(this.valueHelpForNewUser.getContent()[0].getSelectedKey()=="Upload Users")this.uploadUsers();else{var e=this;if(this.valueHelpForNewUser.getContent()[2].getContent()[1].getValue().length==0||this.valueHelpForNewUser.getContent()[2].getContent()[5].getValue().length==0){s.error("Please fill the mandatory fileds")}else{this.userObj={firstname:this.valueHelpForNewUser.getContent()[2].getContent()[1].getValue(),lastname:this.valueHelpForNewUser.getContent()[2].getContent()[3].getValue(),password:"Vaspp@123",organisationid:this.getView().getModel("appView").getProperty("/loginDetails/0/organisationid"),roleid:this.valueHelpForNewUser.getContent()[2].getContent()[9].getSelectedItem().getBindingContext("rolesDetails").getObject()._id,typevalue:this.valueHelpForNewUser.getContent()[2].getContent()[9].getSelectedItem().getBindingContext("rolesDetails").getObject().type,user_emailid:this.valueHelpForNewUser.getContent()[2].getContent()[5].getValue(),contactnumber:this.valueHelpForNewUser.getContent()[2].getContent()[7].getValue(),verified:"verified",createdate:(new Date).toJSON(),modifydate:(new Date).toJSON()};var t=this.getView().getModel("appView").getProperty("/loginDetails/0/organisationid");var n=this.valueHelpForNewUser.getContent()[2].getContent()[9].getSelectedItem().getBindingContext("rolesDetails").getObject()._id;$.post(this.destination+"/UM/createuser?param1="+n+"&param2="+t,this.userObj,function(t){if(t=="Invalid Session"){s.information("Your session has expired. Please log in again.",{onClose:function(t){if(t=="OK"){e.handleInvalidSession()}}})}else if(t=="ok"){s.success("User Created Successfully");e.handleUserModel(true);e.getView().getModel("appView").setProperty("/layout","TwoColumnsMidExpanded")}else{s.error(t)}});this.valueHelpForNewUser.close()}}},handleInvalidSession:function(){var e=this;e.getView().getModel("appView").setProperty("/layout","OneColumn");var t=sap.ui.core.UIComponent.getRouterFor(e);t.navTo("login");function s(){window.history.forward()}setTimeout("preventBack()",0);window.onunload=function(){null};window.localStorage.removeItem("loginDetails")},handleAddUserCancelPress:function(){this.valueHelpForNewUser.close()},handleChangeUsersCreate:function(e){if(e.getParameter("item").getText()=="Create User"){this.valueHelpForNewUser.getContent()[2].setVisible(true);this.valueHelpForNewUser.getContent()[1].setVisible(false)}else{this.valueHelpForNewUser.getContent()[2].setVisible(false);this.valueHelpForNewUser.getContent()[1].setVisible(true)}},onSearch:function(e){var t=new sap.ui.model.Filter("firstname","Contains",e.getParameter("newValue"));var s=new sap.ui.model.Filter("lastname","Contains",e.getParameter("newValue"));this.getView().byId("itemlistId").getBinding("items").filter(new sap.ui.model.Filter([t,s],false))},limitPhoneNumbers:function(e){var t=this;var s=e.getParameter("value");var n="";if(s.length<=12){for(var i=0;i<s.length;i++){n=n+s[i];e.getSource().setValue(n);var o=e.getSource();var a=o.getValue();a=a.replace(/[^\d]/g,"");o.setValue(a)}this.numVal=n}else{sap.m.MessageToast.show("Please Enter 12 Digits only");t.valueHelpForNewUser.getContent()[2].getContent()[7].setValue(t.numVal)}}})});